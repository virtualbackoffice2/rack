<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Complain Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="../stylesoff.css">
  <style>
    :root{--accent:#2b8cff;--danger:#e74c3c;--bg:#f7f8fb;--surface:#ffffff;--muted:#7f8c8d;--card-shadow:0 6px 18px rgba(23,31,46,0.06);}
    html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,"Roboto","Helvetica","Arial",sans-serif;background:var(--bg);color:#222;}
    header.app-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:linear-gradient(180deg,var(--surface),#fbfdff);
      box-shadow:var(--card-shadow);position:sticky;top:0;z-index:1000;}
    .brand{display:flex;align-items:center;gap:12px;}
    .brand h1{margin:0;font-size:1.05rem;font-weight:600;}
    .hamburger{display:flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:8px;border:none;background:transparent;font-size:20px;cursor:pointer;}
    .top-controls{display:flex;gap:10px;flex-wrap:wrap;}
    .top-controls button{background:var(--surface);border:1px solid #e6e9ee;padding:8px 12px;border-radius:8px;font-size:0.95rem;cursor:pointer;}
    .top-controls .primary{background:var(--accent);color:#fff;}
    .drawer{position:fixed;inset:0;pointer-events:none;z-index:1400;}
    .drawer-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.32);opacity:0;transition:opacity .25s;pointer-events:none;}
    .drawer-panel{position:absolute;left:0;top:0;height:100%;width:320px;max-width:calc(100%-40px);background:var(--surface);
      box-shadow:0 20px 40px rgba(10,20,50,0.12);transform:translateX(-110%);transition:transform .36s cubic-bezier(.2,.9,.2,1);padding:16px;overflow:auto;}
    .drawer.open .drawer-backdrop{opacity:1;pointer-events:auto;}
    .drawer.open .drawer-panel{transform:translateX(0);}
    .filters,.controls{display:flex;flex-direction:column;gap:10px;margin-bottom:10px;}
    .filters select,.filters input{padding:10px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;font-size:0.95rem;}
    .filters-inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0;}
    .filters-inline select,.filters-inline input{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;font-size:0.95rem;}
    .user-count{font-size:0.95rem;color:var(--muted);padding-left:6px;}
    #tableWrap{margin:12px;background:transparent;border-radius:8px;overflow:auto;}
    table#dataTable{width:100%;border-collapse:collapse;min-width:980px;background:var(--surface);box-shadow:var(--card-shadow);border-radius:8px;overflow:hidden;}
    thead th{text-align:left;padding:12px 14px;background:linear-gradient(180deg,#fff,#fbfdff);border-bottom:1px solid #eef2f6;
      position:sticky;top:0;z-index:2;font-size:0.9rem;color:#000 !important;font-weight:600;}
    tbody td{padding:10px 14px;border-bottom:1px solid #f1f4f8;font-size:0.95rem;vertical-align:middle;}
    tbody tr.offline td{background:#fffdf6;}
    tbody tr.ticket td{background:#ffcccc !important;}
    .mark-btn,.remove-btn{display:inline-block;width:36px;height:36px;border-radius:6px;border:none;margin-right:6px;background:#f1f5f9;cursor:pointer;}
    .mark-btn:before{content:"";display:inline-block;width:100%;height:100%;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000 HWND" viewBox="0 0 24 24"><path fill="%23000000" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></svg>') center/16px no-repeat;opacity:0.85;}
    .remove-btn:before{content:"";display:inline-block;width:100%;height:100%;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23ff4d4d" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>') center/16px no-repeat;opacity:0.95;}
    #spinnerOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200;background:rgba(255,255,255,0.6);backdrop-filter:blur(2px);flex-direction:column;gap:14px;}
    #spinnerOverlay .spinner{width:48px;height:48px;border:5px solid rgba(0,0,0,0.08);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    #toast{visibility:hidden;min-width:220px;background:#333;color:#fff;text-align:center;border-radius:8px;padding:12px 14px;position:fixed;z-index:1300;left:50%;bottom:22px;
      transform:translateX(-50%) translateY(8px);box-shadow:0 8px 20px rgba(0,0,0,0.12);transition:opacity .25s,transform .25s;opacity:0;}
    #toast.show{visibility:visible;opacity:1;transform:translateX(-50%) translateY(0);}
    @media (max-width:880px){.top-controls,.filters-inline{display:none;}}
    @media (min-width:881px){.hamburger,.drawer{display:none;}.filters-inline{display:flex;}#tableWrap{margin:18px 20px;}}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <button class="hamburger" id="btnHamburger">Menu</button>
      <h1>Complain Manager</h1>
    </div>
    <div class="top-controls">
      <button id="btnComplains" class="primary">Complains</button>
      <button id="btnOffline">Offline</button>
      <button id="btnDrops">Drops</button>
      <button id="btnDownloadCsv">CSV</button>
      <button id="btnScreenshotDownload">Screenshot</button>
    </div>
  </header>

  <div class="drawer" id="appDrawer" aria-hidden="true">
    <div class="drawer-backdrop" id="drawerBackdrop"></div>
    <aside class="drawer-panel">
      <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
        <strong>Menu</strong>
        <button id="btnCloseDrawer" style="background:none;border:none;font-size:20px;cursor:pointer;">X</button>
      </div>
      <div class="controls">
        <button id="m_btnComplains">Complains</button>
        <button id="m_btnOffline">Offline</button>
        <button id="m_btnDrops">Drops</button>
        <button id="m_btnDownloadCsv">CSV</button>
        <button id="m_btnScreenshot">Screenshot</button>
      </div>
      <hr style="margin:12px 0;border-top:1px solid #eef2f6">
      <div class="filters">
        <label>Window</label><select id="selWindow_mobile"></select>
        <label>PON</label><select id="selPon_mobile"></select>
        <label>User ID</label><input id="searchUser_mobile" placeholder="Enter User ID">
        <label>Mobile No</label><input id="searchMobile_mobile" placeholder="Enter Mobile No">
        <label>Name</label><input id="searchName_mobile" placeholder="Enter Name">
        <label>Mac/Serial</label><input id="searchMac_mobile" placeholder="Enter Mac/Serial">
        <div class="user-count">User count: <span id="userCount">0</span></div>
      </div>
    </aside>
  </div>

  <div style="padding:12px 20px;">
    <div class="filters-inline">
      <select id="selWindow"></select>
      <select id="selPon"></select>
      <input id="searchUser" placeholder="Enter User ID">
      <input id="searchMobile" placeholder="Enter Mobile No">
      <input id="searchName" placeholder="Enter Name">
      <input id="searchMac" placeholder="Enter Mac/Serial">
      <div class="user-count">User count: <span id="userCount_desktop">0</span></div>
    </div>
  </div>

  <div id="tableWrap">
    <table id="dataTable">
      <thead>
        <tr>
          <th class="sortable" data-key="NMID">PON No</th>
          <th class="sortable" data-key="Users">User ID</th>
          <th>Mobile No</th>
          <th>Name</th>
          <th>Mac / Serial</th>
          <th class="sortable" data-key="Drops">Down Time</th>
          <th>Remark</th>
          <th>Actions</th>
          <th>Location</th>
          <th>Procare</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="spinnerOverlay"><div class="spinner"></div><p>Loading...</p></div>
  <div id="toast" role="status"></div>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    const GAS_URLS = {
      sheet1: {url:"https://script.google.com/macros/s/AKfycbzliBfK4lJmojz4wSUZVcJBg1UDu47WlLvHA5GSAFk84EPd1w4cT62Dw5PqpsuemybXww/exec", sheetId:"1oN4d2HCKLcTgogItpVgWUmDTxY28RDhtrVKEMt0PmzA"},
      sheet2: {url:"https://script.google.com/macros/s/AKfycbzP06rGtmvCWN4sMqtrluFcLeSM29vjmJ0fRO0r8rEc5mqRRuyUGTuvIK2qN1gZEvLoTg/exec", sheetId:"1d7tlBDp3snfzjeOxhZ8W0YHX-duuiwLVKDPflGsiA2Q"}
    };
    const TOKEN = "abcd1234";
    let rawRows = [], baseFiltered = [], filtered = [], currentSort = {key:null,asc:true}, currentMode = 'offline';
    const tbody = document.querySelector('#dataTable tbody');
    const selWindow = document.getElementById('selWindow'), selPon = document.getElementById('selPon');
    const selWindow_mobile = document.getElementById('selWindow_mobile'), selPon_mobile = document.getElementById('selPon_mobile');

    function showSpinner(){document.getElementById('spinnerOverlay').style.display='flex';}
    function hideSpinner(){document.getElementById('spinnerOverlay').style.display='none';}
    function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

    // Proper working JSONP (yeh pehle se chal raha tha aur ab bhi chalega)
    function jsonpGet(url){
      return new Promise((res,rej)=>{
        const cb = '__cb'+Date.now();
        window[cb] = data => { delete window[cb]; document.head.removeChild(script); res(data); };
        const script = document.createElement('script');
        script.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
        script.onerror = () => rej(new Error('Load failed'));
        document.head.appendChild(script);
      });
    }

    async function fetchData(){
      showSpinner();
      try{
        const res = await Promise.all(Object.keys(GAS_URLS).map(k => 
          jsonpGet(`${GAS_URLS[k].url}?token=${TOKEN}`).then(d=>({key:k, rows:d.rows||[]}))
        ));
        rawRows = res.flatMap(r => r.rows.map(row=>({...row, source:r.key})));
        updateBaseFiltered();
      }catch(e){
        showToast('Load failed');
      }finally{hideSpinner();}
    }

    function updateBaseFiltered(){
      switch(currentMode){
        case 'offline': baseFiltered = rawRows.filter(r=>(r.Downs||r.T||'').toString().trim()!==''); break;
        case 'complains': baseFiltered = rawRows.filter(r=>(r.Ticket||r.X||'').toString().trim()!==''); break;
        case 'drops': baseFiltered = rawRows.filter(r=>(r.Drops||r.AB||'').toString().trim()!==''); break;
        default: baseFiltered = rawRows;
      }
      populateWindowPon(); applyAllFilters();
    }

    function populateWindowPon(){
      const wins = new Set(), ponMap = {};
      baseFiltered.forEach(r=>{ const w=r.Window||r.window||r.A||''; wins.add(w);
        if(!ponMap[w]) ponMap[w] = new Set();
        ponMap[w].add(r.NMID||r.C||'');
      });
      const opt = Array.from(wins).filter(Boolean).sort().map(w=>`<option value="${w}">${w}</option>`).join('');
      selWindow.innerHTML = selWindow_mobile.innerHTML = '<option value="">All Window</option>' + opt;
      selWindow._ponMap = selWindow_mobile._ponMap = ponMap;
      fillPonOptions('');
    }

    function fillPonOptions(win){
      const map = selWindow._ponMap || {};
      const set = win ? map[win]||new Set() : new Set(Object.values(map).flatMap(s=>[...s]));
      const opts = Array.from(set).sort().map(p=>`<option value="${p}">${p}</option>`).join('');
      selPon.innerHTML = selPon_mobile.innerHTML = '<option value="">All PON</option>' + opts;
    }

    function applyAllFilters(){
      let data = rawRows.slice();

      const win = selWindow.value || selWindow_mobile.value || '';
      const pon = selPon.value || selPon_mobile.value || '';
      const user = (document.getElementById('searchUser').value || document.getElementById('searchUser_mobile').value || '').trim().toLowerCase();
      const mobile = (document.getElementById('searchMobile').value || document.getElementById('searchMobile_mobile').value || '').trim().toLowerCase();
      const name = (document.getElementById('searchName').value || document.getElementById('searchName_mobile').value || '').trim().toLowerCase();
      const mac = (document.getElementById('searchMac').value || document.getElementById('searchMac_mobile').value || '').trim().toLowerCase();

      if(user||mobile||name||mac){
        data = data.filter(r=>{
          if(user && !((r.Users||r.N||'').toString().toLowerCase().includes(user))) return false;
          if(mobile && !((r['Last called no']||r.AC||'')+(r.Number||r.P||'')).toLowerCase().includes(mobile)) return false;
          if(name && !((r.Name||r.O||'').toString().toLowerCase().includes(name))) return false;
          if(mac && !((r.MAC||r.U||'')+(r.Serial||r.V||'')).toLowerCase().includes(mac)) return false;
          return true;
        });
      }
      if(win) data = data.filter(r=>(r.Window||r.window||r.A||'').toString()===win);
      if(pon) data = data.filter(r=>(r.NMID||r.C||'').toString()===pon);

      if(currentMode==='offline') data = data.filter(r=>(r.Downs||r.T||'').toString().trim()!=='');
      if(currentMode==='complains') data = data.filter(r=>(r.Ticket||r.X||'').toString().trim()!=='');
      if(currentMode==='drops') data = data.filter(r=>(r.Drops||r.AB||'').toString().trim()!=='');

      filtered = data;
      renderTable();
    }

    function renderTable(){
      // ... same as your original renderTable (no change needed)
      const rows = filtered.slice();
      if(currentSort.key){
        rows.sort((a,b)=>{
          const ka = (a[currentSort.key] || a[keyOrAlt(a,currentSort.key)] || '').toString().toLowerCase();
          const kb = (b[currentSort.key] || b[keyOrAlt(b,currentSort.key)] || '').toString().toLowerCase();
          return (ka<kb?-1:ka>kb?1:0)*(currentSort.asc?1:-1);
        });
      }
      document.getElementById('userCount').textContent = document.getElementById('userCount_desktop').textContent = rows.length;
      tbody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        if((r.Downs||r.T||'').toString().trim()) tr.classList.add('offline');
        if((r.Ticket||r.X||'').toString().trim()) tr.classList.add('ticket');
        const uid=r.Users||r.N||'', pon=r.NMID||r.C||'', mobile=(r['Last called no']||r.AC||'')||(r.Number||r.P||'')||'',
              name=r.Name||r.O||'', mac=r.MAC||r.U||'', serial=r.Serial||r.V||'', drops=r.Drops||r.AB||'',
              remark=r.Remarks||r.Y||r.remark||r.Remark||'', location=r.Location||r.Q||'', procare=r['User status']||r.AF||'';
        tr.innerHTML = `<td>${pon}</td><td>${uid}</td><td>${mobile}</td><td>${name}</td>
          <td>${mac}<br><small>${serial}</small></td><td>${drops?formatTimestamp(drops):''}</td>
          <td><input class="remark-input" data-uid="${uid}" data-source="${r.source}" value="${remark}"></td>
          <td><button class="mark-btn" data-uid="${uid}" data-source="${r.source}"></button>
              <button class="remove-btn" data-uid="${uid}" data-source="${r.source}"></button></td>
          <td>${location}</td><td>${procare}</td>`;
        tbody.appendChild(tr);
      });
    }

    function keyOrAlt(o,k){const m={'NMID':'C','Users':'N','Drops':'AB'};return m[k]||k;}
    function formatTimestamp(t){ /* your existing function */ return t; }

    document.addEventListener('DOMContentLoaded', ()=>{
      fetchData();

      document.getElementById('btnHamburger').onclick = () => document.getElementById('appDrawer').classList.add('open');
      document.getElementById('btnCloseDrawer').onclick = document.getElementById('drawerBackdrop').onclick = () => document.getElementById('appDrawer').classList.remove('open');

      ['searchUser','searchMobile','searchName','searchMac'].forEach(id=>{
        document.getElementById(id).oninput = document.getElementById(id+'_mobile').oninput = ()=>applyAllFilters();
      });

      selWindow.onchange = ()=>{ selWindow_mobile.value = selWindow.value; fillPonOptions(selWindow.value); applyAllFilters(); };
      selPon.onchange = applyAllFilters;
      selWindow_mobile.onchange = ()=>{ selWindow.value = selWindow_mobile.value; fillPonOptions(selWindow.value); applyAllFilters(); };
      selPon_mobile.onchange = ()=>{ selPon.value = selPon_mobile.value; applyAllFilters(); };

      document.addEventListener('click', e=>{
        if(e.target.closest('#btnComplains,#m_btnComplains')){currentMode='complains';updateBaseFiltered();}
        if(e.target.closest('#btnOffline,#m_btnOffline')){currentMode='offline';updateBaseFiltered();}
        if(e.target.closest('#btnDrops,#m_btnDrops')){currentMode='drops';updateBaseFiltered();}
      });
    });
  </script>
</body>
</html>
