<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Complain Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="../stylesoff.css">
  <style>
    :root{--accent:#2b8cff;--danger:#e74c3c;--bg:#f7f8fb;--surface:#ffffff;--muted:#7f8c8d;--card-shadow:0 6px 18px rgba(23,31,46,0.06);}
    html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,"Roboto","Helvetica","Arial",sans-serif;background:var(--bg);color:#222;}
    header.app-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:linear-gradient(180deg,var(--surface),#fbfdff);
      box-shadow:var(--card-shadow);position:sticky;top:0;z-index:1000;}
    .brand{display:flex;align-items:center;gap:12px;}
    .brand h1{margin:0;font-size:1.05rem;font-weight:600;}
    .hamburger{display:flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:8px;border:none;background:transparent;font-size:20px;cursor:pointer;}
    .top-controls{display:flex;gap:10px;flex-wrap:wrap;}
    .top-controls button{background:var(--surface);border:1px solid #e6e9ee;padding:8px 12px;border-radius:8px;font-size:0.95rem;cursor:pointer;}
    .top-controls .primary{background:var(--accent);color:#fff;}
    .drawer{position:fixed;inset:0;pointer-events:none;z-index:1400;}
    .drawer-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.32);opacity:0;transition:opacity .25s;}
    .drawer-panel{position:absolute;left:0;top:0;height:100%;width:320px;max-width:calc(100%-40px);background:var(--surface);
      box-shadow:0 20px 40px rgba(10,20,50,0.12);transform:translateX(-110%);transition:transform .36s cubic-bezier(.2,.9,.2,1);padding:16px;overflow:auto;}
    .drawer.open .drawer-backdrop{opacity:1;pointer-events:auto;}
    .drawer.open .drawer-panel{transform:translateX(0);}
    .filters,.controls{display:flex;flex-direction:column;gap:10px;margin-bottom:10px;}
    .filters select,.filters input{padding:10px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;font-size:0.95rem;}
    .filters-inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0;}
    .filters-inline select,.filters-inline input{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;font-size:0.95rem;}
    .user-count{font-size:0.95rem;color:var(--muted);padding-left:6px;}
    #tableWrap{margin:12px;background:transparent;border-radius:8px;overflow:auto;-webkit-overflow-scrolling:touch;}
    table#dataTable{width:100%;border-collapse:collapse;min-width:980px;background:var(--surface);box-shadow:var(--card-shadow);border-radius:8px;overflow:hidden;}
    thead th{text-align:left;padding:12px 14px;background:linear-gradient(180deg,#fff,#fbfdff);border-bottom:1px solid #eef2f6;
      position:sticky;top:0;z-index:2;font-size:0.9rem;color:#000 !important;font-weight:600;} /* Black header text */
    tbody td{padding:10px 14px;border-bottom:1px solid #f1f4f8;font-size:0.95rem;vertical-align:middle;}
    tbody tr.offline td{background:#fffdf6;}
    tbody tr.ticket td{background:#ffebee !important;} /* Red background for complaints */
    .mark-btn,.remove-btn{display:inline-block;width:36px;height:36px;border-radius:6px;border:none;margin-right:6px;background:#f1f5f9;cursor:pointer;}
    .mark-btn:before{content:"";display:inline-block;width:100%;height:100%;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23000000" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></svg>') center/16px no-repeat;opacity:0.85;}
    .remove-btn:before{content:"";display:inline-block;width:100%;height:100%;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23ff4d4d" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>') center/16px no-repeat;opacity:0.95;}
    #spinnerOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200;background:rgba(255,255,255,0.6);backdrop-filter:blur(2px);flex-direction:column;gap:14px;}
    #spinnerOverlay .spinner{width:48px;height:48px;border:5px solid rgba(0,0,0,0.08);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    #toast{visibility:hidden;min-width:220px;background:#333;color:#fff;text-align:center;border-radius:8px;padding:12px 14px;position:fixed;z-index:1300;left:50%;bottom:22px;
      transform:translateX(-50%) translateY(8px);box-shadow:0 8px 20px rgba(0,0,0,0.12);transition:opacity .25s,transform .25s cubic-bezier(.2,.9,.2,1);opacity:0;}
    #toast.show{visibility:visible;opacity:1;transform:translateX(-50%) translateY(0);}
    @media (max-width:880px){
      .top-controls,.filters-inline{display:none;}
      header.app-header{padding:10px;}
      .brand h1{font-size:1rem;}
      table#dataTable{min-width:820px;}
      .mark-btn,.remove-btn{width:42px;height:42px;}
    }
    @media (min-width:881px){
      .hamburger,.drawer,.filters{display:none;}
      .filters-inline{display:flex;}
      header.app-header{padding:14px 20px;}
      #tableWrap{margin:18px 20px;}
    }
    button:focus,input:focus,select:focus{outline:3px solid rgba(43,140,255,0.18);outline-offset:2px;}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <button class="hamburger" id="btnHamburger">Menu</button>
      <h1>Complain Manager</h1>
    </div>
    <div class="top-controls">
      <button id="btnComplains" class="primary">Complains</button>
      <button id="btnOffline">Offline</button>
      <button id="btnDrops">Drops</button>
      <button id="btnDownloadCsv">CSV</button>
      <button id="btnScreenshotDownload">Screenshot</button>
    </div>
  </header>

  <div class="drawer" id="appDrawer" aria-hidden="true">
    <div class="drawer-backdrop" id="drawerBackdrop"></div>
    <aside class="drawer-panel">
      <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
        <strong>Menu</strong>
        <button id="btnCloseDrawer">X</button>
      </div>
      <div class="controls">
        <button id="m_btnComplains">Complains</button>
        <button id="m_btnOffline">Offline</button>
        <button id="m_btnDrops">Drops</button>
        <button id="m_btnDownloadCsv">CSV</button>
        <button id="m_btnScreenshot">Screenshot</button>
      </div>
      <hr style="margin:12px 0;border-top:1px solid #eef2f6">
      <div class="filters">
        <label>Window</label><select id="selWindow_mobile"></select>
        <label>PON</label><select id="selPon_mobile"></select>
        <label>User ID</label><input id="searchUser_mobile" placeholder="Enter User ID">
        <label>Mobile No</label><input id="searchMobile_mobile" placeholder="Enter Mobile No">
        <label>Name</label><input id="searchName_mobile" placeholder="Enter Name">
        <label>Mac/Serial</label><input id="searchMac_mobile" placeholder="Enter Mac/Serial">
        <div class="user-count">User count: <span id="userCount">0</span></div>
      </div>
    </aside>
  </div>

  <div style="padding:12px 20px;">
    <div class="filters-inline">
      <select id="selWindow"></select>
      <select id="selPon"></select>
      <input id="searchUser" placeholder="Enter User ID">
      <input id="searchMobile" placeholder="Enter Mobile No">
      <input id="searchName" placeholder="Enter Name">
      <input id="searchMac" placeholder="Enter Mac/Serial">
      <div class="user-count">User count: <span id="userCount_desktop">0</span></div>
    </div>
  </div>

  <div id="tableWrap">
    <table id="dataTable">
      <thead>
        <tr>
          <th class="sortable" data-key="NMID">PON No</th>
          <th class="sortable" data-key="Users">User ID</th>
          <th>Mobile No</th>
          <th>Name</th>
          <th>Mac / Serial</th>
          <th class="sortable" data-key="Drops">Down Time</th>
          <th>Remark</th>
          <th>Actions</th>
          <th>Location</th>
          <th>Procare</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="spinnerOverlay"><div class="spinner"></div><p>Loading...</p></div>
  <div id="toast" role="status" aria-live="polite"></div>

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    const GAS_URLS={sheet1:{url:"https://script.google.com/macros/s/AKfycbzliBfK4lJmojz4wSUZVcJBg1UDu47WlLvHA5GSAFk84EPd1w4cT62Dw5PqpsuemybXww/exec",sheetId:"1oN4d2HCKLcTgogItpVgWUmDTxY28RDhtrVKEMt0PmzA"},
      sheet2:{url:"https://script.google.com/macros/s/AKfycbzP06rGtmvCWN4sMqtrluFcLeSM29vjmJ0fRO0r8rEc5mqRRuyUGTuvIK2qN1gZEvLoTg/exec",sheetId:"1d7tlBDp3snfzjeOxhZ8W0YHX-duuiwLVKDPflGsiA2Q"}};
    const TOKEN="abcd1234";
    let rawRows=[],filtered=[],currentSort={key:null,asc:true},currentMode='offline';
    const tbody=document.querySelector('#dataTable tbody'),
          selWindow=document.getElementById('selWindow'),selPon=document.getElementById('selPon'),
          selWindow_mobile=document.getElementById('selWindow_mobile'),selPon_mobile=document.getElementById('selPon_mobile');

    function showSpinner(){document.getElementById('spinnerOverlay').style.display='flex';}
    function hideSpinner(){document.getElementById('spinnerOverlay').style.display='none';}
    function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

    async function fetchData(){
      showSpinner();
      try{
        const res=await Promise.all(Object.keys(GAS_URLS).map(k=>fetch(`${GAS_URLS[k].url}?token=${TOKEN}`).then(r=>r.json()).then(d=>({key:k,rows:d.rows||[]}))));
        rawRows=res.flatMap(r=>r.rows.map(row=>({...row,source:r.key})));
        applyAllFilters();
      }catch(e){showToast('Load failed');}finally{hideSpinner();}
    }

    function applyAllFilters(){
      let data = rawRows.slice();  // Always search from full raw data

      const win = selWindow.value || selWindow_mobile.value || '';
      const pon = selPon.value || selPon_mobile.value || '';
      const user = (document.getElementById('searchUser').value || document.getElementById('searchUser_mobile').value || '').trim().toLowerCase();
      const mobile = (document.getElementById('searchMobile').value || document.getElementById('searchMobile_mobile').value || '').trim().toLowerCase();
      const name = (document.getElementById('searchName').value || document.getElementById('searchName_mobile').value || '').trim().toLowerCase();
      const mac = (document.getElementById('searchMac').value || document.getElementById('searchMac_mobile').value || '').trim().toLowerCase();

      // Apply text searches (instant, even 1 char)
      if(user||mobile||name||mac){
        data = data.filter(r=>{
          if(user && !((r.Users||r.N||'').toString().toLowerCase().includes(user))) return false;
          if(mobile && !((r['Last called no']||r.AC||'')+(r.Number||r.P||'')).toLowerCase().includes(mobile)) return false;
          if(name && !((r.Name||r.O||'').toString().toLowerCase().includes(name))) return false;
          if(mac && !((r.MAC||r.U||'')+(r.Serial||r.V||'')).toLowerCase().includes(mac)) return false;
          return true;
        });
      }

      // Apply Window & PON filters
      if(win) data = data.filter(r=>(r.Window||r.window||r.A||'').toString()===win);
      if(pon) data = data.filter(r=>(r.NMID||r.C||'').toString()===pon);

      // Apply current mode filter (offline/complains/drops)
      if(currentMode==='offline') data=data.filter(r=>(r.Downs||r.T||'').toString().trim()!=='');
      if(currentMode==='complains') data=data.filter(r=>(r.Ticket||r.X||'').toString().trim()!=='');
      if(currentMode==='drops') data=data.filter(r=>(r.Drops||r.AB||'').toString().trim()!=='');

      filtered=data;
      renderTable();
    }

    function populateWindowPon(){
      const wins=new Set(),pons=new Map();
      rawRows.forEach(r=>{const w=r.Window||r.window||r.A||'';wins.add(w);if(!pons.has(w))pons.set(w,new Set());pons.get(w).add(r.NMID||r.C||'');});
      const opts=Array.from(wins).filter(Boolean).sort().map(w=>`<option value="${w}">${w}</option>`).join('');
      selWindow.innerHTML=selWindow_mobile.innerHTML='<option value="">All Window</option>'+opts;
      selWindow._pons=pons; selWindow_mobile._pons=pons;
    }

    function renderTable(){
      tbody.innerHTML='';
      let rows=filtered.slice();
      if(currentSort.key){
        rows.sort((a,b)=>{
          const ka=(a[currentSort.key]||a[keyOrAlt(a,currentSort.key)]||'').toString().toLowerCase();
          const kb=(b[currentSort.key]||b[keyOrAlt(b,currentSort.key)]||'').toString().toLowerCase();
          return (ka<kb?-1:ka>kb?1:0)*(currentSort.asc?1:-1);
        });
      }
      document.getElementById('userCount').textContent=document.getElementById('userCount_desktop').textContent=rows.length;

      rows.forEach(r=>{
        const tr=document.createElement('tr');
        if((r.Ticket||r.X||'').toString().trim()) tr.classList.add('ticket');
        if((r.Downs||r.T||'').toString().trim()) tr.classList.add('offline');

        const uid=r.Users||r.N||'', pon=r.NMID||r.C||'', mobile=(r['Last called no']||r.AC||'')||(r.Number||r.P||'')||'',
              name=r.Name||r.O||'', mac=r.MAC||r.U||'', serial=r.Serial||r.V||'', drops=r.Drops||r.AB||'',
              remark=r.Remarks||r.Y||r.remark||r.Remark||'', location=r.Location||r.Q||'', procare=r['User status']||r.AF||'';

        tr.innerHTML=`
          <td>${pon}</td><td>${uid}</td><td>${mobile}</td><td>${name}</td>
          <td>${mac}<br><small>${serial}</small></td>
          <td>${drops?formatTimestamp(drops):''}</td>
          <td><input class="remark-input" data-uid="${uid}" data-source="${r.source}" value="${remark}"></td>
          <td>
            <button class="mark-btn" data-uid="${uid}" data-source="${r.source}"></button>
            <button class="remove-btn" data-uid="${uid}" data-source="${r.source}"></button>
          </td>
          <td>${location}</td><td>${procare}</td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('.mark-btn').forEach(b=>b.onclick=e=>{
        const uid=e.target.dataset.uid, src=e.target.dataset.source;
        const remark=e.target.closest('tr').querySelector('input').value;
        postToGAS({id:uid,action:'mark',remark,timestamp:new Date().toLocaleString()},GAS_URLS[src].sheetId)
          .then(()=>{showToast('Marked');fetchData();});
      });
      tbody.querySelectorAll('.remove-btn').forEach(b=>b.onclick=e=>{
        const uid=e.target.dataset.uid, src=e.target.dataset.source;
        postToGAS({id:uid,action:'remove'},GAS_URLS[src].sheetId)
          .then(()=>{showToast('Removed');fetchData();});
      });
    }

    function postToGAS(obj,sheetId){
      const url=Object.values(GAS_URLS).find(g=>g.sheetId===sheetId).url+`?token=${TOKEN}`;
      showSpinner();
      return fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)})
        .finally(hideSpinner);
    }

    function formatTimestamp(t){
      if(!t) return '';
      const m=/^(\d+)-(\w+)\s*\[(\d+):(\d+)\]/.exec(t);
      if(m){
        const mo={'jan':'01','feb':'02','mar':'03','apr':'04','may':'05','jun':'06','jul':'07','aug':'08','sep':'09','oct':'10','nov':'11','dec':'12'};
        const d=new Date(`${new Date().getFullYear()}-${mo[m[2].toLowerCase()]}-${m[1]} ${m[3]}:${m[4]}:00`);
        return isNaN(d)?t:`${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
      }
      return t;
    }

    function keyOrAlt(o,k){const m={'NMID':'C','Users':'N','Drops':'AB'};return m[k]||k;}

    document.addEventListener('click',e=>{
      if(e.target.closest('#btnComplains,#m_btnComplains')){currentMode='complains';applyAllFilters();}
      if(e.target.closest('#btnOffline,#m_btnOffline')){currentMode='offline';applyAllFilters();}
      if(e.target.closest('#btnDrops,#m_btnDrops')){currentMode='drops';applyAllFilters();}
      if(e.target.closest('th.sortable')){
        const key=e.target.dataset.key;
        if(currentSort.key===key) currentSort.asc=!currentSort.asc;
        else{currentSort.key=key;currentSort.asc=true;}
        renderTable();
      }
      if(e.target.closest('#btnDownloadCsv,#m_btnDownloadCsv')){
        const csv=[['PON','UserID','Mobile','Name','Mac','Serial','Down time','Remark','Location','Procare']];
        document.querySelectorAll('#dataTable tbody tr').forEach(tr=>{
          const c=tr.cells;
          csv.push([c[0].innerText,c[1].innerText,c[2].innerText,c[3].innerText,c[4].innerText.split('\n')[0],c[4].querySelector('small')?.innerText||'',c[5].innerText,c[6].querySelector('input').value,c[8].innerText,c[9].innerText]);
        });
        const blob=new Blob([csv.map(r=>r.join(',')).join('\n')],{type:'text/csv'});
        const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='complains.csv';a.click();
      }
      if(e.target.closest('#btnScreenshotDownload,#m_btnScreenshot')){
        html2canvas(document.getElementById('dataTable')).then(c=>{const a=document.createElement('a');a.href=c.toDataURL();a.download='screenshot.png';a.click();});
      }
    });

    document.addEventListener('DOMContentLoaded',()=>{
      fetchData();
      populateWindowPon();

      // Instant search on any input change
      ['searchUser','searchMobile','searchName','searchMac'].forEach(id=>{
        document.getElementById(id).oninput=document.getElementById(id+'_mobile').oninput=()=>applyAllFilters();
      });

      selWindow.onchange=()=>{selWindow_mobile.value=selWindow.value;applyAllFilters();}
      selPon.onchange=applyAllFilters;
      selWindow_mobile.onchange=()=>{selWindow.value=selWindow_mobile.value;applyAllFilters();}
      selPon_mobile.onchange=()=>{selPon.value=selPon_mobile.value;applyAllFilters();}

      document.getElementById('btnHamburger').onclick=()=>document.getElementById('appDrawer').classList.add('open');
      document.getElementById('btnCloseDrawer').onclick=document.getElementById('drawerBackdrop').onclick=()=>document.getElementById('appDrawer').classList.remove('open');
    });
  </script>
</body>
</html>
