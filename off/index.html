<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Complain Manager</title>

  <!-- Fontawesome (kept) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- your existing base styles -->
  <link rel="stylesheet" href="../stylesoff.css">

  <!-- App-specific styles (responsive + mobile drawer + sticky table) -->
  <style>
    /* ---------- Basic layout & reset ---------- */
    :root{
      --accent:#2b8cff;
      --danger:#e74c3c;
      --bg:#f7f8fb;
      --surface:#ffffff;
      --muted:#7f8c8d;
      --card-shadow: 0 6px 18px rgba(23,31,46,0.06);
      --gap:12px;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Roboto", "Helvetica", "Arial", sans-serif;background:var(--bg);color:#222;}
    a{color:inherit}
    img{max-width:100%;display:block}

    /* ---------- Top header (hamburger + title) ---------- */
    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 16px;
      background:linear-gradient(180deg,var(--surface),#fbfdff);
      box-shadow: var(--card-shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .brand {
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand h1{
      margin:0;font-size:1.05rem;font-weight:600;
      letter-spacing:0.2px;
    }
    /* hamburger */
    .hamburger {
      display:flex;
      align-items:center;
      justify-content:center;
      width:44px;height:44px;border-radius:8px;border:none;
      background:transparent;font-size:20px;cursor:pointer;
    }

    /* controls row for larger screens (inline) */
    .top-controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .top-controls button{
      background:var(--surface);
      border:1px solid #e6e9ee;
      padding:8px 12px;
      border-radius:8px;
      font-size:0.95rem;
      cursor:pointer;
      box-shadow: 0 2px 8px rgba(15,23,42,0.04);
    }
    .top-controls button:active{transform:translateY(1px)}
    .top-controls .primary {
      background: var(--accent);
      color: #fff;
      border-color: rgba(43,140,255,0.15);
    }

    /* ---------- Drawer (mobile) ---------- */
    .drawer {
      position: fixed;
      inset: 0 0 0 0;
      pointer-events: none;
      z-index: 1400;
    }
    .drawer-backdrop {
      position:absolute; inset:0;background:rgba(0,0,0,0.32); opacity:0; transition:opacity .25s ease;
      pointer-events:none;
    }
    .drawer-panel {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 320px;
      max-width: calc(100% - 40px);
      background: var(--surface);
      box-shadow: 0 20px 40px rgba(10,20,50,0.12);
      transform: translateX(-110%);
      transition: transform .36s cubic-bezier(.2,.9,.2,1);
      padding:16px;
      box-sizing:border-box;
      overflow:auto;
      pointer-events:auto;
    }
    .drawer.open .drawer-backdrop{opacity:1; pointer-events:auto}
    .drawer.open .drawer-panel{transform: translateX(0);}

    /* Filters inside drawer */
    .filters, .controls {
      display:flex;flex-direction:column;gap:10px;margin-bottom:10px;
    }
    .filters select, .filters input {
      padding:10px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;font-size:0.95rem;
    }

    /* Desktop filters (inline) */
    .filters-inline {
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0;
    }
    .filters-inline select, .filters-inline input {
      padding:8px 10px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;font-size:0.95rem;
    }
    .user-count {
      font-size:0.95rem;color:var(--muted);
      padding-left:6px;
    }

    /* ---------- Table area ---------- */
    #tableWrap {
      margin: 12px;
      background: transparent;
      border-radius: 8px;
      overflow: auto; /* horizontal scroll when needed */
      -webkit-overflow-scrolling: touch;
    }
    table#dataTable {
      width:100%;
      border-collapse:collapse;
      min-width: 980px; /* allow horizontal scroll on smaller devices */
      background:var(--surface);
      box-shadow: var(--card-shadow);
      border-radius:8px;
      overflow:hidden;
    }
    thead th {
      text-align:left;padding:12px 14px;background:linear-gradient(180deg,#fff,#fbfdff);
      border-bottom:1px solid #eef2f6;position:sticky;top:0;z-index:2;font-size:0.9rem;
    }
    tbody td {
      padding:10px 14px;border-bottom:1px solid #f1f4f8;font-size:0.95rem;vertical-align:middle;
    }
    tbody tr.offline td{ background: #fffdf6; } /* subtle highlight */
    tbody tr.ticket td{ background: #f7fffb; }

    /* action buttons inside table */
    .mark-btn, .remove-btn {
      display:inline-block;width:36px;height:36px;border-radius:6px;border:none;margin-right:6px;
      background:#f1f5f9;cursor:pointer;
    }
    .mark-btn:before{ content:""; display:inline-block; width:100%; height:100%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23000000" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></svg>'); background-size:16px; background-position:center; background-repeat:no-repeat; opacity:0.85;}
    .remove-btn:before{ content:""; display:inline-block; width:100%; height:100%; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23ff4d4d" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>'); background-size:16px; background-position:center; background-repeat:no-repeat; opacity:0.95;}

    /* spinner overlay */
    #spinnerOverlay{
      position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1200;
      background: rgba(255,255,255,0.6); backdrop-filter: blur(2px);
      flex-direction:column; gap:14px;
    }
    #spinnerOverlay .spinner{
      width:48px;height:48px;border-radius:50%;border:5px solid rgba(0,0,0,0.08);border-top-color:var(--accent);
      animation: spin 1s linear infinite;
    }
    #spinnerOverlay p{ margin:0; color:var(--muted); font-size:0.95rem; }

    @keyframes spin{ to{ transform: rotate(360deg);} }

    /* toast (center bottom) */
    #toast {
      visibility: hidden;
      min-width: 220px;
      max-width:calc(100% - 40px);
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 12px 14px;
      position: fixed;
      z-index: 1300;
      left: 50%;
      bottom: 22px;
      transform: translateX(-50%) translateY(8px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      transition: opacity .25s ease, transform .25s cubic-bezier(.2,.9,.2,1);
      opacity: 0;
    }
    #toast.show {
      visibility: visible;
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }

    /* small-screen adjustments (mobile-first) */
    @media (max-width: 880px) {
      .top-controls{ display:none; }           /* hidden inline controls on mobile */
      header.app-header { padding:10px; }
      .brand h1{ font-size:1rem; }
      .hamburger{ width:46px;height:46px;border-radius:10px; }

      /* show inline top small button instead of full controls */
      .mobile-inline-actions{ display:flex; gap:8px; align-items:center; }

      /* table becomes horizontally scrollable (min-width enforced) */
      table#dataTable{ min-width: 820px; }

      /* Make table action buttons slightly larger for touch */
      .mark-btn, .remove-btn{ width:42px;height:42px;border-radius:8px; }
    }

    /* larger screens: show inline controls & hide drawer toggle */
    @media (min-width: 881px) {
      .hamburger{ display:none; }
      .drawer { display:none; }
      .filters { display:none; } /* we will show inline filters instead */
      .filters-inline { display:flex; }
      header.app-header{ padding:14px 20px; }
      #tableWrap{ margin:18px 20px; }
    }

    /* accessibility focus */
    button:focus, input:focus, select:focus { outline: 3px solid rgba(43,140,255,0.18); outline-offset:2px; }

  </style>
</head>
<body>

  <!-- APP HEADER -->
  <header class="app-header">
    <div class="brand">
      <button class="hamburger" id="btnHamburger" aria-label="Open menu" title="Open menu">
        <i class="fa fa-bars" aria-hidden="true"></i>
      </button>
      <h1>Complain Manager</h1>
    </div>

    <!-- inline controls shown on larger screens -->
    <div class="top-controls" id="topControls">
      <div class="top-controls-inner">
        <button id="btnComplains" class="primary">Complains</button>
        <button id="btnOffline">Offline</button>
        <button id="btnDrops">Drops</button>
        <button id="btnDownloadCsv">CSV</button>
        <button id="btnScreenshotDownload">Screenshot</button>
      </div>
    </div>

    <!-- mobile quick actions (small icons) -->
    <div class="mobile-inline-actions" aria-hidden="true">
      <button id="btnDownloadCsv_mobile" title="Download CSV" style="display:none;"><i class="fa fa-file-csv"></i></button>
      <button id="btnScreenshot_mobile" title="Screenshot" style="display:none;"><i class="fa fa-camera"></i></button>
    </div>
  </header>

  <!-- DRAWER (for mobile) -->
  <div class="drawer" id="appDrawer" aria-hidden="true">
    <div class="drawer-backdrop" id="drawerBackdrop"></div>
    <aside class="drawer-panel" role="dialog" aria-label="Menu">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <strong style="font-size:1rem">Menu</strong>
        <button id="btnCloseDrawer" aria-label="Close menu" style="border:none;background:transparent;font-size:18px;cursor:pointer">✕</button>
      </div>

      <div class="controls">
        <button id="m_btnComplains">Complains</button>
        <button id="m_btnOffline">Offline</button>
        <button id="m_btnDrops">Drops</button>
        <button id="m_btnDownloadCsv">CSV</button>
        <button id="m_btnScreenshot">Screenshot</button>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef2f6">

      <div class="filters">
        <label style="font-weight:600">Window</label>
        <select id="selWindow_mobile" placeholder="Select Window"></select>

        <label style="font-weight:600">PON</label>
        <select id="selPon_mobile" placeholder="Select PON"></select>

        <label style="font-weight:600">User ID</label>
        <input id="searchUser_mobile" placeholder="Enter User ID">

        <label style="font-weight:600">Mobile No</label>
        <input id="searchMobile_mobile" placeholder="Enter Mobile No">

        <label style="font-weight:600">Name</label>
        <input id="searchName_mobile" placeholder="Enter Name">

        <label style="font-weight:600">Mac/Serial</label>
        <input id="searchMac_mobile" placeholder="Enter Mac/Serial">

        <div class="user-count">User count: <span id="userCount">0</span></div>
      </div>
    </aside>
  </div>

  <!-- Desktop inline filters (visible on wide screens) -->
  <div style="padding:12px 20px;">
    <div class="filters-inline">
      <select id="selWindow" placeholder="Select Window"></select>
      <select id="selPon" placeholder="Select PON"></select>
      <input id="searchUser" placeholder="Enter User ID">
      <input id="searchMobile" placeholder="Enter Mobile No">
      <input id="searchName" placeholder="Enter Name">
      <input id="searchMac" placeholder="Enter Mac/Serial">
      <div class="user-count">User count: <span id="userCount_desktop">0</span></div>
    </div>
  </div>

  <!-- Table -->
  <div id="tableWrap">
    <table id="dataTable" aria-describedby="userCount">
      <thead>
        <tr>
          <th class="sortable" data-key="NMID">PON No</th>
          <th class="sortable" data-key="Users">User ID</th>
          <th>Mobile No</th>
          <th>Name</th>
          <th>Mac / Serial</th>
          <th class="sortable" data-key="Drops">Down Time</th>
          <th>Remark</th>
          <th>Actions</th>
          <th>Location</th>
          <th>Procare</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- spinner & toast -->
  <div id="spinnerOverlay"><div class="spinner"></div><p>Loading...</p></div>
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- html2canvas (kept) -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <!-- MAIN SCRIPT: kept your original logic, with added responsive/menu glue -->
  <script>
    /* -------------------------
       CONFIG & DATA SOURCES (unchanged)
       ------------------------- */
    const GAS_URLS = {
      sheet1: {
        url: "https://script.google.com/macros/s/AKfycbzliBfK4lJmojz4wSUZVcJBg1UDu47WlLvHA5GSAFk84EPd1w4cT62Dw5PqpsuemybXww/exec",
        sheetId: "1oN4d2HCKLcTgogItpVgWUmDTxY28RDhtrVKEMt0PmzA"
      },
      sheet2: {
        url: "https://script.google.com/macros/s/AKfycbzP06rGtmvCWN4sMqtrluFcLeSM29vjmJ0fRO0r8rEc5mqRRuyUGTuvIK2qN1gZEvLoTg/exec",
        sheetId: "1d7tlBDp3snfzjeOxhZ8W0YHX-duuiwLVKDPflGsiA2Q"
      }
    };
    const TOKEN = "abcd1234";

    /* -------------------------
       EXISTING VARIABLES (kept)
       ------------------------- */
    let rawRows = [];
    let baseFiltered = [];
    let filtered = [];
    let currentSort = { key: null, asc: true };
    let currentMode = 'offline'; // Default mode

    // UI elements (we will map mobile <-> desktop)
    const spinner = document.getElementById('spinnerOverlay');
    const tbody = document.querySelector('#dataTable tbody');

    const selWindow = document.getElementById('selWindow');
    const selPon = document.getElementById('selPon');

    // mobile variants
    const selWindow_mobile = document.getElementById('selWindow_mobile');
    const selPon_mobile = document.getElementById('selPon_mobile');

    /* -------------------------
       Helper UI functions
       ------------------------- */
    function showSpinner() { spinner.style.display = 'flex'; document.body.classList.add('disabled'); }
    function hideSpinner() { spinner.style.display = 'none'; document.body.classList.remove('disabled'); }
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.innerText = message;
      toast.classList.add('show');
      setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    /* -------------------------
       JSONP and fetch/post helpers (kept, unchanged)
       ------------------------- */
    function jsonpGet(url, timeoutMs = 10000) {
      return new Promise((resolve, reject) => {
        const callbackName = '__onGAS_' + Math.random().toString(36).slice(2);
        window[callbackName] = function(data) {
          cleanup();
          resolve(data);
        };
        const script = document.createElement('script');
        const sep = url.indexOf('?') === -1 ? '?' : '&';
        script.src = url + sep + 'callback=' + callbackName + '&_=' + Date.now();
        script.async = true;
        let timedOut = false;
        const timer = setTimeout(() => {
          timedOut = true;
          cleanup();
          reject(new Error('JSONP request timed out'));
        }, timeoutMs);
        function cleanup() {
          clearTimeout(timer);
          try { delete window[callbackName]; } catch(e) { window[callbackName] = undefined; }
          if (script.parentNode) script.parentNode.removeChild(script);
        }
        script.onerror = function(e) { if (timedOut) return; cleanup(); reject(new Error('JSONP script error')); };
        document.head.appendChild(script);
      });
    }

    function postToGAS(obj, sheetId) {
      const gasUrl = Object.values(GAS_URLS).find(g => g.sheetId === sheetId).url;
      const url = `${gasUrl}?token=${encodeURIComponent(TOKEN)}`;
      const json = JSON.stringify(obj);
      showSpinner();
      return fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: json
      }).then(r => {
        if (!r.ok) throw new Error(`Server responded with status ${r.status}`);
        return r.json();
      }).then(resp => {
        if (!resp.success) throw new Error('Server returned failure');
        return resp;
      }).catch(err => {
        console.error('POST error:', err);
        // fallback to no-cors attempt (kept from original)
        return fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain' },
          body: json
        }).then(() => ({ success: true, fallback: true }))
          .catch(e => { console.error('Fallback POST failed:', e); throw e; });
      }).finally(() => hideSpinner());
    }

    /* -------------------------
       Main data flow (kept original functions)
       ------------------------- */
    async function fetchData() {
      showSpinner();
      try {
        const fetches = Object.keys(GAS_URLS).map(key =>
          jsonpGet(`${GAS_URLS[key].url}?token=${encodeURIComponent(TOKEN)}`)
            .then(data => ({ key, rows: data.rows || [], dashboardA7: data.dashboardA7 }))
            .catch(err => {
              console.error(`Failed to fetch from ${key}:`, err);
              return { key, rows: [], dashboardA7: null };
            })
        );
        const results = await Promise.all(fetches);
        rawRows = [];
        results.forEach(result => {
          rawRows.push(...result.rows.map(row => ({ ...row, source: result.key })));
        });
        updateBaseFiltered();
      } catch (err) {
        console.error('Fetch error:', err);
        showToast('Failed to load data: ' + err.message);
      } finally {
        hideSpinner();
      }
    }

    function updateBaseFiltered() {
      switch (currentMode) {
        case 'offline':
          baseFiltered = rawRows.filter(r => (r['Downs'] || r['T'] || '').toString().trim() !== '');
          break;
        case 'complains':
          baseFiltered = rawRows.filter(r => (r['Ticket'] || r['X'] || '').toString().trim() !== '');
          break;
        case 'drops':
          baseFiltered = rawRows.filter(r => (r['Drops'] || r['AB'] || '').toString().trim() !== '');
          break;
        default:
          baseFiltered = rawRows;
      }
      populateWindowPon();
      applyAllFilters();
    }

    function populateWindowPon() {
      const windows = new Set();
      const ponsForWindow = {};
      baseFiltered.forEach(r => {
        const win = r['Window'] || r['window'] || r['A'] || '';
        const pon = r['NMID'] || r['nmID'] || r['C'] || '';
        windows.add(win);
        if (!ponsForWindow[win]) ponsForWindow[win] = new Set();
        if (pon) ponsForWindow[win].add(pon);
      });

      // desktop select
      const selectedWin = selWindow.value;
      selWindow.innerHTML = '<option value="" style="color: black;">All Window</option>' + Array.from(windows).filter(w => w.trim() !== '').sort().map(w => `<option value="${escapeHtml(w)}" style="color: black;">${escapeHtml(w)}</option>`).join('');
      selWindow._ponsMap = ponsForWindow;
      selWindow.value = '';
      Array.from(selWindow.options).forEach(opt => { if (opt.value === selectedWin) selWindow.value = selectedWin; });
      fillPonOptions(selWindow.value);

      // mobile selects (sync)
      selWindow_mobile.innerHTML = selWindow.innerHTML;
      selWindow_mobile._ponsMap = selWindow._ponsMap;
      selWindow_mobile.value = selWindow.value;
      fillPonOptions(selWindow_mobile.value);
    }

    function fillPonOptions(windowName) {
      const map = selWindow._ponsMap || {};
      const set = windowName ? (map[windowName] || new Set()) : new Set(Object.values(map).flatMap(s => Array.from(s)));
      const selectedPon = selPon.value;
      const opts = Array.from(set).sort().map(p => `<option value="${escapeHtml(p)}" style="color: black;">${escapeHtml(p)}</option>`).join('');
      selPon.innerHTML = '<option value="" style="color: black;">Select PON</option>' + opts;
      selPon.value = '';
      Array.from(selPon.options).forEach(opt => { if (opt.value === selectedPon) selPon.value = selectedPon; });

      // mobile sync
      selPon_mobile.innerHTML = selPon.innerHTML;
      selPon_mobile.value = selPon.value;
    }

    function applyAllFilters() {
      const win = (selWindow.value || selWindow_mobile.value || '');
      const pon = (selPon.value || selPon_mobile.value || '');
      const userId = (document.getElementById('searchUser').value || document.getElementById('searchUser_mobile').value || '').trim().toLowerCase();
      const mobile = (document.getElementById('searchMobile').value || document.getElementById('searchMobile_mobile').value || '').trim().toLowerCase();
      const name = (document.getElementById('searchName').value || document.getElementById('searchName_mobile').value || '').trim().toLowerCase();
      const mac = (document.getElementById('searchMac').value || document.getElementById('searchMac_mobile').value || '').trim().toLowerCase();

      let searchFiltered = rawRows.filter(r => {
        if (userId && userId.length >= 3) {
          const v = (r['Users'] || r['N'] || '').toString().toLowerCase();
          if (!v.includes(userId)) return false;
        }
        if (mobile && mobile.length >= 3) {
          const v1 = (r['Last called no'] || r['AC'] || '').toString().toLowerCase();
          const v2 = (r['Number'] || r['P'] || '').toString().toLowerCase();
          if (!v1.includes(mobile) && !v2.includes(mobile)) return false;
        }
        if (name && name.length >= 3) {
          const v = (r['Name'] || r['O'] || '').toString().toLowerCase();
          if (!v.includes(name)) return false;
        }
        if (mac && mac.length >= 3) {
          const v1 = (r['MAC'] || r['U'] || '').toString().toLowerCase();
          const v2 = (r['Serial'] || r['V'] || '').toString().toLowerCase();
          if (!v1.includes(mac) && !v2.includes(mac)) return false;
        }
        return true;
      });

      if (!userId && !mobile && !name && !mac) {
        filtered = baseFiltered;
      } else {
        filtered = searchFiltered;
      }

      if (win && win !== '') {
        filtered = filtered.filter(r => {
          const v = (r['Window'] || r['window'] || '').toString();
          return v === win;
        });
      }
      if (pon) {
        filtered = filtered.filter(r => {
          const v = (r['NMID'] || r['C'] || '').toString();
          return v === pon;
        });
      }

      renderTable();
    }

    function renderTable() {
      tbody.innerHTML = '';
      let rowsToRender = filtered.slice();

      if (!document.getElementById('searchUser').value.trim() &&
          !document.getElementById('searchMobile').value.trim() &&
          !document.getElementById('searchName').value.trim() &&
          !document.getElementById('searchMac').value.trim()) {
        if (currentMode === 'offline') {
          rowsToRender = rowsToRender.filter(r => (r['Downs'] || r['T'] || '').toString().trim() !== '');
        } else if (currentMode === 'complains') {
          rowsToRender = rowsToRender.filter(r => (r['Ticket'] || r['X'] || '').toString().trim() !== '');
        } else if (currentMode === 'drops') {
          rowsToRender = rowsToRender.filter(r => (r['Drops'] || r['AB'] || '').toString().trim() !== '');
        }
      }

      // sync user count display (desktop & mobile)
      const userCount = rowsToRender.length;
      document.getElementById('userCount').innerText = userCount;
      const ucd = document.getElementById('userCount_desktop');
      if (ucd) ucd.innerText = userCount;

      if (currentSort.key) {
        rowsToRender.sort((a, b) => {
          const ka = (a[currentSort.key] || a[keyOrAlt(a, currentSort.key)] || '').toString();
          const kb = (b[currentSort.key] || b[keyOrAlt(b, currentSort.key)] || '').toString();
          if (ka < kb) return currentSort.asc ? -1 : 1;
          if (ka > kb) return currentSort.asc ? 1 : -1;
          return 0;
        });
      }
      rowsToRender.forEach((r, idx) => {
        const tr = document.createElement('tr');
        const isOffline = (r['Downs'] || r['T'] || '').toString().trim() !== '';
        const isTicket = (r['Ticket'] || r['X'] || '').toString().trim() !== '';
        if (isOffline) tr.classList.add('offline');
        if (isTicket) tr.classList.add('ticket');
        const userId = r['Users'] || r['N'] || '';
        const pon = r['NMID'] || r['C'] || '';
        const lastCalled = (r['Last called no'] || r['AC'] || '').toString().trim();
        const number = (r['Number'] || r['P'] || '').toString().trim();
        const mobile = lastCalled || number;
        const name = r['Name'] || r['O'] || '';
        const mac = r['MAC'] || r['U'] || '';
        const serial = r['Serial'] || r['V'] || '';
        const drops = r['Drops'] || r['AB'] || '';
        const formattedDrops = drops ? formatTimestamp(drops) : '';
        const remark = r['Remarks'] || r['Y'] || r['remark'] || r['Remark'] || '';
        const location = r['Location'] || r['Q'] || '';
        const procare = r['User status'] || r['AF'] || '';
        tr.innerHTML = `
          <td>${escapeHtml(pon)}</td>
          <td>${escapeHtml(userId)}</td>
          <td>${escapeHtml(mobile)}</td>
          <td>${escapeHtml(name)}</td>
          <td>${escapeHtml(mac)}<br><small>${escapeHtml(serial)}</small></td>
          <td>${escapeHtml(formattedDrops)}</td>
          <td><input class="remark-input" data-uid="${escapeHtml(userId)}" data-source="${r['source']}" value="${escapeHtml(remark)}"></td>
          <td>
            <button class="mark-btn" data-uid="${escapeHtml(userId)}" data-source="${r['source']}"></button>
            <button class="remove-btn" data-uid="${escapeHtml(userId)}" data-source="${r['source']}"></button>
          </td>
          <td>${escapeHtml(location)}</td>
          <td>${escapeHtml(procare)}</td>
        `;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('.mark-btn').forEach(b => b.addEventListener('click', onMarkClick));
      document.querySelectorAll('.remove-btn').forEach(b => b.addEventListener('click', onRemoveClick));
      document.querySelectorAll('.remark-input').forEach(i => i.addEventListener('change', onRemarkChange));
    }

    function keyOrAlt(obj, key) {
      const map = { 'NMID': 'C', 'Users': 'N', 'Drops': 'AB' };
      return map[key] || key;
    }
    function onRemarkChange(e) { /* saved with mark action — kept original */ }

    function onMarkClick(e) {
      const uid = e.target.dataset.uid;
      const source = e.target.dataset.source;
      const sheetId = GAS_URLS[source].sheetId;
      const remarkInput = document.querySelector(`.remark-input[data-uid="${cssEscape(uid)}"][data-source="${source}"]`);
      const remark = remarkInput ? remarkInput.value : '';
      const ts = formatTimestamp(new Date());
      const payload = { id: uid, action: 'mark', remark: remark, timestamp: ts };
      postToGAS(payload, sheetId).then(resp => {
        if (resp.success) {
          showToast('Complain marked successfully!');
          const rowEl = e.target.closest('tr');
          rowEl.style.transition = 'opacity 1.2s ease, height 1.2s ease';
          rowEl.style.opacity = '0';
          setTimeout(() => {
            rowEl.remove();
            fetchData();
          }, 1200);
        } else {
          showToast('Failed to mark complain: ' + (resp.error || 'Unknown error'));
        }
      }).catch(err => {
        showToast('Error marking complain: ' + err.message);
      });
    }

    function onRemoveClick(e) {
      const uid = e.target.dataset.uid;
      const source = e.target.dataset.source;
      const sheetId = GAS_URLS[source].sheetId;
      const payload = { id: uid, action: 'remove' };
      postToGAS(payload, sheetId).then(resp => {
        if (resp.success) {
          showToast('Complain removed successfully!');
          const rowEl = e.target.closest('tr');
          rowEl.style.transition = 'opacity 1.2s ease, height 1.2s ease';
          rowEl.style.opacity = '0';
          setTimeout(() => {
            rowEl.remove();
            fetchData();
          }, 1200);
        } else {
          showToast('Failed to remove complain: ' + (resp.error || 'Unknown error'));
        }
      }).catch(err => {
        showToast('Error removing complain: ' + err.message);
      });
    }

    function formatTimestamp(input) {
      if (!input) return '';
      const regex = /^(\d+)-(\w+)\s*\[(\d+):(\d+)\](.*)$/;
      const match = input.toString().match(regex);
      if (match) {
        const [, day, monthStr, hours, minutes] = match;
        const monthMap = {
          'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04', 'may': '05', 'jun': '06',
          'jul': '07', 'aug': '08', 'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12'
        };
        const month = monthMap[monthStr.toLowerCase()];
        if (!month) return '';
        const year = new Date().getFullYear();
        const dateStr = `${month}/${day.padStart(2, '0')}/${year} ${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}:00`;
        const parsedDate = new Date(dateStr);
        if (isNaN(parsedDate.getTime())) return '';
        const M = parsedDate.getMonth() + 1;
        const D = parsedDate.getDate();
        const Y = parsedDate.getFullYear();
        const H = parsedDate.getHours();
        const m = String(parsedDate.getMinutes()).padStart(2, '0');
        const s = String(parsedDate.getSeconds()).padStart(2, '0');
        return `${M}/${D}/${Y} ${H}:${m}:${s}`;
      }
      const d = new Date(input);
      if (isNaN(d.getTime())) return '';
      const M = d.getMonth() + 1;
      const D = d.getDate();
      const Y = d.getFullYear();
      const H = d.getHours();
      const m = String(d.getMinutes()).padStart(2, '0');
      const s = String(d.getSeconds()).padStart(2, '0');
      return `${M}/${D}/${Y} ${H}:${m}:${s}`;
    }

    /* -------------------------
       CSV download (kept)
       ------------------------- */
    document.addEventListener('click', (ev) => {
      // Delegate: desktop CSV button
      if (ev.target && (ev.target.id === 'btnDownloadCsv' || ev.target.id === 'm_btnDownloadCsv' || ev.target.id === 'btnDownloadCsv_mobile')) {
        const rows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
        const csv = [];
        csv.push(['PON', 'UserID', 'Mobile', 'Name', 'Mac', 'Serial', 'Down time', 'Remark', 'Location', 'Procare'].join(','));
        rows.forEach(tr => {
          const tds = tr.querySelectorAll('td');
          const pon = tds[0].innerText.trim();
          const uid = tds[1].innerText.trim();
          const mobile = tds[2].innerText.trim();
          const name = tds[3].innerText.trim();
          const mac = tds[4].innerText.split('\n')[0].trim();
          const serial = tds[4].querySelector('small') ? tds[4].querySelector('small').innerText.trim() : '';
          const drops = tds[5].innerText.trim();
          const remark = tds[6].querySelector('input') ? tds[6].querySelector('input').value.replace(/\n/g, ' ') : '';
          const location = tds[8].innerText.trim();
          const procare = tds[9].innerText.trim();
          csv.push([escapeCsv(pon), escapeCsv(uid), escapeCsv(mobile), escapeCsv(name), escapeCsv(mac), escapeCsv(serial), escapeCsv(drops), escapeCsv(remark), escapeCsv(location), escapeCsv(procare)].join(','));
        });
        const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'complains.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
      // Screenshot delegate
      if (ev.target && (ev.target.id === 'btnScreenshotDownload' || ev.target.id === 'm_btnScreenshot' || ev.target.id === 'btnScreenshot_mobile')) {
        // call the same screenshot routine (delegated)
        triggerScreenshotDownload();
      }
    });

    /* Screenshot function (extracted so mobile can call it) */
    async function triggerScreenshotDownload(){
      showSpinner();
      try {
        await new Promise(resolve => setTimeout(resolve, 100));
        const node = document.getElementById('dataTable');
        if (!node) throw new Error('Table element not found');
        const originalOverflow = node.parentElement.style.overflow;
        node.parentElement.style.overflow = 'visible';
        node.style.width = 'auto';
        const canvas = await html2canvas(node, {
          scale: window.devicePixelRatio || 1,
          useCORS: true,
          logging: true,
          backgroundColor: null,
          scrollX: 0,
          scrollY: -window.scrollY,
          windowWidth: node.scrollWidth,
          windowHeight: node.scrollHeight
        });
        if (!canvas) throw new Error('Canvas creation failed');
        const dataUrl = canvas.toDataURL('image/png');
        const blob = await (await fetch(dataUrl)).blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'screenshot.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        node.parentElement.style.overflow = originalOverflow;
        node.style.width = '';
        showToast('Screenshot downloaded successfully!');
      } catch (err) {
        console.error('Screenshot download failed:', err);
        showToast('Failed to download screenshot: ' + (err.message || 'Unknown error'));
      }
      hideSpinner();
    }

    /* Sorting toggles (kept) */
    document.addEventListener('click', (ev) => {
      if (ev.target && ev.target.matches('th.sortable, th.sortable *')) {
        const th = ev.target.closest('th.sortable');
        const key = th.dataset.key;
        if (currentSort.key === key) currentSort.asc = !currentSort.asc; else { currentSort.key = key; currentSort.asc = true; }
        renderTable();
      }
    });

    /* helper utils (kept) */
    function escapeHtml(s) { if (s == null) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
    function cssEscape(s) { return String(s).replace(/(["'\\])/g, '\\$1'); }
    function escapeCsv(s) { if (s == null) return '""'; s = String(s).replace(/"/g, '""'); return '"' + s + '"'; }

    /* -------------------------
       Initialize & UI bindings
       - wrapped in DOMContentLoaded for reliability across devices
       ------------------------- */
    document.addEventListener('DOMContentLoaded', () => {
      // fetch initial data
      fetchData();

      // wire desktop buttons (kept)
      document.getElementById('btnComplains').addEventListener('click', () => {
        currentMode = 'complains';
        showSpinner(); setTimeout(() => { updateBaseFiltered(); hideSpinner(); }, 300);
      });
      document.getElementById('btnOffline').addEventListener('click', () => {
        currentMode = 'offline';
        showSpinner(); setTimeout(() => { updateBaseFiltered(); hideSpinner(); }, 300);
      });
      document.getElementById('btnDrops').addEventListener('click', () => {
        currentMode = 'drops';
        showSpinner(); setTimeout(() => { updateBaseFiltered(); hideSpinner(); }, 300);
      });

      // search inputs (desktop) - behave exactly like original
      document.getElementById('searchUser').addEventListener('input', () => { if (document.getElementById('searchUser').value.length >= 3) applyAllFilters(); });
      document.getElementById('searchMobile').addEventListener('input', () => { if (document.getElementById('searchMobile').value.length >= 3) applyAllFilters(); });
      document.getElementById('searchName').addEventListener('input', () => { if (document.getElementById('searchName').value.length >= 3) applyAllFilters(); });
      document.getElementById('searchMac').addEventListener('input', () => { if (document.getElementById('searchMac').value.length >= 3) applyAllFilters(); });

      // sync mobile inputs to desktop (two-way)
      bindMobileDesktopSync();

      // mobile drawer controls
      const drawer = document.getElementById('appDrawer');
      const btnHamburger = document.getElementById('btnHamburger');
      const btnCloseDrawer = document.getElementById('btnCloseDrawer');
      const drawerBackdrop = document.getElementById('drawerBackdrop');

      function openDrawer(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); document.body.style.overflow = 'hidden'; }
      function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); document.body.style.overflow = ''; }

      btnHamburger.addEventListener('click', openDrawer);
      btnCloseDrawer.addEventListener('click', closeDrawer);
      drawerBackdrop.addEventListener('click', closeDrawer);

      // mobile buttons inside drawer - delegate to desktop handlers
      document.getElementById('m_btnComplains').addEventListener('click', () => { currentMode='complains'; updateBaseFiltered(); closeDrawer(); });
      document.getElementById('m_btnOffline').addEventListener('click', () => { currentMode='offline'; updateBaseFiltered(); closeDrawer(); });
      document.getElementById('m_btnDrops').addEventListener('click', () => { currentMode='drops'; updateBaseFiltered(); closeDrawer(); });
      document.getElementById('m_btnDownloadCsv').addEventListener('click', () => { document.getElementById('btnDownloadCsv').click(); });
      document.getElementById('m_btnScreenshot').addEventListener('click', () => { triggerScreenshotDownload(); closeDrawer(); });

      // desktop select change handlers
      selWindow.addEventListener('change', () => { fillPonOptions(selWindow.value); applyAllFilters(); });
      selPon.addEventListener('change', applyAllFilters);

      // mobile select change handlers
      selWindow_mobile.addEventListener('change', () => { selWindow.value = selWindow_mobile.value; fillPonOptions(selWindow_mobile.value); applyAllFilters(); });
      selPon_mobile.addEventListener('change', () => { selPon.value = selPon_mobile.value; applyAllFilters(); });

      // mobile search inputs: sync to desktop and trigger applyAllFilters
      document.getElementById('searchUser_mobile').addEventListener('input', () => { document.getElementById('searchUser').value = document.getElementById('searchUser_mobile').value; if (document.getElementById('searchUser_mobile').value.length >=3) applyAllFilters(); });
      document.getElementById('searchMobile_mobile').addEventListener('input', () => { document.getElementById('searchMobile').value = document.getElementById('searchMobile_mobile').value; if (document.getElementById('searchMobile_mobile').value.length >=3) applyAllFilters(); });
      document.getElementById('searchName_mobile').addEventListener('input', () => { document.getElementById('searchName').value = document.getElementById('searchName_mobile').value; if (document.getElementById('searchName_mobile').value.length >=3) applyAllFilters(); });
      document.getElementById('searchMac_mobile').addEventListener('input', () => { document.getElementById('searchMac').value = document.getElementById('searchMac_mobile').value; if (document.getElementById('searchMac_mobile').value.length >=3) applyAllFilters(); });

      // on resize/orientation: close drawer if screen wide, keep UX consistent
      window.addEventListener('resize', () => {
        if (window.innerWidth > 880) closeDrawer();
      });
      window.addEventListener('orientationchange', () => {
        // small pause to allow layout settle
        setTimeout(()=> { if (window.innerWidth > 880) closeDrawer(); }, 300);
      });

      // ensure inline mobile action buttons visible if helpful (optional)
      document.getElementById('btnDownloadCsv_mobile').style.display = 'none'; // kept hidden to avoid duplicate UI
      document.getElementById('btnScreenshot_mobile').style.display = 'none';
    });

    /* Two-way sync helper for mobile <-> desktop selects & inputs */
    function bindMobileDesktopSync(){
      // sync initial values (already done in populateWindowPon)
      // attach listeners already inside DOMContentLoaded
    }

    /* existing utilities remaining unchanged */
    function escapeHtml(s) { if (s == null) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
    function cssEscape(s) { return String(s).replace(/(["'\\])/g, '\\$1'); }
    function escapeCsv(s) { if (s == null) return '""'; s = String(s).replace(/"/g, '""'); return '"' + s + '"'; }

  </script>
</body>
</html>
