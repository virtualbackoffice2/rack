<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Complain Manager</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root {
  --accent:#2b8cff; --danger:#e74c3c; --success:#4caf50;
  --bg:#f7f8fb; --border:#e0e4ed;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,sans-serif;background:var(--bg)}
.app-header{display:flex;justify-content:space-between;align-items:center;
  padding:10px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);
  position:sticky;top:0;z-index:1000}
.top-controls{display:flex;gap:6px;flex-wrap:wrap}
.top-controls button,.top-controls select{
  padding:8px 12px;border-radius:8px;border:1px solid var(--border);
  background:#fff;font-size:.9rem;cursor:pointer
}
.primary{background:var(--accent);color:#fff;border:none}
.icon-btn{width:38px;height:38px;display:flex;align-items:center;justify-content:center}

.filters-inline{padding:10px;background:#f9faff;display:flex;gap:8px;flex-direction:column}
.filters-inline input{padding:10px;border-radius:8px;border:1px solid var(--border)}

#tableWrap{margin:10px;background:#fff;border-radius:8px;overflow-x:auto}
table{width:100%;min-width:950px;border-collapse:collapse}
thead th{background:#e8ecff;padding:10px;font-size:.85rem;position:sticky;top:0}
tbody td{padding:8px;font-size:.85rem;border-bottom:1px solid #eee}

.offline td{background:#fffdf6}
.ticket td{background:#ffebee!important;color:#c62828}

.mark-btn,.remove-btn{width:32px;height:32px;border:none;border-radius:6px;color:#fff}
.mark-btn{background:var(--success)}
.remove-btn{background:var(--danger)}

#spinnerOverlay{position:fixed;inset:0;background:rgba(255,255,255,.85);
display:none;align-items:center;justify-content:center;z-index:9999}
.spinner{width:48px;height:48px;border:5px solid #ddd;border-top-color:var(--accent);
border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
background:#333;color:#fff;padding:12px 20px;border-radius:8px;opacity:0}
#toast.show{opacity:1}
</style>
</head>

<body>

<header class="app-header">
  <h2>Complain Manager</h2>
  <div class="top-controls">
    <select id="windowSelect">
      <option value="ALL">All Window</option>
      <option value="MEROTRA">MEROTRA</option>
      <option value="SUNNY">SUNNY</option>
    </select>
    <button id="btnComplains" class="primary">Complains</button>
    <button id="btnDrops">Drops</button>
    <button id="btnRefresh" class="icon-btn"><i class="fas fa-sync"></i></button>
    <button id="btnScreenshot" class="icon-btn"><i class="fas fa-camera"></i></button>
    <button id="btnCsv" class="icon-btn"><i class="fas fa-file-csv"></i></button>
  </div>
</header>

<div class="filters-inline">
  <input id="globalSearch" placeholder="Search anything">
</div>

<div id="tableWrap">
<table>
<thead>
<tr>
<th>Window</th><th>PON</th><th>User</th><th>Mobile</th><th>Name</th>
<th>Down</th><th>Remark</th><th>Mode</th><th>Power</th><th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div id="spinnerOverlay"><div class="spinner"></div></div>
<div id="toast"></div>

<script>
const BASE_URL = "https://app.vbo.co.in";
let rawRows=[], filtered=[], currentMode="all", currentWindow="ALL";

const tbody=document.getElementById("tbody");
const toast=document.getElementById("toast");
const spinner=document.getElementById("spinnerOverlay");

function showToast(m){toast.textContent=m;toast.classList.add("show");
setTimeout(()=>toast.classList.remove("show"),2500)}
function showSpinner(){spinner.style.display="flex"}
function hideSpinner(){spinner.style.display="none"}

async function fetchWindow(win){
  const res=await fetch(`${BASE_URL}/${win}/complains`);
  const json=await res.json();
  return (json.rows||[]).map(r=>({...r,_window:win}));
}

async function fetchData(){
  showSpinner();
  try{
    let data=[];
    if(currentWindow==="ALL"){
      const [m,s]=await Promise.all([fetchWindow("MEROTRA"),fetchWindow("SUNNY")]);
      data=[...m,...s];
    }else{
      data=await fetchWindow(currentWindow);
    }
    rawRows=data;
    applyFilters();
    showToast(`${rawRows.length} users loaded`);
  }catch(e){
    showToast("Load failed");
  }finally{hideSpinner()}
}

function applyFilters(){
  let d=[...rawRows];
  const t=document.getElementById("globalSearch").value.toLowerCase();
  if(t) d=d.filter(r=>Object.values(r).some(v=>String(v||"").toLowerCase().includes(t)));
  filtered=d;
  render();
}

function render(){
  tbody.innerHTML="";
  if(!filtered.length){
    tbody.innerHTML="<tr><td colspan='10' style='text-align:center'>No Data</td></tr>";
    return;
  }
  filtered.forEach(r=>{
    const tr=document.createElement("tr");
    if(r["User status"]==="DOWN") tr.classList.add("offline");
    if(r.Ticket) tr.classList.add("ticket");

    tr.innerHTML=`
      <td>${r._window}</td>
      <td>${r.PON||""}</td>
      <td>${r.Users||""}</td>
      <td>${r["Last called no"]||""}</td>
      <td>${r.Name||""}</td>
      <td>${r.Drops||""}</td>
      <td><input value="${r.Remarks||""}"></td>
      <td>
        <select>
          <option ${r.Mode==="Manual"?"selected":""}>Manual</option>
          <option ${r.Mode==="Auto"?"selected":""}>Auto</option>
        </select>
      </td>
      <td>${r.Power?Number(r.Power).toFixed(2):""}</td>
      <td>
        <button class="mark-btn"><i class="fas fa-check"></i></button>
        <button class="remove-btn"><i class="fas fa-trash"></i></button>
      </td>
    `;

    tr.querySelector(".mark-btn").onclick=async()=>{
      await fetch(`${BASE_URL}/${r._window}/mark_complain`,{
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({user_id:r.Users,pon:r.PON})
      });
      showToast("Marked");
      fetchData();
    };

    tr.querySelector(".remove-btn").onclick=async()=>{
      await fetch(`${BASE_URL}/${r._window}/delete_complain`,{
        method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({user_id:r.Users,pon:r.PON})
      });
      showToast("Deleted");
      fetchData();
    };

    tbody.appendChild(tr);
  });
}

document.getElementById("windowSelect").onchange=e=>{
  currentWindow=e.target.value; fetchData();
};
document.getElementById("btnRefresh").onclick=fetchData;
document.getElementById("globalSearch").oninput=applyFilters;

fetchData();
</script>
</body>
</html>
