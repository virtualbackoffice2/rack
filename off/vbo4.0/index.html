<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Complain Manager</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --accent: #2b8cff;
      --danger: #e74c3c;
      --success: #4caf50;
      --bg: #f7f8fb;
      --border: #e0e4ed;
    }

    * { box-sizing: border-box; margin:0; padding:0; }
    html, body {
      height: 100%;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: #222;
      overflow-x: hidden;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .brand h1 {
      font-size: 1.15rem;
      font-weight: 600;
      margin: 0;
    }

    .top-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .top-controls button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      font-size: 0.9rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .top-controls .primary { background: var(--accent); color: white; border: none; }

    .icon-btn {
      width: 38px;
      height: 38px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      color: #555;
    }

    .filters-inline {
      padding: 10px 12px;
      background: #f9faff;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filters-inline input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
    }

    #tableWrap {
      margin: 0 10px 10px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
    }

    thead th {
      background: #e8ecff;
      color: #1a237e;
      padding: 10px 8px;
      font-size: 0.88rem;
      font-weight: 600;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }

    .filter-row td {
      background: #f5f7ff;
      padding: 6px 8px;
      position: sticky;
      top: 40px;
      z-index: 9;
    }

    .filter-row select {
      width: 100%;
      padding: 6px;
      border: 1px solid #d1d9ff;
      border-radius: 6px;
      font-size: 0.85rem;
    }

    tbody td {
      padding: 10px 8px;
      font-size: 0.88rem;
      border-bottom: 1px solid #f0f2f7;
    }

    tbody tr.offline td { background: #fffdf6; }
    tbody tr.ticket td { background: #ffebee !important; color: #c62828 !important; }

    .remarkInput, .modeSel {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #d0d4e0;
      border-radius: 6px;
      font-size: 0.88rem;
    }

    .mark-btn, .remove-btn {
      width: 34px;
      height: 34px;
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }

    .mark-btn { background: var(--success); }
    .remove-btn { background: var(--danger); }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status-up { background: var(--success); }
    .status-down { background: var(--danger); animation: blink 1.4s infinite; }

    @keyframes blink { 0%,100% {opacity:1;} 50% {opacity:0.35;} }

    #spinnerOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.85);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid #e0e0e0;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 9998;
      font-size: 0.95rem;
    }

    #toast.show { opacity: 1; }
  </style>
</head>

<body>

<header class="app-header">
  <div class="brand">
    <h1>Complain Manager</h1>
  </div>
  <div class="top-controls">

    <select id="windowSelect"
      style="padding:8px 10px;border-radius:8px;border:1px solid var(--border);font-size:0.9rem;">
      <option value="ALL">All Window</option>
      <option value="MEROTRA">MEROTRA</option>
      <option value="SUNNY">SUNNY</option>
    </select>

    <button id="btnComplains" class="primary">Complains</button>
    <button id="btnDrops">Drops</button>
    <button id="btnRefresh" class="icon-btn"><i class="fas fa-sync-alt"></i></button>
    <button id="btnScreenshot" class="icon-btn"><i class="fas fa-camera"></i></button>
    <button id="btnCsv" class="icon-btn"><i class="fas fa-file-csv"></i></button>
  </div>
</header>

<div class="filters-inline">
  <input id="globalSearch" placeholder="Search anything..." type="text">
  <input id="powerMin" placeholder="Min Power" type="number" step="0.1">
  <input id="powerMax" placeholder="Max Power" type="number" step="0.1">
</div>

<div id="tableWrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th>PON</th>
        <th>User ID</th>
        <th>Mobile</th>
        <th>Name</th>
        <th>Mac / Serial</th>
        <th>Down</th>
        <th>Remark</th>
        <th>Team</th>
        <th>Mode</th>
        <th>Power</th>
        <th>Complain</th>
        <th>Location</th>
        <th>Status</th>
      </tr>
      <tr class="filter-row">
        <td><select id="filterPon"></select></td>
        <td></td><td></td><td></td><td></td><td></td><td></td>
        <td><select id="filterTeam"></select></td>
        <td><select id="filterMode"></select></td>
        <td></td><td></td><td></td>
        <td><select id="filterStatus"></select></td>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="spinnerOverlay">
  <div class="spinner"></div>
  <p>Loading users...</p>
</div>

<div id="toast"></div>

<script>
const BASE_URL = "https://app.vbo.co.in";
let currentWindow = "ALL";

let rawRows = [];
let filtered = [];
let currentMode = "all";

const tbody = document.querySelector("#dataTable tbody");
const spinner = document.getElementById("spinnerOverlay");
const toastEl = document.getElementById("toast");

const globalSearch = document.getElementById("globalSearch");
const powerMin = document.getElementById("powerMin");
const powerMax = document.getElementById("powerMax");
const filterPon = document.getElementById("filterPon");
const filterTeam = document.getElementById("filterTeam");
const filterMode = document.getElementById("filterMode");
const filterStatus = document.getElementById("filterStatus");

function showToast(msg) {
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(() => toastEl.classList.remove("show"), 2800);
}
function showSpinner() { spinner.style.display = "flex"; }
function hideSpinner() { spinner.style.display = "none"; }

async function fetchData() {
  showSpinner();
  try {
    async function load(win) {
      const res = await fetch(`${BASE_URL}/${win}/complains`);
      const data = await res.json();
      return (data.rows || []).map(r => ({ ...r, _window: win }));
    }

    if (currentWindow === "ALL") {
      rawRows = [
        ...(await load("MEROTRA")),
        ...(await load("SUNNY"))
      ];
    } else {
      rawRows = await load(currentWindow);
    }

    showToast(rawRows.length ? `${rawRows.length} users loaded` : "No users found");
    populateFilters();
    applyAllFilters();

  } catch (err) {
    showToast("Load failed");
    console.error(err);
  } finally {
    hideSpinner();
  }
}

document.getElementById("windowSelect").onchange = (e) => {
  currentWindow = e.target.value;
  fetchData();
};

fetchData();
</script>

</body>
</html>
