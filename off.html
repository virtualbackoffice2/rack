<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Complain Manager</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Minimal inline styles required for functionality (styling will be moved to styles.css later) */
    body{font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:18px}
    h1{font-size:24px;margin-bottom:10px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    button{padding:8px 10px;border:1px solid #ccc;background:#f7f7f7;border-radius:6px;cursor:pointer}
    select,input{padding:6px;border:1px solid #ccc;border-radius:6px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e5e5e5;padding:8px;text-align:left}
    th.sortable{cursor:pointer}
    tr.offline{background:#ffeef0} /* light pink */
    tr.ticket{background:#ff9999} /* more red tint for tickets */
    .spinner-overlay{position:fixed;inset:0;background:rgba(255,255,255,0.7);display:none;align-items:center;justify-content:center;z-index:9999}
    .spinner{width:64px;height:64px;border-radius:50%;border:8px solid #eee;border-top-color:#666;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .count-badge{font-weight:600;margin-left:8px}
    .small-btn{padding:6px 8px;font-size:13px}
    .fade-out{transition:opacity 0.8s ease,height 0.8s ease;margin:0;padding:0}
    .remark-input{width:95%}
    .icon-btn{border:none;background:transparent;cursor:pointer;font-size:16px;margin-left:6px}
    .top-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .disabled{opacity:0.6;pointer-events:none}
  </style>
  <!-- html2canvas for screenshot functionality -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <h1>Complain Manager</h1>
  <div class="top-row">
    <div class="controls">
      <button id="btnComplains">A - Complains</button>
      <button id="btnOffline">B - Offline users</button>
      <button id="btnDrops">C - Drop users</button>
      <button id="btnDownloadCsv">D - Download CSV</button>
      <button id="btnScreenshotWhatsapp">E - Screenshot & share to WhatsApp</button>
    </div>
    <div style="margin-left:10px">User count: <span id="userCount">0</span></div>
  </div>
  <div class="filters" style="margin-top:12px">
    <label>Window: <select id="selWindow"><option value="">-- All --</option></select></label>
    <label>PON: <select id="selPon"><option value="">-- All --</option></select></label>
    <label>User ID: <input id="searchUser" placeholder="User ID (Users)"></label>
    <label>Mobile no: <input id="searchMobile" placeholder="Number or Last called no"></label>
    <label>Name: <input id="searchName" placeholder="Name"></label>
    <label>Mac/Serial: <input id="searchMac" placeholder="MAC or Serial"></label>
    <label>Time filter (Drops): <select id="selTimeFilter"><option value="">--All--</option></select></label>
  </div>
  <div id="tableWrap">
    <table id="dataTable">
      <thead>
        <tr>
          <th class="sortable" data-key="NMID">PON No ▲▼</th>
          <th class="sortable" data-key="Users">User ID ▲▼</th>
          <th>Mobile No</th>
          <th>Name</th>
          <th>Mac / Serial</th>
          <th class="sortable" data-key="Drops">Down time ▲▼</th>
          <th>Remark</th>
          <th>Actions</th>
          <th>Location</th>
          <th>Procare</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="spinner-overlay" id="spinnerOverlay"><div class="spinner"></div></div>
  <script>
  // --- CONFIG: update these to your deployed GAS endpoint & token ---
  const GAS_URL = "https://script.google.com/macros/s/AKfycbz-FZM6fwvv0ruaSv-PbEG8sHNOmldJn6kXtRY6e7NZ9YlN3TJ5Oe9ECMwmGBTK-LMTnA/exec";
  const TOKEN = "abcd1234";
  // ---------------------------------------------------------------
  let rawRows = []; // rows from GAS
  let filtered = []; // currently loaded rows
  let currentSort = { key: null, asc: true };
  const spinner = document.getElementById('spinnerOverlay');
  const tbody = document.querySelector('#dataTable tbody');
  const selWindow = document.getElementById('selWindow');
  const selPon = document.getElementById('selPon');
  const selTimeFilter = document.getElementById('selTimeFilter');
  function showSpinner() { spinner.style.display = 'flex'; document.body.classList.add('disabled'); }
  function hideSpinner() { spinner.style.display = 'none'; document.body.classList.remove('disabled'); }
  // -----------------------------
  // JSONP GET helper (avoids CORS issues for reads)
  // -----------------------------
  function jsonpGet(url, timeoutMs = 10000) {
    return new Promise((resolve, reject) => {
      const callbackName = '__onGAS_' + Math.random().toString(36).slice(2);
      window[callbackName] = function(data) {
        cleanup();
        resolve(data);
      };
      const script = document.createElement('script');
      const sep = url.indexOf('?') === -1 ? '?' : '&';
      script.src = url + sep + 'callback=' + callbackName + '&_=' + Date.now();
      script.async = true;
      let timedOut = false;
      const timer = setTimeout(() => {
        timedOut = true;
        cleanup();
        reject(new Error('JSONP request timed out'));
      }, timeoutMs);
      function cleanup() {
        clearTimeout(timer);
        try { delete window[callbackName]; } catch(e) { window[callbackName] = undefined; }
        if (script.parentNode) script.parentNode.removeChild(script);
      }
      script.onerror = function(e) { if (timedOut) return; cleanup(); reject(new Error('JSONP script error')); };
      document.head.appendChild(script);
    });
  }
  function fetchData() {
    showSpinner();
    const url = GAS_URL + '?token=' + encodeURIComponent(TOKEN);
    jsonpGet(url, 12000).then(data => {
      rawRows = data && data.rows ? data.rows : [];
      populateWindowPon();
      applyQuickFilterOffline();
    }).catch(err => {
      console.error('Failed to fetch via JSONP:', err);
      fetch(url).then(r => r.json()).then(data => {
        rawRows = data && data.rows ? data.rows : [];
        populateWindowPon();
        applyQuickFilterOffline();
      }).catch(err2 => {
        console.error('Fallback fetch failed:', err2);
        alert('Unable to load data from server (CORS or network error).\nSee console for details.');
      });
    }).finally(() => hideSpinner());
  }
  // -----------------------------
  // POST helper with improved error handling
  // -----------------------------
  function postToGAS(obj) {
    const url = GAS_URL + '?token=' + encodeURIComponent(TOKEN);
    const json = JSON.stringify(obj);
    showSpinner();
    return fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: json
    }).then(r => {
      if (!r.ok) throw new Error(`Server responded with status ${r.status}`);
      return r.json();
    }).then(resp => {
      if (!resp.success) throw new Error('Server returned failure');
      return resp;
    }).catch(err => {
      console.error('POST error:', err);
      return fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain' },
        body: json
      }).then(() => ({ success: true, fallback: true }))
        .catch(e => {
          console.error('Fallback POST failed:', e);
          throw e;
        });
    }).finally(() => hideSpinner());
  }
  function populateWindowPon() {
    const windows = new Set();
    const ponsForWindow = {};
    rawRows.forEach(r => {
      const win = r['Window'] || r['window'] || r['A'] || '';
      const pon = r['NMID'] || r['nmID'] || r['C'] || '';
      windows.add(win);
      if (!ponsForWindow[win]) ponsForWindow[win] = new Set();
      if (pon) ponsForWindow[win].add(pon);
    });
    selWindow.innerHTML = '<option value="">-- All --</option>' + Array.from(windows).sort().map(w => `<option value="${escapeHtml(w)}">${escapeHtml(w)}</option>`).join('');
    selWindow._ponsMap = ponsForWindow;
    fillPonOptions('');
  }
  function fillPonOptions(windowName) {
    const map = selWindow._ponsMap || {};
    const set = windowName ? (map[windowName] || new Set()) : new Set(Object.values(map).flatMap(s => Array.from(s)));
    const opts = Array.from(set).sort().map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
    selPon.innerHTML = '<option value="">-- All --</option>' + opts;
  }
  function applyQuickFilterOffline() {
    filtered = rawRows.filter(r => {
      const val = (r['Downs'] || r['T'] || '').toString().trim();
      return val !== '';
    });
    renderTable();
    populateTimeFilter();
  }
  function applyFilterComplains() {
    filtered = rawRows.filter(r => {
      const val = (r['Ticket'] || r['X'] || '').toString().trim();
      return val !== '';
    });
    renderTable();
    populateTimeFilter();
  }
  function applyFilterDrops() {
    filtered = rawRows.filter(r => {
      const val = (r['Drops'] || r['AB'] || '').toString().trim();
      return val !== '';
    });
    renderTable();
    populateTimeFilter();
  }
  function applyAllFilters() {
    const win = selWindow.value;
    const pon = selPon.value;
    const userId = document.getElementById('searchUser').value.trim().toLowerCase();
    const mobile = document.getElementById('searchMobile').value.trim().toLowerCase();
    const name = document.getElementById('searchName').value.trim().toLowerCase();
    const mac = document.getElementById('searchMac').value.trim().toLowerCase();
    const timeSel = selTimeFilter.value;
    filtered = rawRows.filter(r => {
      if (win) { const v = (r['Window'] || r['window'] || '').toString(); if (v !== win) return false }
      if (pon) { const v = (r['NMID'] || r['C'] || '').toString(); if (v !== pon) return false }
      if (userId && userId.length >= 3) { const v = (r['Users'] || r['N'] || '').toString().toLowerCase(); if (!v.includes(userId)) return false }
      if (mobile && mobile.length >= 3) { const v1 = (r['Last called no'] || r['AC'] || '').toString().toLowerCase(); const v2 = (r['Number'] || r['P'] || '').toString().toLowerCase(); if (!v1.includes(mobile) && !v2.includes(mobile)) return false }
      if (name && name.length >= 3) { const v = (r['Name'] || r['O'] || '').toString().toLowerCase(); if (!v.includes(name)) return false }
      if (mac && mac.length >= 3) { const v1 = (r['MAC'] || r['U'] || '').toString().toLowerCase(); const v2 = (r['Serial'] || r['V'] || '').toString().toLowerCase(); if (!v1.includes(mac) && !v2.includes(mac)) return false }
      if (timeSel) { const v = (r['Drops'] || r['AB'] || '').toString(); if (v !== timeSel) return false }
      return true;
    });
    renderTable();
  }
  function populateTimeFilter() {
    const times = new Set();
    filtered.forEach(r => { const v = (r['Drops'] || r['AB'] || '').toString(); if (v) times.add(v); });
    selTimeFilter.innerHTML = '<option value="">--All--</option>' + Array.from(times).sort().map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
  }
  function renderTable() {
    tbody.innerHTML = '';
    document.getElementById('userCount').innerText = filtered.length;
    let rowsToRender = filtered.slice();
    if (currentSort.key) {
      rowsToRender.sort((a, b) => {
        const ka = (a[currentSort.key] || a[keyOrAlt(a, currentSort.key)] || '').toString();
        const kb = (b[currentSort.key] || b[keyOrAlt(b, currentSort.key)] || '').toString();
        if (ka < kb) return currentSort.asc ? -1 : 1;
        if (ka > kb) return currentSort.asc ? 1 : -1;
        return 0;
      });
    }
    rowsToRender.forEach((r, idx) => {
      const tr = document.createElement('tr');
      const isOffline = (r['Downs'] || r['T'] || '').toString().trim() !== '';
      const isTicket = (r['Ticket'] || r['X'] || '').toString().trim() !== '';
      if (isOffline) tr.classList.add('offline');
      if (isTicket) tr.classList.add('ticket');
      const userId = r['Users'] || r['N'] || '';
      const pon = r['NMID'] || r['C'] || '';
      const lastCalled = (r['Last called no'] || r['AC'] || '').toString().trim();
      const number = (r['Number'] || r['P'] || '').toString().trim();
      const mobile = lastCalled || number;
      const name = r['Name'] || r['O'] || '';
      const mac = r['MAC'] || r['U'] || '';
      const serial = r['Serial'] || r['V'] || '';
      const drops = r['Drops'] || r['AB'] || '';
      const remark = r['Remarks'] || r['Y'] || r['remark'] || r['Remark'] || '';
      const location = r['Location'] || r['Q'] || '';
      const procare = r['User status'] || r['AF'] || '';
      tr.innerHTML = `
        <td>${escapeHtml(pon)}</td>
        <td>${escapeHtml(userId)}</td>
        <td>${escapeHtml(mobile)}</td>
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(mac)}<br><small>${escapeHtml(serial)}</small></td>
        <td>${escapeHtml(drops)}</td>
        <td><input class="remark-input" data-uid="${escapeHtml(userId)}" value="${escapeHtml(remark)}"></td>
        <td>
          <button class="small-btn mark-btn" data-uid="${escapeHtml(userId)}">Mark Complain</button>
          <button class="small-btn remove-btn" data-uid="${escapeHtml(userId)}">Remove Complain</button>
        </td>
        <td>${escapeHtml(location)}</td>
        <td>${escapeHtml(procare)}</td>
      `;
      tbody.appendChild(tr);
    });
    document.querySelectorAll('.mark-btn').forEach(b => b.addEventListener('click', onMarkClick));
    document.querySelectorAll('.remove-btn').forEach(b => b.addEventListener('click', onRemoveClick));
    document.querySelectorAll('.remark-input').forEach(i => i.addEventListener('change', onRemarkChange));
  }
  function keyOrAlt(obj, key) {
    const map = { 'NMID': 'C', 'Users': 'N', 'Drops': 'AB' };
    return map[key] || key;
  }
  function onRemarkChange(e) {
    // No auto-save here; saved when marking complain
  }
  function onMarkClick(e) {
    const uid = e.target.dataset.uid;
    const remarkInput = document.querySelector(`.remark-input[data-uid="${cssEscape(uid)}"]`);
    const remark = remarkInput ? remarkInput.value : '';
    const ts = formatTimestamp(new Date());
    const payload = { id: uid, action: 'mark', remark: remark, timestamp: ts };
    showSpinner();
    postToGAS(payload).then(resp => {
      if (resp.success) {
        alert('Complain marked successfully!');
        const rowEl = e.target.closest('tr');
        rowEl.style.transition = 'opacity 1.2s ease, height 1.2s ease';
        rowEl.style.opacity = '0';
        setTimeout(() => rowEl.remove(), 1200); // Remove after fade
      } else {
        alert('Failed to mark complain: ' + (resp.error || 'Unknown error'));
      }
    }).catch(err => {
      alert('Error marking complain: ' + err.message);
    }).finally(() => hideSpinner());
  }
  function onRemoveClick(e) {
    const uid = e.target.dataset.uid;
    const payload = { id: uid, action: 'remove' };
    showSpinner();
    postToGAS(payload).then(resp => {
      if (resp.success) {
        alert('Complain removed successfully!');
        const rowEl = e.target.closest('tr');
        rowEl.style.transition = 'opacity 1.2s ease, height 1.2s ease';
        rowEl.style.opacity = '0';
        setTimeout(() => rowEl.remove(), 1200); // Remove after fade
      } else {
        alert('Failed to remove complain: ' + (resp.error || 'Unknown error'));
      }
    }).catch(err => {
      alert('Error removing complain: ' + err.message);
    }).finally(() => hideSpinner());
  }
  function formatTimestamp(d) {
    const M = d.getMonth() + 1;
    const D = d.getDate();
    const Y = d.getFullYear();
    const H = d.getHours();
    const m = String(d.getMinutes()).padStart(2, '0');
    const s = String(d.getSeconds()).padStart(2, '0');
    return `${M}/${D}/${Y} ${H}:${m}:${s}`;
  }
  // CSV download
  document.getElementById('btnDownloadCsv').addEventListener('click', () => {
    const rows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
    const csv = [];
    csv.push(['PON', 'UserID', 'Mobile', 'Name', 'Mac', 'Serial', 'Down time', 'Remark', 'Location', 'Procare'].join(','));
    rows.forEach(tr => {
      const tds = tr.querySelectorAll('td');
      const pon = tds[0].innerText.trim();
      const uid = tds[1].innerText.trim();
      const mobile = tds[2].innerText.trim();
      const name = tds[3].innerText.trim();
      const mac = tds[4].innerText.split('\n')[0].trim();
      const serial = tds[4].querySelector('small') ? tds[4].querySelector('small').innerText.trim() : '';
      const drops = tds[5].innerText.trim();
      const remark = tds[6].querySelector('input') ? tds[6].querySelector('input').value.replace(/\n/g, ' ') : '';
      const location = tds[8].innerText.trim();
      const procare = tds[9].innerText.trim();
      csv.push([escapeCsv(pon), escapeCsv(uid), escapeCsv(mobile), escapeCsv(name), escapeCsv(mac), escapeCsv(serial), escapeCsv(drops), escapeCsv(remark), escapeCsv(location), escapeCsv(procare)].join(','));
    });
    const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'complains.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
  // Screenshot & WhatsApp
  document.getElementById('btnScreenshotWhatsapp').addEventListener('click', async () => {
    showSpinner();
    try {
      const node = document.getElementById('tableWrap');
      const canvas = await html2canvas(node, { scale: 1 });
      const dataUrl = canvas.toDataURL('image/png');
      try {
        if (navigator.canShare && typeof navigator.canShare === 'function') {
          const blob = await (await fetch(dataUrl)).blob();
          if (navigator.canShare({ files: [new File([blob], 'screenshot.png', { type: 'image/png' })] })) {
            await navigator.share({ files: [new File([blob], 'screenshot.png', { type: 'image/png' })], text: 'Complain Manager screenshot' });
            hideSpinner();
            return;
          }
        }
      } catch (shareErr) { console.warn('Native share not available or failed:', shareErr); }
      const w = window.open('about:blank', '_blank');
      if (w) {
        w.document.write(`<title>Screenshot</title><img src="${dataUrl}" style="max-width:100%"><p><a id=dl href="${dataUrl}" download="screenshot.png">Download image</a> - then share via WhatsApp Web or Mobile</p>`);
      } else {
        alert('Popup blocked. Please allow popups for this site to view the screenshot.');
      }
    } catch (err) { console.error('Screenshot failed:', err); alert('Screenshot failed: ' + err.message); }
    hideSpinner();
  });
  // Sorting toggles
  document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.dataset.key;
      if (currentSort.key === key) currentSort.asc = !currentSort.asc; else { currentSort.key = key; currentSort.asc = true; }
      renderTable();
    });
  });
  // Helper utils
  function escapeHtml(s) { if (s == null) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
  function cssEscape(s) { return String(s).replace(/(["'\\])/g, '\\$1'); }
  function escapeCsv(s) { if (s == null) return '""'; s = String(s).replace(/"/g, '""'); return '"' + s + '"'; }
  // Initialize
  fetchData();
  document.getElementById('btnComplains').addEventListener('click', () => { showSpinner(); setTimeout(() => { applyFilterComplains(); hideSpinner(); }, 300); });
  document.getElementById('btnOffline').addEventListener('click', () => { showSpinner(); setTimeout(() => { applyQuickFilterOffline(); hideSpinner(); }, 300); });
  document.getElementById('btnDrops').addEventListener('click', () => { showSpinner(); setTimeout(() => { applyFilterDrops(); hideSpinner(); }, 300); });
  selWindow.addEventListener('change', () => { fillPonOptions(selWindow.value); applyAllFilters(); });
  selPon.addEventListener('change', applyAllFilters);
  selTimeFilter.addEventListener('change', applyAllFilters);
  document.getElementById('searchUser').addEventListener('input', () => { if (document.getElementById('searchUser').value.length >= 3) applyAllFilters(); });
  document.getElementById('searchMobile').addEventListener('input', () => { if (document.getElementById('searchMobile').value.length >= 3) applyAllFilters(); });
  document.getElementById('searchName').addEventListener('input', () => { if (document.getElementById('searchName').value.length >= 3) applyAllFilters(); });
  document.getElementById('searchMac').addEventListener('input', () => { if (document.getElementById('searchMac').value.length >= 3) applyAllFilters(); });
  </script>
</body>
</html>
