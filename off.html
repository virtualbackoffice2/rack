<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Complain Manager</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Minimal inline styles required for functionality (styling will be moved to styles.css later) */
    body{font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:18px}
    h1{font-size:24px;margin-bottom:10px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    button{padding:8px 10px;border:1px solid #ccc;background:#f7f7f7;border-radius:6px;cursor:pointer}
    select,input{padding:6px;border:1px solid #ccc;border-radius:6px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e5e5e5;padding:8px;text-align:left}
    th.sortable{cursor:pointer}
    tr.offline{background:#ffeef0} /* light pink */
    tr.ticket{background:#ffe5e5} /* more red tint for tickets */
    .spinner-overlay{position:fixed;inset:0;background:rgba(255,255,255,0.7);display:none;align-items:center;justify-content:center;z-index:9999}
    .spinner{width:64px;height:64px;border-radius:50%;border:8px solid #eee;border-top-color:#666;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .count-badge{font-weight:600;margin-left:8px}
    .small-btn{padding:6px 8px;font-size:13px}
    .fade-out{transition:opacity 0.8s ease,height 0.8s ease;margin:0;padding:0}
    .remark-input{width:95%}
    .icon-btn{border:none;background:transparent;cursor:pointer;font-size:16px;margin-left:6px}
    .top-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .disabled{opacity:0.6;pointer-events:none}
  </style>
  <!-- html2canvas for screenshot functionality -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <h1>Complain Manager</h1>

  <div class="top-row">
    <div class="controls">
      <button id="btnComplains">A - Complains</button>
      <button id="btnOffline">B - Offline users</button>
      <button id="btnDrops">C - Drop users</button>
      <button id="btnDownloadCsv">D - Download CSV</button>
      <button id="btnScreenshotWhatsapp">E - Screenshot & share to WhatsApp</button>
    </div>

    <div style="margin-left:10px">Selected count: <span id="selectedCount">0</span></div>
  </div>

  <div class="filters" style="margin-top:12px">
    <label>Window: <select id="selWindow"><option value="">-- All --</option></select></label>
    <label>PON: <select id="selPon"><option value="">-- All --</option></select></label>

    <label>User ID: <input id="searchUser" placeholder="User ID (Users)"></label>
    <label>Mobile no: <input id="searchMobile" placeholder="Number or Last called no"></label>
    <label>Name: <input id="searchName" placeholder="Name"></label>
    <label>Mac/Serial: <input id="searchMac" placeholder="MAC or Serial"></label>
    <label>Time filter (Drops): <select id="selTimeFilter"><option value="">--All--</option></select></label>
    <button id="btnApplyFilters" class="small-btn">Apply</button>
    <button id="btnClearFilters" class="small-btn">Clear</button>
  </div>

  <div id="tableWrap">
    <table id="dataTable">
      <thead>
        <tr>
          <th><input type="checkbox" id="chkAll"></th>
          <th class="sortable" data-key="NMID">PON No ▲▼</th>
          <th class="sortable" data-key="Users">User ID</th>
          <th>Mobile No</th>
          <th>Name</th>
          <th>Mac / Serial</th>
          <th class="sortable" data-key="Drops">Down time ▲▼</th>
          <th>Remark</th>
          <th>Actions</th>
          <th>Location</th>
          <th>Procare</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="spinner-overlay" id="spinnerOverlay"><div class="spinner"></div></div>

  <script>
  // --- CONFIG: update these to your deployed GAS endpoint & token ---
  const GAS_URL = "https://script.google.com/macros/s/AKfycbz-FZM6fwvv0ruaSv-PbEG8sHNOmldJn6kXtRY6e7NZ9YlN3TJ5Oe9ECMwmGBTK-LMTnA/exec";
  const TOKEN = "abcd1234";
  // ---------------------------------------------------------------

  let rawRows = []; // rows from GAS
  let filtered = []; // currently loaded rows
  let selected = new Set();
  let currentSort = { key: null, asc: true };

  const spinner = document.getElementById('spinnerOverlay');
  const tbody = document.querySelector('#dataTable tbody');
  const selWindow = document.getElementById('selWindow');
  const selPon = document.getElementById('selPon');
  const selTimeFilter = document.getElementById('selTimeFilter');

  function showSpinner() { spinner.style.display = 'flex'; document.body.classList.add('disabled'); }
  function hideSpinner() { spinner.style.display = 'none'; document.body.classList.remove('disabled'); }

  // -----------------------------
  // JSONP GET helper (avoids CORS issues for reads)
  // -----------------------------
  function jsonpGet(url, timeoutMs = 10000) {
    return new Promise((resolve, reject) => {
      const callbackName = '__onGAS_' + Math.random().toString(36).slice(2);
      // attach callback to window
      window[callbackName] = function(data) {
        cleanup();
        resolve(data);
      };

      const script = document.createElement('script');
      const sep = url.indexOf('?') === -1 ? '?' : '&';
      script.src = url + sep + 'callback=' + callbackName + '&_=' + Date.now();
      script.async = true;

      let timedOut = false;
      const timer = setTimeout(() => {
        timedOut = true;
        cleanup();
        reject(new Error('JSONP request timed out'));
      }, timeoutMs);

      function cleanup(){
        clearTimeout(timer);
        try{ delete window[callbackName]; } catch(e){ window[callbackName] = undefined; }
        if(script.parentNode) script.parentNode.removeChild(script);
      }

      script.onerror = function(e){ if(timedOut) return; cleanup(); reject(new Error('JSONP script error')); };

      document.head.appendChild(script);
    });
  }

  function fetchData() {
    showSpinner();
    // Use JSONP to avoid CORS failures when calling the Apps Script webapp (doGet supports callback param)
    const url = GAS_URL + '?token=' + encodeURIComponent(TOKEN);
    jsonpGet(url, 12000).then(data => {
      rawRows = data && data.rows ? data.rows : [];
      populateWindowPon();
      // default: show all offline users
      applyQuickFilterOffline();
    }).catch(err => {
      console.error('Failed to fetch via JSONP:', err);
      // as a last resort, try a normal fetch (may still fail due to CORS)
      return fetch(url).then(r=>r.json()).then(data=>{
        rawRows = data && data.rows ? data.rows : [];
        populateWindowPon();
        applyQuickFilterOffline();
      }).catch(err2=>{
        console.error('Fallback fetch failed:', err2);
        alert('Unable to load data from server (CORS or network error).\nSee console for details.');
      });
    }).finally(()=>hideSpinner());
  }

  // -----------------------------
  // POST helper: try normal POST first; if CORS blocks, fall back to a no-cors fire-and-forget POST
  // This preserves functionality in most environments. If you need a guaranteed response body, add CORS headers server-side.
  // -----------------------------
  function postToGAS(obj){
    const url = GAS_URL + '?token=' + encodeURIComponent(TOKEN);
    const json = JSON.stringify(obj);

    // Try a standard POST (this may fail with TypeError if server doesn't allow CORS)
    return fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: json
    }).then(r => {
      // If server responds normally, attempt to parse JSON; if parsing fails, still treat as success
      if (r.ok) return r.json().catch(()=>({ success: true }));
      throw new Error('Server responded with status ' + r.status);
    }).catch(err => {
      console.warn('Standard POST failed (likely CORS). Falling back to no-cors fire-and-forget POST.', err);
      // Fire-and-forget no-cors POST: the request will be sent but response will be opaque and unreadable.
      return fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain' },
        body: json
      }).then(() => ({ success: true, fallback: true }))
        .catch(e => ({ error: e && e.message ? e.message : String(e) }));
    });
  }

  function populateWindowPon(){
    const windows = new Set();
    const ponsForWindow = {};
    rawRows.forEach(r => {
      const win = r['Window'] || r['window'] || r['A'] || '';
      const pon = r['NMID'] || r['nmID'] || r['C'] || '';
      windows.add(win);
      if(!ponsForWindow[win]) ponsForWindow[win] = new Set();
      if(pon) ponsForWindow[win].add(pon);
    });
    // fill window
    selWindow.innerHTML = '<option value="">-- All --</option>' + Array.from(windows).sort().map(w=>`<option value="${escapeHtml(w)}">${escapeHtml(w)}</option>`).join('');
    // store pons map on element for later
    selWindow._ponsMap = ponsForWindow;
    // set PON options to all by default
    fillPonOptions('');
  }

  function fillPonOptions(windowName){
    const map = selWindow._ponsMap || {};
    const set = windowName ? (map[windowName]||new Set()) : new Set(Object.values(map).flatMap(s=>Array.from(s)));
    const opts = Array.from(set).sort().map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
    selPon.innerHTML = '<option value="">-- All --</option>' + opts;
  }

  function applyQuickFilterOffline(){
    // show rows where Downs (col T) has any value
    filtered = rawRows.filter(r => {
      const val = (r['Downs'] || r['T'] || '').toString().trim();
      return val !== '';
    });
    renderTable();
    populateTimeFilter();
  }

  function applyFilterComplains(){
    filtered = rawRows.filter(r => {
      const val = (r['Ticket'] || r['X'] || '').toString().trim();
      return val !== '';
    });
    renderTable();
    populateTimeFilter();
  }

  function applyFilterDrops(){
    filtered = rawRows.filter(r => {
      const val = (r['Drops'] || r['AB'] || '').toString().trim();
      return val !== '';
    });
    renderTable();
    populateTimeFilter();
  }

  function applyAllFilters(){
    const win = selWindow.value;
    const pon = selPon.value;
    const userId = document.getElementById('searchUser').value.trim().toLowerCase();
    const mobile = document.getElementById('searchMobile').value.trim().toLowerCase();
    const name = document.getElementById('searchName').value.trim().toLowerCase();
    const mac = document.getElementById('searchMac').value.trim().toLowerCase();
    const timeSel = selTimeFilter.value;

    filtered = rawRows.filter(r=>{
      if(win){ const v = (r['Window']||r['window']||'').toString(); if(v!==win) return false }
      if(pon){ const v = (r['NMID']||r['C']||'').toString(); if(v!==pon) return false }
      if(userId){ const v = (r['Users']||r['N']||'').toString().toLowerCase(); if(!v.includes(userId)) return false }
      if(mobile){ const v1 = (r['Last called no']||r['AC']||'').toString().toLowerCase(); const v2 = (r['Number']||r['P']||'').toString().toLowerCase(); if(!v1.includes(mobile) && !v2.includes(mobile)) return false }
      if(name){ const v = (r['Name']||r['O']||'').toString().toLowerCase(); if(!v.includes(name)) return false }
      if(mac){ const v1 = (r['MAC']||r['U']||'').toString().toLowerCase(); const v2 = (r['Serial']||r['V']||'').toString().toLowerCase(); if(!v1.includes(mac) && !v2.includes(mac)) return false }
      if(timeSel){ const v = (r['Drops']||r['AB']||'').toString(); if(v!==timeSel) return false }
      return true;
    });
    renderTable();
  }

  function populateTimeFilter(){
    const times = new Set();
    filtered.forEach(r=>{ const v = (r['Drops']||r['AB']||'').toString(); if(v) times.add(v); });
    selTimeFilter.innerHTML = '<option value="">--All--</option>' + Array.from(times).sort().map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
  }

  function renderTable(){
    tbody.innerHTML = '';
    selected.clear();
    document.getElementById('selectedCount').innerText = '0';

    let rowsToRender = filtered.slice();
    // sorting if set
    if(currentSort.key){
      rowsToRender.sort((a,b)=>{
        const ka = (a[currentSort.key]||a[keyOrAlt(a,currentSort.key)]||'').toString();
        const kb = (b[currentSort.key]||b[keyOrAlt(b,currentSort.key)]||'').toString();
        if(ka<kb) return currentSort.asc? -1:1;
        if(ka>kb) return currentSort.asc? 1:-1;
        return 0;
      });
    }

    rowsToRender.forEach((r, idx)=>{
      const tr = document.createElement('tr');
      const isOffline = (r['Downs']||r['T']||'').toString().trim() !== '';
      const isTicket = (r['Ticket']||r['X']||'').toString().trim() !== '';
      if(isOffline) tr.classList.add('offline');
      if(isTicket) tr.classList.add('ticket');

      const userId = r['Users']||r['N']||'';
      const pon = r['NMID']||r['C']||'';
      const lastCalled = (r['Last called no']||r['AC']||'').toString().trim();
      const number = (r['Number']||r['P']||'').toString().trim();
      const mobile = lastCalled || number;
      const name = r['Name']||r['O']||'';
      const mac = r['MAC']||r['U']||'';
      const serial = r['Serial']||r['V']||'';
      const drops = r['Drops']||r['AB']||'';
      const remark = r['Remarks']||r['Y']||r['remark']||r['Remark']||'';
      const location = r['Location']||r['Q']||'';
      const procare = r['User status']||r['AF']||'';

      tr.innerHTML = `
        <td><input type="checkbox" class="row-chk" data-uid="${escapeHtml(userId)}"></td>
        <td>${escapeHtml(pon)}</td>
        <td>${escapeHtml(userId)}</td>
        <td>${escapeHtml(mobile)}</td>
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(mac)}<br><small>${escapeHtml(serial)}</small></td>
        <td>${escapeHtml(drops)}</td>
        <td><input class="remark-input" data-uid="${escapeHtml(userId)}" value="${escapeHtml(remark)}"></td>
        <td>
          <button class="small-btn mark-btn" data-uid="${escapeHtml(userId)}">Mark Complain</button>
          <button class="small-btn remove-btn" data-uid="${escapeHtml(userId)}">Remove Complain</button>
        </td>
        <td>${escapeHtml(location)}</td>
        <td>${escapeHtml(procare)}</td>
      `;

      tbody.appendChild(tr);
    });

    // attach events
    document.querySelectorAll('.row-chk').forEach(el=>el.addEventListener('change', onRowCheck));
    document.getElementById('chkAll').checked = false;
    document.querySelectorAll('.mark-btn').forEach(b=>b.addEventListener('click', onMarkClick));
    document.querySelectorAll('.remove-btn').forEach(b=>b.addEventListener('click', onRemoveClick));
    document.querySelectorAll('.remark-input').forEach(i=>i.addEventListener('change', onRemarkChange));
  }

  function keyOrAlt(obj,key){ // helper for varying header names
    const map = { 'NMID':'C','Users':'N','Drops':'AB' };
    return map[key] || key;
  }

  function onRowCheck(e){
    const uid = e.target.dataset.uid;
    if(e.target.checked) selected.add(uid); else selected.delete(uid);
    document.getElementById('selectedCount').innerText = selected.size;
  }

  document.getElementById('chkAll').addEventListener('change', function(){
    const checked = this.checked;
    document.querySelectorAll('.row-chk').forEach(ch=>{ ch.checked = checked; const uid = ch.dataset.uid; if(checked) selected.add(uid); else selected.delete(uid); });
    document.getElementById('selectedCount').innerText = selected.size;
  });

  document.getElementById('btnComplains').addEventListener('click', ()=>{ showSpinner(); setTimeout(()=>{ applyFilterComplains(); hideSpinner(); }, 300); });
  document.getElementById('btnOffline').addEventListener('click', ()=>{ showSpinner(); setTimeout(()=>{ applyQuickFilterOffline(); hideSpinner(); }, 300); });
  document.getElementById('btnDrops').addEventListener('click', ()=>{ showSpinner(); setTimeout(()=>{ applyFilterDrops(); hideSpinner(); }, 300); });

  document.getElementById('btnApplyFilters').addEventListener('click', applyAllFilters);
  document.getElementById('btnClearFilters').addEventListener('click', ()=>{ document.getElementById('searchUser').value=''; document.getElementById('searchMobile').value=''; document.getElementById('searchName').value=''; document.getElementById('searchMac').value=''; selWindow.value=''; fillPonOptions(''); selPon.value=''; selTimeFilter.value=''; applyAllFilters(); });

  selWindow.addEventListener('change', ()=>{ fillPonOptions(selWindow.value); });
  selPon.addEventListener('change', ()=>{ /* optionally auto-apply */ });

  function onRemarkChange(e){
    // no auto-save here; saved when marking complain
  }

  function onMarkClick(e){
    const uid = e.target.dataset.uid;
    const remarkInput = document.querySelector(`.remark-input[data-uid=\"${cssEscape(uid)}\"]`);
    const remark = remarkInput ? remarkInput.value : '';
    const ts = formatTimestamp(new Date());
    // prepare payload
    const payload = { id: uid, action: 'mark', remark: remark, timestamp: ts };
    // show 5s spinner and disable page
    showSpinner();
    // call doPost
    postToGAS(payload).then(resp=>{
      // animate removal of the row slowly
      const rowEl = e.target.closest('tr');
      rowEl.style.transition = 'opacity 1.2s ease, height 1.2s ease';
      rowEl.style.opacity = '0';
      setTimeout(()=>{ rowEl.remove(); hideSpinner(); }, 5000); // keep page spinner for 5s then remove row and hide
    }).catch(err=>{ hideSpinner(); alert('Error: '+err.message); });
  }

  function onRemoveClick(e){
    const uid = e.target.dataset.uid;
    const payload = { id: uid, action: 'remove' };
    showSpinner();
    postToGAS(payload).then(()=>{
      const rowEl = e.target.closest('tr');
      rowEl.style.transition = 'opacity 1.2s ease, height 1.2s ease';
      rowEl.style.opacity = '0';
      setTimeout(()=>{ rowEl.remove(); hideSpinner(); }, 5000);
    }).catch(err=>{ hideSpinner(); alert('Error: '+err.message); });
  }

  function formatTimestamp(d){
    // format: M/D/YYYY H:MM:SS like 9/24/2025 3:11:01
    const M = d.getMonth()+1;
    const D = d.getDate();
    const Y = d.getFullYear();
    const H = d.getHours();
    const m = String(d.getMinutes()).padStart(2,'0');
    const s = String(d.getSeconds()).padStart(2,'0');
    return `${M}/${D}/${Y} ${H}:${m}:${s}`;
  }

  // CSV download
  document.getElementById('btnDownloadCsv').addEventListener('click', ()=>{
    const rows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
    const csv = [];
    csv.push(['PON','UserID','Mobile','Name','Mac','Serial','Down time','Remark','Location','Procare'].join(','));
    rows.forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      const pon = tds[1].innerText.trim();
      const uid = tds[2].innerText.trim();
      const mobile = tds[3].innerText.trim();
      const name = tds[4].innerText.trim();
      const mac = tds[5].innerText.split('\n')[0].trim();
      const serial = tds[5].querySelector('small') ? tds[5].querySelector('small').innerText.trim() : '';
      const drops = tds[6].innerText.trim();
      const remark = tds[7].querySelector('input') ? tds[7].querySelector('input').value.replace(/\n/g,' ') : '';
      const location = tds[9].innerText.trim();
      const procare = tds[10].innerText.trim();
      csv.push([escapeCsv(pon),escapeCsv(uid),escapeCsv(mobile),escapeCsv(name),escapeCsv(mac),escapeCsv(serial),escapeCsv(drops),escapeCsv(remark),escapeCsv(location),escapeCsv(procare)].join(','));
    });
    const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'complains.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  // Screenshot & WhatsApp
  document.getElementById('btnScreenshotWhatsapp').addEventListener('click', async ()=>{
    showSpinner();
    try{
      const node = document.getElementById('tableWrap');
      const canvas = await html2canvas(node, { scale: 1 });
      const dataUrl = canvas.toDataURL('image/png');
      // try native share (best-effort)
      try{
        if(navigator.canShare && typeof navigator.canShare === 'function'){
          const blob = await (await fetch(dataUrl)).blob();
          if(navigator.canShare({ files: [new File([blob],'screenshot.png',{type:'image/png'})] })){
            await navigator.share({ files: [new File([blob],'screenshot.png',{type:'image/png'})], text: 'Complain Manager screenshot' });
            hideSpinner();
            return;
          }
        }
      }catch(shareErr){ console.warn('Native share not available or failed:', shareErr); }

      // fallback: open image in new tab so user can save and share manually
      const w = window.open('about:blank','_blank');
      if(w){
        w.document.write(`<title>Screenshot</title><img src="${dataUrl}" style="max-width:100%"><p><a id=dl href="${dataUrl}" download="screenshot.png">Download image</a> - then share via WhatsApp Web or Mobile</p>`);
      } else {
        alert('Popup blocked. Please allow popups for this site to view the screenshot.');
      }
    }catch(err){ console.error('Screenshot failed:', err); alert('Screenshot failed: '+err.message); }
    hideSpinner();
  });

  // Sorting toggles
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.dataset.key;
      if(currentSort.key === key) currentSort.asc = !currentSort.asc; else { currentSort.key = key; currentSort.asc = true; }
      renderTable();
    });
  });

  // helper utils
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function cssEscape(s){ return String(s).replace(/(["'\\])/g,'\\$1'); }
  function escapeCsv(s){ if(s==null) return '""'; s = String(s).replace(/"/g,'""'); return '"'+s+'"'; }

  // initialize
  fetchData();

  // utility: populateTimeFilter after data loaded
  function populateTimeFilter(){
    const times = new Set();
    filtered.forEach(r=>{ const v = (r['Drops']||r['AB']||'').toString(); if(v) times.add(v); });
    selTimeFilter.innerHTML = '<option value="">--All--</option>' + Array.from(times).sort().map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
  }

  </script>
</body>
</html>
