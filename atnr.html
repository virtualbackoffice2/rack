<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Employee Attendance System</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    .header {
      text-align: center;
      color: #667eea;
      margin-bottom: 25px;
    }
    .header h1 { margin: 0; font-size: 28px; font-weight: 700; }
    .header p { margin: 5px 0 0; color: #666; font-size: 18px; font-weight: 600; }
    input[type="date"] {
      display: block;
      width: 100%;
      margin: 12px 0;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      font-family: inherit;
    }
    input[type="date"]:focus {
      outline: none;
      border-color: #667eea;
    }
    label {
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 4px;
      display: block;
    }
    .filter-group {
      margin: 15px 0;
      padding: 15px;
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }
    .checkbox-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    .checkbox-item input {
      margin: 0;
    }
    .select-all {
      font-weight: 600;
      color: #667eea;
      cursor: pointer;
      text-decoration: underline;
      margin-left: 10px;
      font-size: 13px;
    }
    #attendanceTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #attendanceTable th, #attendanceTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    #attendanceTable th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    button.edit-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 2px 6px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 900px;
      border-radius: 10px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    #editTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    #editTable th, #editTable td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 14px;
    }
    #editTable input {
      width: 100%;
      border: none;
      padding: 6px;
      font-size: 14px;
      background: transparent;
    }
    #editTable input:focus {
      outline: 2px solid #667eea;
      background: #f0f7ff;
    }
    #toast {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #48bb78;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 2000;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1>All Attendance</h1>
      <p>Merotra Cable Network</p>
    </div>

    <div class="filter-group">
      <label for="startDate">Start Date:</label>
      <input type="date" id="startDate">
    </div>

    <div class="filter-group">
      <label for="endDate">End Date:</label>
      <input type="date" id="endDate">
    </div>

    <div class="filter-group">
      <label>Select Emails:</label>
      <div class="checkbox-container" id="emailCheckboxes"></div>
      <div>
        <span class="select-all" id="selectAllEmails">Select All</span> | 
        <span class="select-all" id="deselectAllEmails">Deselect All</span>
      </div>
    </div>

    <div class="filter-group">
      <label>Select Attendance Types:</label>
      <div class="checkbox-container" id="attendanceCheckboxes">
        <div class="checkbox-item">
          <input type="checkbox" id="attAll" value="All" checked>
          <label for="attAll">All</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="attFull" value="Full day">
          <label for="attFull">Full day</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="attLate" value="Late">
          <label for="attLate">Late</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="attHalf" value="Half day">
          <label for="attHalf">Half day</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="attOff" value="Off">
          <label for="attOff">Off</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="attIncomplete" value="Incomplete attendance">
          <label for="attIncomplete">Incomplete</label>
        </div>
      </div>
      <div>
        <span class="select-all" id="selectAllAtt">Select All</span> | 
        <span class="select-all" id="deselectAllAtt">Deselect All</span>
      </div>
    </div>

    <div id="loadingMessage" class="loading">Loading attendance data...</div>

    <table id="attendanceTable" style="display:none;">
      <thead>
        <tr>
          <th>Edit</th>
          <th>Sr.</th>
          <th>Date</th>
          <th>Email</th>
          <th>Duty Start</th>
          <th>Lunch Start</th>
          <th>Lunch Done</th>
          <th>Duty Off</th>
          <th>Attendance</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close">x</span>
      <h2>Edit Attendance: <span id="editDate"></span> - <span id="editEmail"></span></h2>
      <table id="editTable">
        <thead>
          <tr>
            <th>Row #</th>
            <th>Timestamp</th>
            <th>Status</th>
            <th>Remarks</th>
            <th>Selfie URL</th>
            <th>Bike URL</th>
            <th>Location</th>
            <th>Verification</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="toast">Attendance modified!</div>

  <script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykf97Wp9J6fPP_LcpzDy1MhfjlbRJIawIXXuW_zmzbx5f9wstjcTL98DlgiEl4rIhj/exec";
  let allData = [];
  let uniqueEmails = new Set();

  const elements = {
    startDate: document.getElementById('startDate'),
    endDate: document.getElementById('endDate'),
    emailCheckboxes: document.getElementById('emailCheckboxes'),
    attendanceCheckboxes: document.getElementById('attendanceCheckboxes'),
    selectAllEmails: document.getElementById('selectAllEmails'),
    deselectAllEmails: document.getElementById('deselectAllEmails'),
    selectAllAtt: document.getElementById('selectAllAtt'),
    deselectAllAtt: document.getElementById('deselectAllAtt'),
    loadingMessage: document.getElementById('loadingMessage'),
    attendanceTable: document.getElementById('attendanceTable'),
    tbody: document.getElementById('attendanceTable').querySelector('tbody'),
    editModal: document.getElementById('editModal'),
    editClose: document.querySelector('#editModal .close'),
    editDate: document.getElementById('editDate'),
    editEmail: document.getElementById('editEmail'),
    editTbody: document.getElementById('editTable').querySelector('tbody'),
    toast: document.getElementById('toast')
  };

  /* ----------  MODAL & TOAST ---------- */
  elements.editClose.onclick = () => { elements.editModal.style.display = 'none'; };
  window.onclick = e => { if (e.target === elements.editModal) elements.editModal.style.display = 'none'; };
  function showToast() {
    elements.toast.style.display = 'block';
    setTimeout(() => elements.toast.style.display = 'none', 3000);
  }

  /* ----------  SELECT ALL / DESELECT ALL ---------- */
  elements.selectAllEmails.onclick = () => { document.querySelectorAll('#emailCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = true); renderTable(); };
  elements.deselectAllEmails.onclick = () => { document.querySelectorAll('#emailCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false); renderTable(); };
  elements.selectAllAtt.onclick = () => { document.querySelectorAll('#attendanceCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = true); renderTable(); };
  elements.deselectAllAtt.onclick = () => { document.querySelectorAll('#attendanceCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false); renderTable(); };

  /* ----------  FETCH ALL DATA ---------- */
  async function fetchData() {
    elements.loadingMessage.style.display = 'block';
    elements.attendanceTable.style.display = 'none';

    const resp = await fetch(`${SCRIPT_URL}?action=getAllAttendance`);
    allData = await resp.json();

    uniqueEmails = new Set();
    allData.forEach(r => uniqueEmails.add(r[1].trim()));

    // ---- email checkboxes ----
    elements.emailCheckboxes.innerHTML = '';
    Array.from(uniqueEmails).sort().forEach(email => {
      const div = document.createElement('div');
      div.className = 'checkbox-item';
      div.innerHTML = `<input type="checkbox" id="e_${email}" value="${email}" checked><label for="e_${email}">${email}</label>`;
      elements.emailCheckboxes.appendChild(div);
    });

    document.querySelectorAll('#emailCheckboxes input, #attendanceCheckboxes input')
            .forEach(cb => cb.addEventListener('change', renderTable));

    renderTable();
  }

  /* ----------  RENDER MAIN TABLE ---------- */
  function renderTable() {
    const s = elements.startDate.value, e = elements.endDate.value;
    if (!s || !e) return;
    const start = new Date(s), end = new Date(e);
    if (start > end) return;

    const selEmails = Array.from(document.querySelectorAll('#emailCheckboxes input:checked')).map(cb => cb.value);
    if (!selEmails.length) { elements.tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#999;">No employees selected.</td></tr>'; elements.attendanceTable.style.display='table'; elements.loadingMessage.style.display='none'; return; }

    const selAtt = Array.from(document.querySelectorAll('#attendanceCheckboxes input:checked')).map(cb => cb.value);
    const allAtt = selAtt.includes('All') || selAtt.length===0;

    // ---- group by email → date ----
    const groups = new Map();               // email → Map(dateKey → groupObj)
    allData.forEach(row => {
      const [tsStr, email, status] = row;
      const ts = new Date(tsStr);
      if (ts < start || ts > end) return;
      const key = ts.toLocaleDateString('en-US',{month:'short',day:'numeric'});
      if (!groups.has(email)) groups.set(email, new Map());
      const dayMap = groups.get(email);
      if (!dayMap.has(key)) dayMap.set(key, {dutyStart:null,lunchStart:null,lunchDone:null,dutyOff:null,tsMap:new Map(),raw:[]});
      const g = dayMap.get(key);
      const time = ts.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:false});
      if (status==='Duty start') g.dutyStart = time;
      if (status==='Lunch start') g.lunchStart = time;
      if (status==='Lunch done') g.lunchDone = time;
      if (status==='Duty off') g.dutyOff = time;
      g.tsMap.set(status, ts);
      g.raw.push(row);
    });

    // ---- date list (latest first) ----
    const dates = [];
    let cur = new Date(end);
    while (cur >= start) { dates.push(cur.toLocaleDateString('en-US',{month:'short',day:'numeric'})); cur.setDate(cur.getDate()-1); }

    // ---- build rows ----
    const rows = [];
    selEmails.forEach(email => {
      dates.forEach(d => {
        const dayMap = groups.get(email) || new Map();
        const g = dayMap.get(d) || {dutyStart:'--',lunchStart:'--',lunchDone:'--',dutyOff:'--',tsMap:new Map(),raw:[]};
        const att = computeAttendance(g);
        if (allAtt || selAtt.includes(att)) rows.push({email, date:d, dutyStart:g.dutyStart, lunchStart:g.lunchStart, lunchDone:g.lunchDone, dutyOff:g.dutyOff, attendance:att, raw:g.raw});
      });
    });

    // ---- render ----
    elements.tbody.innerHTML = '';
    if (!rows.length) elements.tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#999;">No records found.</td></tr>';
    else rows.forEach((r,i) => {
      const editBtn = r.raw.length ? `<button class="edit-btn" onclick="openEditModal('${r.email}','${r.date}',${JSON.stringify(r.raw).replace(/'/g,"\\'")})">Edit</button>` : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${editBtn}</td><td>${i+1}</td><td>${r.date}</td><td>${r.email}</td><td>${r.dutyStart}</td><td>${r.lunchStart}</td><td>${r.lunchDone}</td><td>${r.dutyOff}</td><td>${r.attendance}</td>`;
      elements.tbody.appendChild(tr);
    });

    elements.attendanceTable.style.display='table';
    elements.loadingMessage.style.display='none';
  }

  /* ----------  COMPUTE ATTENDANCE ---------- */
  function computeAttendance(g){
    const h=(s)=>g.tsMap.has(s), get=(s)=>g.tsMap.get(s);
    if(!h('Duty start')&&!h('Duty off')&&!h('Lunch start')&&!h('Lunch done')) return 'Off';
    if((h('Duty start')&&!h('Duty off'))||(!h('Duty start')&&h('Duty off'))) return 'Incomplete attendance';
    if((h('Lunch start')&&!h('Lunch done'))||(!h('Lunch start')&&h('Lunch done'))) return 'Incomplete attendance';
    let hrs = (get('Duty off')-get('Duty start'))/3600000;
    if(h('Lunch start')&&h('Lunch done')) hrs -= (get('Lunch done')-get('Lunch start'))/3600000;
    if(hrs<=0) return 'Off';
    if(hrs>=8.5) return 'Full day';
    if(hrs>=7.5) return 'Late';
    return 'Half day';
  }

  /* ----------  OPEN EDIT MODAL (global) ---------- */
  window.openEditModal = function(email, date, rawRows){
    elements.editDate.textContent = date;
    elements.editEmail.textContent = email;
    elements.editTbody.innerHTML = '';

    rawRows.forEach(r => {
      const [ts, name, status, remarks, selfie, bike, loc, verif, rowIdx] = r;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${rowIdx}</td>
        <td><input type="text" value="${ts}" data-row="${rowIdx}" data-field="timestamp"></td>
        <td><input type="text" value="${status}" data-row="${rowIdx}" data-field="status"></td>
        <td><input type="text" value="${remarks}" data-row="${rowIdx}" data-field="remarks"></td>
        <td><input type="text" value="${selfie}" data-row="${rowIdx}" data-field="selfieUrl"></td>
        <td><input type="text" value="${bike}" data-row="${rowIdx}" data-field="bikeUrl"></td>
        <td><input type="text" value="${loc}" data-row="${rowIdx}" data-field="location"></td>
        <td><input type="text" value="${verif}" data-row="${rowIdx}" data-field="verificationMessage"></td>
      `;
      elements.editTbody.appendChild(tr);
    });

    // attach blur handler once per input
    elements.editTbody.querySelectorAll('input').forEach(inp => {
      inp.removeEventListener('blur', handleBlur);   // avoid duplicates
      inp.addEventListener('blur', handleBlur);
    });

    elements.editModal.style.display = 'flex';
  };

  /* ----------  UPDATE SINGLE ROW (blur) ---------- */
  async function handleBlur(e){
    const inp = e.target;
    const rowIdx = inp.dataset.row;
    const tr = inp.closest('tr');
    const payload = {
      action: 'updateRecord',
      rowIndex: Number(rowIdx),
      name: elements.editEmail.textContent,
      timestamp: tr.querySelector('[data-field="timestamp"]').value,
      status: tr.querySelector('[data-field="status"]').value,
      remarks: tr.querySelector('[data-field="remarks"]').value,
      selfieUrl: tr.querySelector('[data-field="selfieUrl"]').value,
      bikeUrl: tr.querySelector('[data-field="bikeUrl"]').value,
      location: tr.querySelector('[data-field="location"]').value,
      verificationMessage: tr.querySelector('[data-field="verificationMessage"]').value
    };

    try{
      await fetch(SCRIPT_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      showToast();
      await fetchData();               // refresh everything
    }catch(err){
      console.error('Update failed',err);
    }
  }

  /* ----------  INITIAL LOAD ---------- */
  window.onload = async () => {
    const today = new Date();
    const start = new Date(today);
    start.setDate(today.getDate()-29);
    elements.endDate.value = today.toISOString().split('T')[0];
    elements.startDate.value = start.toISOString().split('T')[0];

    elements.startDate.addEventListener('change',renderTable);
    elements.endDate.addEventListener('change',renderTable);

    await fetchData();
  };
</script>
</body>
</html>
