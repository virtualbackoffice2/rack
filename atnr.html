<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Employee Attendance System</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    .header {
      text-align: center;
      color: #667eea;
      margin-bottom: 25px;
    }
    .header h1 { margin: 0; font-size: 28px; font-weight: 700; }
    .header p { margin: 5px 0 0; color: #666; font-size: 18px; font-weight: 600; }
    input[type="date"] {
      display: block;
      width: 100%;
      margin: 12px 0;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      font-family: inherit;
    }
    input[type="date"]:focus {
      outline: none;
      border-color: #667eea;
    }
    label {
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 4px;
      display: block;
    }
    .filter-group {
      margin: 15px 0;
      padding: 15px;
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }
    .checkbox-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    .checkbox-item input {
      margin: 0;
    }
    .select-all {
      font-weight: 600;
      color: #667eea;
      cursor: pointer;
      text-decoration: underline;
      margin-left: 10px;
      font-size: 13px;
    }
    #attendanceTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #attendanceTable th, #attendanceTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    #attendanceTable th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    button.edit-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 2px 6px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 900px;
      border-radius: 10px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    #editTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    #editTable th, #editTable td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 14px;
    }
    #editTable input {
      width: 100%;
      border: none;
      padding: 6px;
      font-size: 14px;
      background: transparent;
    }
    #editTable input:focus {
      outline: 2px solid #667eea;
      background: #f0f7ff;
    }
    #toast {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #48bb78;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 2000;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1>All Attendance</h1>
      <p>Merotra Cable Network</p>
    </div>

    <div class="filter-group">
      <label for="startDate">Start Date:</label>
      <input type="date" id="startDate">
    </div>

    <div class="filter-group">
      <label for="endDate">End Date:</label>
      <input type="date" id="endDate">
    </div>

    <div class="filter-group">
      <label>Select Emails:</label>
      <div class="checkbox-container" id="emailCheckboxes"></div>
      <div>
        <span class="select-all" id="selectAllEmails">Select All</span> | 
        <span class="select-all" id="deselectAllEmails">Deselect All</span>
      </div>
    </div>

    <div class="filter-group">
      <label>Select Attendance Types:</label>
      <div class="checkbox-container" id="attendanceCheckboxes">
        <div class="checkbox-item">
          <input type="checkbox" id="attAll" value="All" checked>
          <label for="attAll">All</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="attFull" value="Full day">
          <label for="attFull">Full day</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="attLate" value="Late">
          <label for="attLate">Late</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="attHalf" value="Half day">
          <label for="attHalf">Half day</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="attOff" value="Off">
          <label for="attOff">Off</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="attIncomplete" value="Incomplete attendance">
          <label for="attIncomplete">Incomplete</label>
        </div>
      </div>
      <div>
        <span class="select-all" id="selectAllAtt">Select All</span> | 
        <span class="select-all" id="deselectAllAtt">Deselect All</span>
      </div>
    </div>

    <div id="loadingMessage" class="loading">Loading attendance data...</div>

    <table id="attendanceTable" style="display:none;">
      <thead>
        <tr>
          <th>Edit</th>
          <th>Sr.</th>
          <th>Date</th>
          <th>Email</th>
          <th>Duty Start</th>
          <th>Lunch Start</th>
          <th>Lunch Done</th>
          <th>Duty Off</th>
          <th>Attendance</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close">x</span>
      <h2>Edit Attendance: <span id="editDate"></span> - <span id="editEmail"></span></h2>
      <table id="editTable">
        <thead>
          <tr>
            <th>Row #</th>
            <th>Timestamp</th>
            <th>Status</th>
            <th>Remarks</th>
            <th>Selfie URL</th>
            <th>Bike URL</th>
            <th>Location</th>
            <th>Verification</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="toast">Attendance modified!</div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykf97Wp9J6fPP_LcpzDy1MhfjlbRJIawIXXuW_zmzbx5f9wstjcTL98DlgiEl4rIhj/exec";
    let allData = [];
    let uniqueEmails = new Set();

    const elements = {
      startDate: document.getElementById('startDate'),
      endDate: document.getElementById('endDate'),
      emailCheckboxes: document.getElementById('emailCheckboxes'),
      attendanceCheckboxes: document.getElementById('attendanceCheckboxes'),
      selectAllEmails: document.getElementById('selectAllEmails'),
      deselectAllEmails: document.getElementById('deselectAllEmails'),
      selectAllAtt: document.getElementById('selectAllAtt'),
      deselectAllAtt: document.getElementById('deselectAllAtt'),
      loadingMessage: document.getElementById('loadingMessage'),
      attendanceTable: document.getElementById('attendanceTable'),
      tbody: document.getElementById('attendanceTable').querySelector('tbody'),
      editModal: document.getElementById('editModal'),
      editClose: document.querySelector('#editModal .close'),
      editDate: document.getElementById('editDate'),
      editEmail: document.getElementById('editEmail'),
      editTbody: document.getElementById('editTable').querySelector('tbody'),
      toast: document.getElementById('toast')
    };

    // Close modal
    elements.editClose.onclick = () => { elements.editModal.style.display = 'none'; };
    window.onclick = (e) => { if (e.target === elements.editModal) elements.editModal.style.display = 'none'; };

    // Select All / Deselect All for Emails
    elements.selectAllEmails.onclick = () => {
      document.querySelectorAll('#emailCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
      renderTable();
    };
    elements.deselectAllEmails.onclick = () => {
      document.querySelectorAll('#emailCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
      renderTable();
    };

    // Select All / Deselect All for Attendance Types
    elements.selectAllAtt.onclick = () => {
      document.querySelectorAll('#attendanceCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
      renderTable();
    };
    elements.deselectAllAtt.onclick = () => {
      document.querySelectorAll('#attendanceCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
      renderTable();
    };

    // Show toast
    function showToast() {
      elements.toast.style.display = 'block';
      setTimeout(() => elements.toast.style.display = 'none', 3000);
    }

    // Fetch all data
    async function fetchData() {
      try {
        elements.loadingMessage.style.display = 'block';
        elements.attendanceTable.style.display = 'none';

        const response = await fetch(`${SCRIPT_URL}?action=getAllAttendance`);
        allData = await response.json();

        // Extract unique emails
        uniqueEmails = new Set();
        allData.forEach(row => uniqueEmails.add(row[1].trim()));

        // Populate email checkboxes
        elements.emailCheckboxes.innerHTML = '';
        Array.from(uniqueEmails).sort().forEach(email => {
          const div = document.createElement('div');
          div.className = 'checkbox-item';
          div.innerHTML = `
            <input type="checkbox" id="email_${email}" value="${email}" checked>
            <label for="email_${email}">${email}</label>
          `;
          elements.emailCheckboxes.appendChild(div);
        });

        // Add event listeners
        document.querySelectorAll('#emailCheckboxes input').forEach(cb => cb.addEventListener('change', renderTable));
        document.querySelectorAll('#attendanceCheckboxes input').forEach(cb => cb.addEventListener('change', renderTable));

        renderTable();
      } catch (err) {
        console.error('Error:', err);
        elements.loadingMessage.textContent = 'Failed to load data. Please try again.';
      }
    }

    // Render table
    function renderTable() {
      const startStr = elements.startDate.value;
      const endStr = elements.endDate.value;
      if (!startStr || !endStr) return;

      const startDate = new Date(startStr);
      const endDate = new Date(endStr);
      if (startDate > endDate) return;

      const selectedEmails = Array.from(document.querySelectorAll('#emailCheckboxes input:checked'))
        .map(cb => cb.value);
      if (selectedEmails.length === 0) {
        elements.tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#999;">No employees selected.</td></tr>';
        elements.attendanceTable.style.display = 'table';
        elements.loadingMessage.style.display = 'none';
        return;
      }

      const selectedAttTypes = Array.from(document.querySelectorAll('#attendanceCheckboxes input:checked'))
        .map(cb => cb.value);
      const includeAllAtt = selectedAttTypes.includes('All') || selectedAttTypes.length === 0;

      // Group data by email and date
      const groupsByEmail = new Map();
      allData.forEach(row => {
        const [ts, email, status, remarks, selfie, bike, loc, verif, rowIndex] = row;
        const dateObj = new Date(ts);
        if (dateObj < startDate || dateObj > endDate) return;
        const dateKey = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        if (!groupsByEmail.has(email)) groupsByEmail.set(email, new Map());
        const emailGroups = groupsByEmail.get(email);
        if (!emailGroups.has(dateKey)) {
          emailGroups.set(dateKey, {
            dutyStart: null, lunchStart: null, lunchDone: null, dutyOff: null,
            tsMap: new Map(), rawRows: []
          });
        }
        const group = emailGroups.get(dateKey);
        const timeStr = dateObj.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: false });

        if (status === 'Duty start') group.dutyStart = timeStr;
        if (status === 'Lunch start') group.lunchStart = timeStr;
        if (status === 'Lunch done') group.lunchDone = timeStr;
        if (status === 'Duty off') group.dutyOff = timeStr;

        group.tsMap.set(status, dateObj);
        group.rawRows.push(row);
      });

      // Generate date list (latest first)
      const dateList = [];
      let current = new Date(endDate);
      while (current >= startDate) {
        dateList.push(current.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        current.setDate(current.getDate() - 1);
      }

      // Build rows
      const rows = [];
      selectedEmails.forEach(email => {
        dateList.forEach(dateKey => {
          const emailGroups = groupsByEmail.get(email) || new Map();
          const group = emailGroups.get(dateKey) || {
            dutyStart: '--', lunchStart: '--', lunchDone: '--', dutyOff: '--',
            tsMap: new Map(), rawRows: []
          };
          const attendance = computeAttendance(group);
          if (includeAllAtt || selectedAttTypes.includes(attendance)) {
            rows.push({
              email, date: dateKey,
              dutyStart: group.dutyStart, lunchStart: group.lunchStart,
              lunchDone: group.lunchDone, dutyOff: group.dutyOff,
              attendance, rawRows: group.rawRows
            });
          }
        });
      });

      // Render
      elements.tbody.innerHTML = '';
      if (rows.length === 0) {
        elements.tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#999;">No records found for selected filters.</td></tr>';
      } else {
        rows.forEach((row, idx) => {
          const tr = document.createElement('tr');
          const editBtn = row.rawRows.length > 0
            ? `<button class="edit-btn" onclick="openEditModal('${row.email}', '${row.date}', ${JSON.stringify(row.rawRows).replace(/'/g, "\\'")})">Edit</button>`
            : '';
          tr.innerHTML = `
            <td>${editBtn}</td>
            <td>${idx + 1}</td>
            <td>${row.date}</td>
            <td>${row.email}</td>
            <td>${row.dutyStart}</td>
            <td>${row.lunchStart}</td>
            <td>${row.lunchDone}</td>
            <td>${row.dutyOff}</td>
            <td>${row.attendance}</td>
          `;
          elements.tbody.appendChild(tr);
        });
      }

      elements.attendanceTable.style.display = 'table';
      elements.loadingMessage.style.display = 'none';
    }

    // Compute attendance status
    function computeAttendance(group) {
      const has = (status) => group.tsMap.has(status);
      const get = (status) => group.tsMap.get(status);

      if (!has('Duty start') && !has('Duty off') && !has('Lunch start') && !has('Lunch done')) return 'Off';
      if ((has('Duty start') && !has('Duty off')) || (!has('Duty start') && has('Duty off'))) return 'Incomplete attendance';
      if ((has('Lunch start') && !has('Lunch done')) || (!has('Lunch start') && has('Lunch done'))) return 'Incomplete attendance';

      const dutyStart = get('Duty start');
      const dutyOff = get('Duty off');
      let totalHours = (dutyOff - dutyStart) / 3600000;

      if (has('Lunch start') && has('Lunch done')) {
        const lunchHours = (get('Lunch done') - get('Lunch start')) / 3600000;
        totalHours -= lunchHours;
      }

      if (totalHours <= 0) return 'Off';
      if (totalHours >= 8.5) return 'Full day';
      if (totalHours >= 7.5) return 'Late';
      return 'Half day';
    }

    // Open edit modal
    window.openEditModal = function(email, date, rawRows) {
      elements.editDate.textContent = date;
      elements.editEmail.textContent = email;
      elements.editTbody.innerHTML = '';

      rawRows.forEach(([ts, name, status, remarks, selfie, bike, loc, verif, rowIndex]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${rowIndex}</td>
          <td><input type="text" value="${ts}" data-field="timestamp" data-row="${rowIndex}"></td>
          <td><input type="text" value="${status}" data-field="status" data-row="${rowIndex}"></td>
          <td><input type="text" value="${remarks}" data-field="remarks" data-row="${rowIndex}"></td>
          <td><input type="text" value="${selfie}" data-field="selfieUrl" data-row="${rowIndex}"></td>
          <td><input type="text" value="${bike}" data-field="bikeUrl" data-row="${rowIndex}"></td>
          <td><input type="text" value="${loc}" data-field="location" data-row="${rowIndex}"></td>
          <td><input type="text" value="${verif}" data-field="verificationMessage" data-row="${rowIndex}"></td>
        `;
        elements.editTbody.appendChild(tr);
      });

      // Add blur listeners
      elements.editTbody.querySelectorAll('input').forEach(input => {
        input.addEventListener('blur', handleFieldUpdate);
      });

      elements.editModal.style.display = 'flex';
    };

    // Handle field update
    async function handleFieldUpdate(e) {
      const input = e.target;
      const rowIndex = input.dataset.row;
      const field = input.dataset.field;
      const value = input.value.trim();

      const payload = {
        action: 'updateRecord',
        rowIndex: parseInt(rowIndex),
        name: elements.editEmail.textContent
      };

      const rowInputs = elements.editTbody.querySelectorAll(`input[data-row="${rowIndex}"]`);
      rowInputs.forEach(inp => {
        const f = inp.dataset.field;
        payload[f] = inp.value.trim();
      });

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        showToast();
        fetchData(); // Refresh data
      } catch (err) {
        console.error('Update failed:', err);
      }
    }

    // Initialize
    window.onload = async () => {
      const today = new Date();
      const defaultStart = new Date(today);
      defaultStart.setDate(today.getDate() - 29);

      elements.endDate.value = today.toISOString().split('T')[0];
      elements.startDate.value = defaultStart.toISOString().split('T')[0];

      elements.startDate.addEventListener('change', renderTable);
      elements.endDate.addEventListener('change', renderTable);

      await fetchData();
    };
  </script>
</body>
</html>
