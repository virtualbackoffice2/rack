<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Employee Attendance</title>
  <style>
    body{font-family:Arial;max-width:720px;margin:20px auto;padding:10px;}
    .card{border:1px solid #ddd;padding:12px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    video{width:100%;max-width:400px;border-radius:8px;background:#000;}
    button{padding:8px 12px;border-radius:6px;cursor:pointer;margin:2px;}
    input, label{display:block;margin:6px 0;}
    .result{padding:10px;border-radius:6px;margin-top:10px;}
    button:disabled{opacity:0.6;}
  </style>
</head>
<body>
  <h2>üë§ Employee Attendance (Selfie)</h2>
  <div class="card">
    <label>Employee ID *</label>
    <input type="text" id="employeeId" placeholder="Enter ID" required>
    
    <label>Name *</label>
    <input type="text" id="name" placeholder="Enter name" required>
    
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    
    <button id="startBtn">üì∑ Start Camera</button>
    <button id="captureBtn" disabled>üì∏ Capture</button>
    <button id="uploadBtn" disabled>‚úÖ Upload</button>
    
    <div id="previewArea"></div>
    <div id="statusMsg" class="result" style="display:none;"></div>
  </div>

  <script>
    // üî•üî• STEP 2: APNA NEW URL YAHAN PASTE KARO
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxY_ZmJiyWbmDesnB0FlxQa5ati4mSHGu3xYKs7fGQoB0vywSy2Dud9jhpNLSuovJwo/exec";

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const previewArea = document.getElementById('previewArea');
    const statusMsg = document.getElementById('statusMsg');

    let stream, lastDataUrl;

    startBtn.onclick = async () => {
      stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: "user"}});
      video.srcObject = stream;
      startBtn.disabled = true;
      captureBtn.disabled = false;
    };

    captureBtn.onclick = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      lastDataUrl = canvas.toDataURL('image/png');
      previewArea.innerHTML = '<h4>Preview:</h4><img src="' + lastDataUrl + '" style="max-width:300px;">';
      uploadBtn.disabled = false;
    };

    uploadBtn.onclick = async () => {
      const id = document.getElementById('employeeId').value;
      const name = document.getElementById('name').value;
      
      if (!id || !name || !lastDataUrl) return alert('Fill all & capture selfie!');
      
      statusMsg.style.display = 'block';
      statusMsg.textContent = 'Uploading...';
      
      const data = {employeeId: id, name: name, imageBase64: lastDataUrl};
      
      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify(data)
        });
        const result = await res.json();
        
        if (result.success) {
          statusMsg.innerHTML = `‚úÖ ${result.status}<br>Time: ${result.time}<br><a href="${result.photoUrl}" target="_blank">üì∏ Photo</a>`;
          statusMsg.style.background = '#d4edda';
          // RESET
          document.getElementById('employeeId').value = '';
          document.getElementById('name').value = '';
          previewArea.innerHTML = '';
          uploadBtn.disabled = captureBtn.disabled = true;
          startBtn.disabled = false;
          stream.getTracks().forEach(t => t.stop());
        } else {
          throw result.error;
        }
      } catch (e) {
        statusMsg.textContent = '‚ùå ' + e;
        statusMsg.style.background = '#f8d7da';
      }
    };
  </script>
</body>
</html>
