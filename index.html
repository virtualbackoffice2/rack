<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Merotra Network Table</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
body { font-family: Arial; margin: 20px; }
h2 { margin-bottom: 12px; }
#matrixTable { border-collapse: collapse; width: 100%; }
#matrixTable th, #matrixTable td { border: 1px solid #ccc; padding: 4px 8px; text-align: center; }
#matrixTable th { background: #eee; position: sticky; top: 0; z-index: 2; }

.clickable { cursor: pointer; color: blue; text-decoration: underline; }
.onStatus { background: #c6f6c6; font-weight: bold; }
.offStatus { background: #f6c6c6; font-weight: bold; }
.separator { background: #f0f0f0; font-weight: bold; }
.pink { background-color: pink; }
.red { background-color: red; }
@keyframes blink {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}
.blink { animation: blink 1s infinite; }

/* Modal styles */
#userModal {
  display: none;
  position: fixed;
  z-index: 10;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
}
#userModalContent {
  background: #fff;
  margin: 10% auto;
  padding: 20px;
  border-radius: 6px;
  width: 80%;
  max-height: 60%;
  overflow-y: auto;
}
#userModalContent h3 { margin-top: 0; }
.closeBtn {
  float: right;
  cursor: pointer;
  font-weight: bold;
  color: #555;
}
.closeBtn:hover { color: red; }
</style>
</head>
<body>

<h2>Merotra Network</h2>
<div id="matrixHolder">
<table id="matrixTable">
<tr>
  <th></th>
  <th></th>
  <th>Pon1</th><th>Pon2</th><th>Pon3</th><th>Pon4</th>
  <th>Pon5</th><th>Pon6</th><th>Pon7</th><th>Pon8</th>
  <th>Total</th>
</tr>

<!-- Separator for Merotra window -->
<tr class="separator">
  <th colspan="11">Merotra window</th>
</tr>

<!-- O1I5 -->
<tr>
  <th rowspan="4">O1I5</th>
  <th>Users</th>
  <td id="pon1-O1I5" class="clickable">‚è≥</td>
  <td id="pon2-O1I5" class="clickable">‚è≥</td>
  <td id="pon3-O1I5" class="clickable">‚è≥</td>
  <td id="pon4-O1I5" class="clickable">‚è≥</td>
  <td id="pon5-O1I5" class="clickable">‚è≥</td>
  <td id="pon6-O1I5" class="clickable">‚è≥</td>
  <td id="pon7-O1I5" class="clickable">‚è≥</td>
  <td id="pon8-O1I5" class="clickable">‚è≥</td>
  <td id="oltTotal-O1I5" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O1I5" class="clickable">‚è≥</td>
  <td id="off2-O1I5" class="clickable">‚è≥</td>
  <td id="off3-O1I5" class="clickable">‚è≥</td>
  <td id="off4-O1I5" class="clickable">‚è≥</td>
  <td id="off5-O1I5" class="clickable">‚è≥</td>
  <td id="off6-O1I5" class="clickable">‚è≥</td>
  <td id="off7-O1I5" class="clickable">‚è≥</td>
  <td id="off8-O1I5" class="clickable">‚è≥</td>
  <td id="oltOffTotal-O1I5" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Complains</th>
  <td id="tick1-O1I5" class="clickable">‚è≥</td>
  <td id="tick2-O1I5" class="clickable">‚è≥</td>
  <td id="tick3-O1I5" class="clickable">‚è≥</td>
  <td id="tick4-O1I5" class="clickable">‚è≥</td>
  <td id="tick5-O1I5" class="clickable">‚è≥</td>
  <td id="tick6-O1I5" class="clickable">‚è≥</td>
  <td id="tick7-O1I5" class="clickable">‚è≥</td>
  <td id="tick8-O1I5" class="clickable">‚è≥</td>
  <td id="oltTickTotal-O1I5" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Line Status</th>
  <td id="stat1-O1I5">‚è≥</td>
  <td id="stat2-O1I5">‚è≥</td>
  <td id="stat3-O1I5">‚è≥</td>
  <td id="stat4-O1I5">‚è≥</td>
  <td id="stat5-O1I5">‚è≥</td>
  <td id="stat6-O1I5">‚è≥</td>
  <td id="stat7-O1I5">‚è≥</td>
  <td id="stat8-O1I5">‚è≥</td>
  <td></td>
</tr>

<!-- O2I6 -->
<tr>
  <th rowspan="4">O2I6</th>
  <th>Users</th>
  <td id="pon1-O2I6" class="clickable">‚è≥</td>
  <td id="pon2-O2I6" class="clickable">‚è≥</td>
  <td id="pon3-O2I6" class="clickable">‚è≥</td>
  <td id="pon4-O2I6" class="clickable">‚è≥</td>
  <td id="pon5-O2I6" class="clickable">‚è≥</td>
  <td id="pon6-O2I6" class="clickable">‚è≥</td>
  <td id="pon7-O2I6" class="clickable">‚è≥</td>
  <td id="pon8-O2I6" class="clickable">‚è≥</td>
  <td id="oltTotal-O2I6" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O2I6" class="clickable">‚è≥</td>
  <td id="off2-O2I6" class="clickable">‚è≥</td>
  <td id="off3-O2I6" class="clickable">‚è≥</td>
  <td id="off4-O2I6" class="clickable">‚è≥</td>
  <td id="off5-O2I6" class="clickable">‚è≥</td>
  <td id="off6-O2I6" class="clickable">‚è≥</td>
  <td id="off7-O2I6" class="clickable">‚è≥</td>
  <td id="off8-O2I6" class="clickable">‚è≥</td>
  <td id="oltOffTotal-O2I6" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Complains</th>
  <td id="tick1-O2I6" class="clickable">‚è≥</td>
  <td id="tick2-O2I6" class="clickable">‚è≥</td>
  <td id="tick3-O2I6" class="clickable">‚è≥</td>
  <td id="tick4-O2I6" class="clickable">‚è≥</td>
  <td id="tick5-O2I6" class="clickable">‚è≥</td>
  <td id="tick6-O2I6" class="clickable">‚è≥</td>
  <td id="tick7-O2I6" class="clickable">‚è≥</td>
  <td id="tick8-O2I6" class="clickable">‚è≥</td>
  <td id="oltTickTotal-O2I6" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Line Status</th>
  <td id="stat1-O2I6">‚è≥</td>
  <td id="stat2-O2I6">‚è≥</td>
  <td id="stat3-O2I6">‚è≥</td>
  <td id="stat4-O2I6">‚è≥</td>
  <td id="stat5-O2I6">‚è≥</td>
  <td id="stat6-O2I6">‚è≥</td>
  <td id="stat7-O2I6">‚è≥</td>
  <td id="stat8-O2I6">‚è≥</td>
  <td></td>
</tr>

<!-- O3I7 -->
<tr>
  <th rowspan="4">O3I7</th>
  <th>Users</th>
  <td id="pon1-O3I7" class="clickable">‚è≥</td>
  <td id="pon2-O3I7" class="clickable">‚è≥</td>
  <td id="pon3-O3I7" class="clickable">‚è≥</td>
  <td id="pon4-O3I7" class="clickable">‚è≥</td>
  <td colspan="4"></td>
  <td id="oltTotal-O3I7" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O3I7" class="clickable">‚è≥</td>
  <td id="off2-O3I7" class="clickable">‚è≥</td>
  <td id="off3-O3I7" class="clickable">‚è≥</td>
  <td id="off4-O3I7" class="clickable">‚è≥</td>
  <td colspan="4"></td>
  <td id="oltOffTotal-O3I7" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Complains</th>
  <td id="tick1-O3I7" class="clickable">‚è≥</td>
  <td id="tick2-O3I7" class="clickable">‚è≥</td>
  <td id="tick3-O3I7" class="clickable">‚è≥</td>
  <td id="tick4-O3I7" class="clickable">‚è≥</td>
  <td colspan="4"></td>
  <td id="oltTickTotal-O3I7" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Line Status</th>
  <td id="stat1-O3I7">‚è≥</td>
  <td id="stat2-O3I7">‚è≥</td>
  <td id="stat3-O3I7">‚è≥</td>
  <td id="stat4-O3I7">‚è≥</td>
  <td colspan="4"></td>
  <td></td>
</tr>

<!-- O4I9 -->
<tr>
  <th rowspan="4">O4I9</th>
  <th>Users</th>
  <td id="pon1-O4I9" class="clickable">‚è≥</td>
  <td id="pon2-O4I9" class="clickable">‚è≥</td>
  <td id="pon3-O4I9" class="clickable">‚è≥</td>
  <td id="pon4-O4I9" class="clickable">‚è≥</td>
  <td colspan="4"></td>
  <td id="oltTotal-O4I9" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O4I9" class="clickable">‚è≥</td>
  <td id="off2-O4I9" class="clickable">‚è≥</td>
  <td id="off3-O4I9" class="clickable">‚è≥</td>
  <td id="off4-O4I9" class="clickable">‚è≥</td>
  <td colspan="4"></td>
  <td id="oltOffTotal-O4I9" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Complains</th>
  <td id="tick1-O4I9" class="clickable">‚è≥</td>
  <td id="tick2-O4I9" class="clickable">‚è≥</td>
  <td id="tick3-O4I9" class="clickable">‚è≥</td>
  <td id="tick4-O4I9" class="clickable">‚è≥</td>
  <td colspan="4"></td>
  <td id="oltTickTotal-O4I9" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Line Status</th>
  <td id="stat1-O4I9">‚è≥</td>
  <td id="stat2-O4I9">‚è≥</td>
  <td id="stat3-O4I9">‚è≥</td>
  <td id="stat4-O4I9">‚è≥</td>
  <td colspan="4"></td>
  <td></td>
</tr>

<!-- Separator for Budheshwar window -->
<tr class="separator">
  <th colspan="11">Budheshwar window ki OLT</th>
</tr>

<!-- O5I2 -->
<tr>
  <th rowspan="4">O5I2</th>
  <th>Users</th>
  <td id="pon1-O5I2" class="clickable">‚è≥</td>
  <td id="pon2-O5I2" class="clickable">‚è≥</td>
  <td id="pon3-O5I2" class="clickable">‚è≥</td>
  <td id="pon4-O5I2" class="clickable">‚è≥</td>
  <td id="pon5-O5I2" class="clickable">‚è≥</td>
  <td id="pon6-O5I2" class="clickable">‚è≥</td>
  <td id="pon7-O5I2" class="clickable">‚è≥</td>
  <td id="pon8-O5I2" class="clickable">‚è≥</td>
  <td id="oltTotal-O5I2" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O5I2" class="clickable">‚è≥</td>
  <td id="off2-O5I2" class="clickable">‚è≥</td>
  <td id="off3-O5I2" class="clickable">‚è≥</td>
  <td id="off4-O5I2" class="clickable">‚è≥</td>
  <td id="off5-O5I2" class="clickable">‚è≥</td>
  <td id="off6-O5I2" class="clickable">‚è≥</td>
  <td id="off7-O5I2" class="clickable">‚è≥</td>
  <td id="off8-O5I2" class="clickable">‚è≥</td>
  <td id="oltOffTotal-O5I2" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Complains</th>
  <td id="tick1-O5I2" class="clickable">‚è≥</td>
  <td id="tick2-O5I2" class="clickable">‚è≥</td>
  <td id="tick3-O5I2" class="clickable">‚è≥</td>
  <td id="tick4-O5I2" class="clickable">‚è≥</td>
  <td id="tick5-O5I2" class="clickable">‚è≥</td>
  <td id="tick6-O5I2" class="clickable">‚è≥</td>
  <td id="tick7-O5I2" class="clickable">‚è≥</td>
  <td id="tick8-O5I2" class="clickable">‚è≥</td>
  <td id="oltTickTotal-O5I2" class="clickable">‚è≥</td>
</tr>
<tr>
  <th>Line Status</th>
  <td id="stat1-O5I2">‚è≥</td>
  <td id="stat2-O5I2">‚è≥</td>
  <td id="stat3-O5I2">‚è≥</td>
  <td id="stat4-O5I2">‚è≥</td>
  <td id="stat5-O5I2">‚è≥</td>
  <td id="stat6-O5I2">‚è≥</td>
  <td id="stat7-O5I2">‚è≥</td>
  <td id="stat8-O5I2">‚è≥</td>
  <td></td>
</tr>

</table>
</div>

<!-- Modal -->
<div id="userModal">
  <div id="userModalContent">
    <span class="closeBtn" onclick="closeModal()">&times;</span>
    <h3 id="modalTitle">Users Details</h3>
    <div id="userDetails"></div>
    <div id="modalButtons"></div>
  </div>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-FZM6fwvv0ruaSv-PbEG8sHNOmldJn6kXtRY6e7NZ9YlN3TJ5Oe9ECMwmGBTK-LMTnA/exec';
const TOKEN = 'abcd1234';

let oltData = {};
let dashboardA7 = null;

async function loadData() {
  const url = WEB_APP_URL + '?token=' + encodeURIComponent(TOKEN);
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
    const data = await response.json();
    if (data.error) throw new Error(data.error);

    const rows = data.rows || [];
    dashboardA7 = data.dashboardA7 !== undefined && data.dashboardA7 !== null ? Number(data.dashboardA7) : null;

    const olts = [
      { id: 'O1I5', pons: 8 },
      { id: 'O2I6', pons: 8 },
      { id: 'O3I7', pons: 4 },
      { id: 'O4I9', pons: 4 },
      { id: 'O5I2', pons: 8 }
    ];

    for (let oltObj of olts) {
      const olt = oltObj.id;
      const maxPon = oltObj.pons;
      let total = 0, offTotal = 0, tickTotal = 0;
      for (let i = 1; i <= maxPon; i++) {
        const nmid = olt + 'P' + i;
        const filtered = rows.filter(r => r['NMID'] === nmid && r['Users']);

        const allRows = filtered;
        const offRows = filtered.filter(r => r['Downs']);
        const tickRows = filtered.filter(r => r['Ticket']);
        const dropTimes = filtered.map(r => r['Drops']).filter(v => v && v !== '');

        oltData[nmid] = { all: allRows, off: offRows, tick: tickRows, drops: dropTimes };

        document.getElementById(`pon${i}-${olt}`).textContent = allRows.length;
        document.getElementById(`off${i}-${olt}`).textContent = offRows.length;
        document.getElementById(`tick${i}-${olt}`).textContent = tickRows.length;

        let statusCell = document.getElementById(`stat${i}-${olt}`);
        let dropCount = dropTimes.length;
        if (dashboardA7 !== null && !isNaN(dashboardA7)) {
          let isOn = dropCount < dashboardA7;
          if (isOn) {
            statusCell.textContent = "üìó‚úîÔ∏è";
            statusCell.className = "onStatus";
          } else {
            statusCell.textContent = "üî¥‚ùå";
            statusCell.className = "offStatus";
          }
        } else {
          statusCell.textContent = "-";
          statusCell.className = "";
        }

        total += allRows.length;
        offTotal += offRows.length;
        tickTotal += tickRows.length;
      }

      document.getElementById(`oltTotal-${olt}`).textContent = total;
      document.getElementById(`oltOffTotal-${olt}`).textContent = offTotal;
      document.getElementById(`oltTickTotal-${olt}`).textContent = tickTotal;
    }

  } catch (err) {
    console.error('Fetch error:', err);
  }
}

// Modal for PON
function showUsers(type, nmid) {
  let title = "Users Details";
  if (type === "off") title = "Offline Users Details";
  if (type === "tick") title = "Complains Users Details";

  document.getElementById('modalTitle').textContent = title;

  const currentUsers = (oltData[nmid] && oltData[nmid][type]) || [];

  const userDetails = document.getElementById('userDetails');
  userDetails.innerHTML = '<table><thead><tr><th>Sn</th><th>Name</th><th>Number</th><th>Location</th><th>Address</th><th>Power</th><th>Remarks</th></tr></thead><tbody></tbody></table>';
  const tbody = userDetails.querySelector('tbody');

  for (let r of currentUsers) {
    const tr = document.createElement('tr');
    if (r['Ticket']) {
      tr.classList.add('red', 'blink');
    } else if (r['Downs']) {
      tr.classList.add('pink', 'blink');
    }
    const number = (r['Last called no'] && r['Last called no'].trim()) ? r['Last called no'] : (r['Number'] || '');
    tr.innerHTML = `<td>${r['Sn'] || ''}</td><td>${r['Name'] || ''}</td><td>${number}</td><td>${r['Location'] || ''}</td><td>${r['Address'] || ''}</td><td>${r['Power'] || ''}</td><td>${r['Remarks'] || ''}</td>`;
    tbody.appendChild(tr);
  }

  const modalButtons = document.getElementById('modalButtons');
  modalButtons.innerHTML = '';

  const downloadBtn = document.createElement('button');
  downloadBtn.textContent = 'Download CSV';
  downloadBtn.onclick = () => {
    let csv = 'Sn,Name,Number,Location,Address,Power,Remarks\n';
    for (let r of currentUsers) {
      const number = (r['Last called no'] && r['Last called no'].trim()) ? r['Last called no'] : (r['Number'] || '');
      csv += [r['Sn'] || '', r['Name'] || '', number, r['Location'] || '', r['Address'] || '', r['Power'] || '', r['Remarks'] || ''].map(v => `"${v.replace(/"/g, '""')}"`).join(',') + '\n';
    }
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'users.csv';
    a.click();
    URL.revokeObjectURL(url);
  };
  modalButtons.appendChild(downloadBtn);

  const shareBtn = document.createElement('button');
  shareBtn.textContent = 'Share Screenshot on WhatsApp';
  shareBtn.onclick = () => {
    html2canvas(document.getElementById('userModalContent')).then(canvas => {
      canvas.toBlob(blob => {
        const file = new File([blob], 'screenshot.png', {type: 'image/png'});
        if (navigator.canShare && navigator.canShare({files: [file]})) {
          navigator.share({files: [file]}).catch(err => console.error('Share failed', err));
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'screenshot.png';
          a.click();
          URL.revokeObjectURL(url);
        }
      });
    });
  };
  modalButtons.appendChild(shareBtn);

  document.getElementById('userModal').style.display = 'block';
}

// Modal for OLT totals
function showOltUsers(type, olt, maxPon) {
  let title = "All Users Details";
  if (type === "off") title = "All Offline Users Details";
  if (type === "tick") title = "All Complains Users Details";

  document.getElementById('modalTitle').textContent = title;

  let currentUsers = [];
  for (let i = 1; i <= maxPon; i++) {
    const nmid = olt + 'P' + i;
    if (oltData[nmid] && oltData[nmid][type]) {
      currentUsers.push(...oltData[nmid][type]);
    }
  }

  const userDetails = document.getElementById('userDetails');
  userDetails.innerHTML = '<table><thead><tr><th>Sn</th><th>Name</th><th>Number</th><th>Location</th><th>Address</th><th>Power</th><th>Remarks</th></tr></thead><tbody></tbody></table>';
  const tbody = userDetails.querySelector('tbody');

  for (let r of currentUsers) {
    const tr = document.createElement('tr');
    if (r['Ticket']) {
      tr.classList.add('red', 'blink');
    } else if (r['Downs']) {
      tr.classList.add('pink', 'blink');
    }
    const number = (r['Last called no'] && r['Last called no'].trim()) ? r['Last called no'] : (r['Number'] || '');
    tr.innerHTML = `<td>${r['Sn'] || ''}</td><td>${r['Name'] || ''}</td><td>${number}</td><td>${r['Location'] || ''}</td><td>${r['Address'] || ''}</td><td>${r['Power'] || ''}</td><td>${r['Remarks'] || ''}</td>`;
    tbody.appendChild(tr);
  }

  const modalButtons = document.getElementById('modalButtons');
  modalButtons.innerHTML = '';

  const downloadBtn = document.createElement('button');
  downloadBtn.textContent = 'Download CSV';
  downloadBtn.onclick = () => {
    let csv = 'Sn,Name,Number,Location,Address,Power,Remarks\n';
    for (let r of currentUsers) {
      const number = (r['Last called no'] && r['Last called no'].trim()) ? r['Last called no'] : (r['Number'] || '');
      csv += [r['Sn'] || '', r['Name'] || '', number, r['Location'] || '', r['Address'] || '', r['Power'] || '', r['Remarks'] || ''].map(v => `"${v.replace(/"/g, '""')}"`).join(',') + '\n';
    }
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'users.csv';
    a.click();
    URL.revokeObjectURL(url);
  };
  modalButtons.appendChild(downloadBtn);

  const shareBtn = document.createElement('button');
  shareBtn.textContent = 'Share Screenshot on WhatsApp';
  shareBtn.onclick = () => {
    html2canvas(document.getElementById('userModalContent')).then(canvas => {
      canvas.toBlob(blob => {
        const file = new File([blob], 'screenshot.png', {type: 'image/png'});
        if (navigator.canShare && navigator.canShare({files: [file]})) {
          navigator.share({files: [file]}).catch(err => console.error('Share failed', err));
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'screenshot.png';
          a.click();
          URL.revokeObjectURL(url);
        }
      });
    });
  };
  modalButtons.appendChild(shareBtn);

  document.getElementById('userModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('userModal').style.display = 'none';
}

// listeners for PONs and totals
const olts = [
  { id: 'O1I5', pons: 8 },
  { id: 'O2I6', pons: 8 },
  { id: 'O3I7', pons: 4 },
  { id: 'O4I9', pons: 4 },
  { id: 'O5I2', pons: 8 }
];
for (let oltObj of olts) {
  const olt = oltObj.id;
  const maxPon = oltObj.pons;
  for (let i = 1; i <= maxPon; i++) {
    document.getElementById(`pon${i}-${olt}`).addEventListener('click', () => showUsers('all', `${olt}P${i}`));
    document.getElementById(`off${i}-${olt}`).addEventListener('click', () => showUsers('off', `${olt}P${i}`));
    document.getElementById(`tick${i}-${olt}`).addEventListener('click', () => showUsers('tick', `${olt}P${i}`));
  }
  // listeners for totals
  document.getElementById(`oltTotal-${olt}`).addEventListener('click', () => showOltUsers('all', olt, maxPon));
  document.getElementById(`oltOffTotal-${olt}`).addEventListener('click', () => showOltUsers('off', olt, maxPon));
  document.getElementById(`oltTickTotal-${olt}`).addEventListener('click', () => showOltUsers('tick', olt, maxPon));
}

window.addEventListener('load', loadData);
</script>
</body>
</html>
