<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Merotra Network Table</title>

<style>
body { font-family: Arial; margin: 20px; }
h2 { margin-bottom: 12px; }
#matrixTable { border-collapse: collapse; width: 100%; }
#matrixTable th, #matrixTable td { border: 1px solid #ccc; padding: 4px 8px; text-align: center; }
#matrixTable th { background: #eee; position: sticky; top: 0; z-index: 2; }
.cell-count { cursor: pointer; color: blue; text-decoration: underline; }
.popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); 
         background: #fff; border: 1px solid #333; padding: 12px; max-height: 70%; 
         overflow: auto; display: none; z-index: 1000; width: 600px; }
.popup table { width: 100%; border-collapse: collapse; margin-top: 8px; }
.popup table th, .popup table td { border: 1px solid #ccc; padding: 4px; text-align: left; font-size: 12px; }
.popup-close { cursor: pointer; color: red; float: right; font-weight: bold; }
</style>
</head>
<body>

<h2>Merotra Network</h2>
<div id="matrixHolder"></div>

<!-- Popup for user details -->
<div id="userPopup" class="popup">
  <span id="popupClose" class="popup-close">X</span>
  <h3>User List</h3>
  <div id="popupContent"></div>
</div>

<script>
// ====== CONFIG ======
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-FZM6fwvv0ruaSv-PbEG8sHNOmldJn6kXtRY6e7NZ9YlN3TJ5Oe9ECMwmGBTK-LMTnA/exec';
const TOKEN = 'abcd1234';
// ===================

let sheetData = [];

// Popup helpers
const popup = document.getElementById('userPopup');
const popupContent = document.getElementById('popupContent');
document.getElementById('popupClose').onclick = () => { popup.style.display = 'none'; };

function showUserPopup(title, users) {
  popupContent.innerHTML = `<strong>${title}</strong><br><br>`;
  if(users.length===0){ popupContent.innerHTML += 'No users'; popup.style.display='block'; return; }

  let html = '<table><thead><tr><th>SN</th><th>Name</th><th>Number</th><th>Location</th><th>Address</th><th>Power</th><th>Remarks</th></tr></thead><tbody>';
  users.forEach((u,i)=>{
    let number = u['Last called no'] ? u['Last called no'] : u['Number'];
    html += `<tr>
      <td>${i+1}</td>
      <td>${u['Name']||''}</td>
      <td>${number||''}</td>
      <td>${u['Location']||''}</td>
      <td>${u['Address']||''}</td>
      <td>${u['Power']||''}</td>
      <td>${u['Remarks']||''}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  popupContent.innerHTML += html;
  popup.style.display = 'block';
}

// Extract OLT and PON from NMID
function parseNMID(nmid){
  const ponMatch = nmid.match(/P(\d+)/i);
  const olt = nmid.replace(/P\d+/i,'');
  const pon = ponMatch ? ponMatch[1] : '';
  return { olt, pon };
}

// Build matrix data structure
function buildMatrix(data){
  const matrix = {}; // {OLT:{PON:[rows]}}
  const ponSet = new Set();
  data.forEach(row=>{
    if(!row['User']) return; // ignore rows without User ID
    const nm = parseNMID(row['NMID']);
    if(!matrix[nm.olt]) matrix[nm.olt] = {};
    if(!matrix[nm.olt][nm.pon]) matrix[nm.olt][nm.pon] = [];
    matrix[nm.olt][nm.pon].push(row);
    ponSet.add(nm.pon);
  });
  const ponList = Array.from(ponSet).sort((a,b)=>parseInt(a)-parseInt(b));
  return {matrix, ponList};
}

// Compute cell counts
function computeCellCounts(rows){
  const totalUsers = rows.length;
  const offlineUsers = rows.filter(r=>r['Downs']).length;
  const complaints = rows.filter(r=>r['Ticket']).length;
  // On/Off status
  const dropsCount = {};
  rows.forEach(r=>{
    if(!r['Drops']) return;
    const ts = r['Drops'];
    dropsCount[ts] = (dropsCount[ts]||0)+1;
  });
  let status = 'On';
  Object.values(dropsCount).forEach(v=>{ if(v>=4) status='Off'; });
  return {totalUsers, offlineUsers, complaints, status};
}

// Build matrix table HTML
function buildTableHTML(matrix, ponList){
  const olts = Object.keys(matrix).sort();
  let html = '<table id="matrixTable">';
  // Header
  html += '<tr><th>OLT / PON</th>';
  ponList.forEach(p=>html+=`<th>P${p}</th>`);
  html += '<th>Total</th></tr>';
  // Rows
  olts.forEach(olt=>{
    html += `<tr><th>${olt}</th>`;
    let rowTotalUsers = 0;
    ponList.forEach(pon=>{
      const rows = matrix[olt][pon]||[];
      const counts = computeCellCounts(rows);
      rowTotalUsers += counts.totalUsers;
      html += `<td>
        <div class="cell-count" onclick="showUserPopup('PON ${pon} / ${olt} - Total Users',${JSON.stringify(rows)})">
          Total: ${counts.totalUsers}<br>
          Offline: ${counts.offlineUsers}<br>
          Complaints: ${counts.complaints}<br>
          ${counts.status}
        </div>
      </td>`;
    });
    // Row total
    const allRows = [];
    ponList.forEach(p=>{ if(matrix[olt][p]) allRows.push(...matrix[olt][p]); });
    html += `<td><div class="cell-count" onclick="showUserPopup('Total Users for ${olt}',${JSON.stringify(allRows)})">${rowTotalUsers}</div></td>`;
    html += '</tr>';
  });
  html += '</table>';
  return html;
}

// Load data via fetch
async function loadData(){
  const url = WEB_APP_URL + '?token=' + encodeURIComponent(TOKEN);
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error('Network response was not ok: ' + response.statusText);
    }
    const data = await response.json();
    handleSheetData(data);
  } catch (error) {
    console.error('Fetch error:', error);
    // Optional: Display error in UI
    document.getElementById('matrixHolder').innerHTML = '<p>Error loading data: ' + error.message + '</p>';
  }
}

function handleSheetData(data){
  sheetData = data.rows || data || []; // Adjust based on actual response format; if plain array, use data
  const {matrix, ponList} = buildMatrix(sheetData);
  document.getElementById('matrixHolder').innerHTML = buildTableHTML(matrix, ponList);
}

window.addEventListener('load', loadData);
</script>
</body>
</html>
