<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Merotra Network Table</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
<div id="loadingOverlay">
  <div class="spinner"></div>
  <p>Loading rack...</p>
</div>
<h2>Merotra Network Rack</h2>
<div id="matrixHolder">
  <!-- First Table: Merotra and Sarosa OLTs (First Sheet) -->
  <table id="matrixTable">
    <tr>
      <th></th>
      <th></th>
      <th>Pon1</th><th>Pon2</th><th>Pon3</th><th>Pon4</th>
      <th>Pon5</th><th>Pon6</th><th>Pon7</th><th>Pon8</th>
      <th>Total</th>
    </tr>
    <!-- Separator for Merotra window -->
    <tr class="separator">
      <th colspan="11">Merotra window Duda</th>
    </tr>
    <!-- O1I5 -->
    <tr>
      <th rowspan="4" class="olt-name">O1I5</th>
      <th>Users</th>
      <td id="pon1-O1I5" class="clickable">‚è≥</td>
      <td id="pon2-O1I5" class="clickable">‚è≥</td>
      <td id="pon3-O1I5" class="clickable">‚è≥</td>
      <td id="pon4-O1I5" class="clickable">‚è≥</td>
      <td id="pon5-O1I5" class="clickable">‚è≥</td>
      <td id="pon6-O1I5" class="clickable">‚è≥</td>
      <td id="pon7-O1I5" class="clickable">‚è≥</td>
      <td id="pon8-O1I5" class="clickable">‚è≥</td>
      <td id="oltTotal-O1I5" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Offline</th>
      <td id="off1-O1I5" class="clickable">‚è≥</td>
      <td id="off2-O1I5" class="clickable">‚è≥</td>
      <td id="off3-O1I5" class="clickable">‚è≥</td>
      <td id="off4-O1I5" class="clickable">‚è≥</td>
      <td id="off5-O1I5" class="clickable">‚è≥</td>
      <td id="off6-O1I5" class="clickable">‚è≥</td>
      <td id="off7-O1I5" class="clickable">‚è≥</td>
      <td id="off8-O1I5" class="clickable">‚è≥</td>
      <td id="oltOffTotal-O1I5" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Ticket</th>
      <td id="tick1-O1I5" class="clickable">‚è≥</td>
      <td id="tick2-O1I5" class="clickable">‚è≥</td>
      <td id="tick3-O1I5" class="clickable">‚è≥</td>
      <td id="tick4-O1I5" class="clickable">‚è≥</td>
      <td id="tick5-O1I5" class="clickable">‚è≥</td>
      <td id="tick6-O1I5" class="clickable">‚è≥</td>
      <td id="tick7-O1I5" class="clickable">‚è≥</td>
      <td id="tick8-O1I5" class="clickable">‚è≥</td>
      <td id="oltTickTotal-O1I5" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Line</th>
      <td id="stat1-O1I5">‚è≥</td>
      <td id="stat2-O1I5">‚è≥</td>
      <td id="stat3-O1I5">‚è≥</td>
      <td id="stat4-O1I5">‚è≥</td>
      <td id="stat5-O1I5">‚è≥</td>
      <td id="stat6-O1I5">‚è≥</td>
      <td id="stat7-O1I5">‚è≥</td>
      <td id="stat8-O1I5">‚è≥</td>
      <td></td>
    </tr>
    <!-- O2I6 -->
    <tr>
      <th rowspan="4" class="olt-name">O2I6</th>
      <th>Users</th>
      <td id="pon1-O2I6" class="clickable">‚è≥</td>
      <td id="pon2-O2I6" class="clickable">‚è≥</td>
      <td id="pon3-O2I6" class="clickable">‚è≥</td>
      <td id="pon4-O2I6" class="clickable">‚è≥</td>
      <td id="pon5-O2I6" class="clickable">‚è≥</td>
      <td id="pon6-O2I6" class="clickable">‚è≥</td>
      <td id="pon7-O2I6" class="clickable">‚è≥</td>
      <td id="pon8-O2I6" class="clickable">‚è≥</td>
      <td id="oltTotal-O2I6" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Offline</th>
      <td id="off1-O2I6" class="clickable">‚è≥</td>
      <td id="off2-O2I6" class="clickable">‚è≥</td>
      <td id="off3-O2I6" class="clickable">‚è≥</td>
      <td id="off4-O2I6" class="clickable">‚è≥</td>
      <td id="off5-O2I6" class="clickable">‚è≥</td>
      <td id="off6-O2I6" class="clickable">‚è≥</td>
      <td id="off7-O2I6" class="clickable">‚è≥</td>
      <td id="off8-O2I6" class="clickable">‚è≥</td>
      <td id="oltOffTotal-O2I6" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Ticket</th>
      <td id="tick1-O2I6" class="clickable">‚è≥</td>
      <td id="tick2-O2I6" class="clickable">‚è≥</td>
      <td id="tick3-O2I6" class="clickable">‚è≥</td>
      <td id="tick4-O2I6" class="clickable">‚è≥</td>
      <td id="tick5-O2I6" class="clickable">‚è≥</td>
      <td id="tick6-O2I6" class="clickable">‚è≥</td>
      <td id="tick7-O2I6" class="clickable">‚è≥</td>
      <td id="tick8-O2I6" class="clickable">‚è≥</td>
      <td id="oltTickTotal-O2I6" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Line</th>
      <td id="stat1-O2I6">‚è≥</td>
      <td id="stat2-O2I6">‚è≥</td>
      <td id="stat3-O2I6">‚è≥</td>
      <td id="stat4-O2I6">‚è≥</td>
      <td id="stat5-O2I6">‚è≥</td>
      <td id="stat6-O2I6">‚è≥</td>
      <td id="stat7-O2I6">‚è≥</td>
      <td id="stat8-O2I6">‚è≥</td>
      <td></td>
    </tr>
    <!-- O3I7 -->
    <tr>
      <th rowspan="4" class="olt-name">O3I7</th>
      <th>Users</th>
      <td id="pon1-O3I7" class="clickable">‚è≥</td>
      <td id="pon2-O3I7" class="clickable">‚è≥</td>
      <td id="pon3-O3I7" class="clickable">‚è≥</td>
      <td id="pon4-O3I7" class="clickable">‚è≥</td>
      <td colspan="4"></td>
      <td id="oltTotal-O3I7" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Offline</th>
      <td id="off1-O3I7" class="clickable">‚è≥</td>
      <td id="off2-O3I7" class="clickable">‚è≥</td>
      <td id="off3-O3I7" class="clickable">‚è≥</td>
      <td id="off4-O3I7" class="clickable">‚è≥</td>
      <td colspan="4"></td>
      <td id="oltOffTotal-O3I7" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Ticket</th>
      <td id="tick1-O3I7" class="clickable">‚è≥</td>
      <td id="tick2-O3I7" class="clickable">‚è≥</td>
      <td id="tick3-O3I7" class="clickable">‚è≥</td>
      <td id="tick4-O3I7" class="clickable">‚è≥</td>
      <td colspan="4"></td>
      <td id="oltTickTotal-O3I7" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Line</th>
      <td id="stat1-O3I7">‚è≥</td>
      <td id="stat2-O3I7">‚è≥</td>
      <td id="stat3-O3I7">‚è≥</td>
      <td id="stat4-O3I7">‚è≥</td>
      <td colspan="4"></td>
      <td></td>
    </tr>
    <!-- Separator for Sarosa Distance OLT -->
    <tr class="separator">
      <th colspan="11">Sarosa Distance OLT</th>
    </tr>
    <!-- O4I9 -->
    <tr>
      <th rowspan="4" class="olt-name">O4I9</th>
      <th>Users</th>
      <td id="pon1-O4I9" class="clickable">‚è≥</td>
      <td id="pon2-O4I9" class="clickable">‚è≥</td>
      <td id="pon3-O4I9" class="clickable">‚è≥</td>
      <td id="pon4-O4I9" class="clickable">‚è≥</td>
      <td colspan="4"></td>
      <td id="oltTotal-O4I9" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Offline</th>
      <td id="off1-O4I9" class="clickable">‚è≥</td>
      <td id="off2-O4I9" class="clickable">‚è≥</td>
      <td id="off3-O4I9" class="clickable">‚è≥</td>
      <td id="off4-O4I9" class="clickable">‚è≥</td>
      <td colspan="4"></td>
      <td id="oltOffTotal-O4I9" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Ticket</th>
      <td id="tick1-O4I9" class="clickable">‚è≥</td>
      <td id="tick2-O4I9" class="clickable">‚è≥</td>
      <td id="tick3-O4I9" class="clickable">‚è≥</td>
      <td id="tick4-O4I9" class="clickable">‚è≥</td>
      <td colspan="4"></td>
      <td id="oltTickTotal-O4I9" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Line</th>
      <td id="stat1-O4I9">‚è≥</td>
      <td id="stat2-O4I9">‚è≥</td>
      <td id="stat3-O4I9">‚è≥</td>
      <td id="stat4-O4I9">‚è≥</td>
      <td colspan="4"></td>
      <td></td>
    </tr>
    <!-- Separator for Budheshwar window -->
    <tr class="separator">
      <th colspan="11">Budheshwar Window</th>
    </tr>
    <!-- O5I2 -->
    <tr>
      <th rowspan="4" class="olt-name">O5I2</th>
      <th>Users</th>
      <td id="pon1-O5I2" class="clickable">‚è≥</td>
      <td id="pon2-O5I2" class="clickable">‚è≥</td>
      <td id="pon3-O5I2" class="clickable">‚è≥</td>
      <td id="pon4-O5I2" class="clickable">‚è≥</td>
      <td id="pon5-O5I2" class="clickable">‚è≥</td>
      <td id="pon6-O5I2" class="clickable">‚è≥</td>
      <td id="pon7-O5I2" class="clickable">‚è≥</td>
      <td id="pon8-O5I2" class="clickable">‚è≥</td>
      <td id="oltTotal-O5I2" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Offline</th>
      <td id="off1-O5I2" class="clickable">‚è≥</td>
      <td id="off2-O5I2" class="clickable">‚è≥</td>
      <td id="off3-O5I2" class="clickable">‚è≥</td>
      <td id="off4-O5I2" class="clickable">‚è≥</td>
      <td id="off5-O5I2" class="clickable">‚è≥</td>
      <td id="off6-O5I2" class="clickable">‚è≥</td>
      <td id="off7-O5I2" class="clickable">‚è≥</td>
      <td id="off8-O5I2" class="clickable">‚è≥</td>
      <td id="oltOffTotal-O5I2" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Ticket</th>
      <td id="tick1-O5I2" class="clickable">‚è≥</td>
      <td id="tick2-O5I2" class="clickable">‚è≥</td>
      <td id="tick3-O5I2" class="clickable">‚è≥</td>
      <td id="tick4-O5I2" class="clickable">‚è≥</td>
      <td id="tick5-O5I2" class="clickable">‚è≥</td>
      <td id="tick6-O5I2" class="clickable">‚è≥</td>
      <td id="tick7-O5I2" class="clickable">‚è≥</td>
      <td id="tick8-O5I2" class="clickable">‚è≥</td>
      <td id="oltTickTotal-O5I2" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Line</th>
      <td id="stat1-O5I2">‚è≥</td>
      <td id="stat2-O5I2">‚è≥</td>
      <td id="stat3-O5I2">‚è≥</td>
      <td id="stat4-O5I2">‚è≥</td>
      <td id="stat5-O5I2">‚è≥</td>
      <td id="stat6-O5I2">‚è≥</td>
      <td id="stat7-O5I2">‚è≥</td>
      <td id="stat8-O5I2">‚è≥</td>
      <td></td>
    </tr>
  </table>

  <!-- Second Table: Suny Window (Second Sheet) -->
  <h2>Suny Window Rack</h2>
  <table id="sunyMatrixTable">
    <tr>
      <th></th>
      <th></th>
      <th>Pon1</th><th>Pon2</th><th>Pon3</th><th>Pon4</th>
      <th>Pon5</th><th>Pon6</th><th>Pon7</th><th>Pon8</th>
      <th>Total</th>
    </tr>
    <!-- Separator for Suny window -->
    <tr class="separator">
      <th colspan="11">Suny Window</th>
    </tr>
    <!-- O5I2 (Suny) -->
    <tr>
      <th rowspan="4" class="olt-name">O5I2</th>
      <th>Users</th>
      <td id="suny-pon1-O5I2" class="clickable">‚è≥</td>
      <td id="suny-pon2-O5I2" class="clickable">‚è≥</td>
      <td id="suny-pon3-O5I2" class="clickable">‚è≥</td>
      <td id="suny-pon4-O5I2" class="clickable">‚è≥</td>
      <td id="suny-pon5-O5I2" class="clickable">‚è≥</td>
      <td id="suny-pon6-O5I2" class="clickable">‚è≥</td>
      <td id="suny-pon7-O5I2" class="clickable">‚è≥</td>
      <td id="suny-pon8-O5I2" class="clickable">‚è≥</td>
      <td id="suny-oltTotal-O5I2" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Offline</th>
      <td id="suny-off1-O5I2" class="clickable">‚è≥</td>
      <td id="suny-off2-O5I2" class="clickable">‚è≥</td>
      <td id="suny-off3-O5I2" class="clickable">‚è≥</td>
      <td id="suny-off4-O5I2" class="clickable">‚è≥</td>
      <td id="suny-off5-O5I2" class="clickable">‚è≥</td>
      <td id="suny-off6-O5I2" class="clickable">‚è≥</td>
      <td id="suny-off7-O5I2" class="clickable">‚è≥</td>
      <td id="suny-off8-O5I2" class="clickable">‚è≥</td>
      <td id="suny-oltOffTotal-O5I2" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Ticket</th>
      <td id="suny-tick1-O5I2" class="clickable">‚è≥</td>
      <td id="suny-tick2-O5I2" class="clickable">‚è≥</td>
      <td id="suny-tick3-O5I2" class="clickable">‚è≥</td>
      <td id="suny-tick4-O5I2" class="clickable">‚è≥</td>
      <td id="suny-tick5-O5I2" class="clickable">‚è≥</td>
      <td id="suny-tick6-O5I2" class="clickable">‚è≥</td>
      <td id="suny-tick7-O5I2" class="clickable">‚è≥</td>
      <td id="suny-tick8-O5I2" class="clickable">‚è≥</td>
      <td id="suny-oltTickTotal-O5I2" class="clickable">‚è≥</td>
    </tr>
    <tr>
      <th>Line</th>
      <td id="suny-stat1-O5I2">‚è≥</td>
      <td id="suny-stat2-O5I2">‚è≥</td>
      <td id="suny-stat3-O5I2">‚è≥</td>
      <td id="suny-stat4-O5I2">‚è≥</td>
      <td id="suny-stat5-O5I2">‚è≥</td>
      <td id="suny-stat6-O5I2">‚è≥</td>
      <td id="suny-stat7-O5I2">‚è≥</td>
      <td id="suny-stat8-O5I2">‚è≥</td>
      <td></td>
    </tr>
  </table>
</div>
<!-- Modal -->
<div id="userModal">
  <div id="userModalContent">
    <span class="closeBtn" onclick="closeModal()">&times;</span>
    <div id="modalButtons"></div>
    <div id="screenshotContent">
      <h3 id="modalTitle">Users Details</h3>
      <div id="modalSubTitle"></div>
      <div id="userDetails"></div>
    </div>
  </div>
</div>
<!-- Toast -->
<div id="toast">No user in list!!</div>
<script>
const WEB_APP_URLS = [
  'https://script.google.com/macros/s/AKfycbzliBfK4lJmojz4wSUZVcJBg1UDu47WlLvHA5GSAFk84EPd1w4cT62Dw5PqpsuemybXww/exec',
  'https://script.google.com/macros/s/AKfycbzP06rGtmvCWN4sMqtrluFcLeSM29vjmJ0fRO0r8rEc5mqRRuyUGTuvIK2qN1gZEvLoTg/exec'
];
const TOKEN = 'abcd1234';
const STATUS_LINK = 'https://vbo.co.in/ISP/Lucknow/Merotra/tag';
let oltData = { merotra: {}, suny: {} };
let dashboardA7 = { merotra: null, suny: null };

async function loadData() {
  const olts = [
    { id: 'O1I5', pons: 8 },
    { id: 'O2I6', pons: 8 },
    { id: 'O3I7', pons: 4 },
    { id: 'O4I9', pons: 4 },
    { id: 'O5I2', pons: 8 }
  ];
  const sunyOlts = [{ id: 'O5I2', pons: 8 }]; // Suny window only O5I2 for now

  // Initialize oltData for Merotra and Suny
  for (let oltObj of olts) {
    const olt = oltObj.id;
    const maxPon = oltObj.pons;
    oltData.merotra[olt] = {};
    for (let i = 1; i <= maxPon; i++) {
      const nmid = olt + 'P' + i;
      oltData.merotra[olt][nmid] = { all: [], off: [], tick: [], drops: [] };
    }
  }
  for (let oltObj of sunyOlts) {
    const olt = oltObj.id;
    const maxPon = oltObj.pons;
    oltData.suny[olt] = {};
    for (let i = 1; i <= maxPon; i++) {
      const nmid = olt + 'P' + i;
      oltData.suny[olt][nmid] = { all: [], off: [], tick: [], drops: [] };
    }
  }

  try {
    // Fetch data from both URLs
    const fetchPromises = WEB_APP_URLS.map((url, index) =>
      fetch(url + '?token=' + encodeURIComponent(TOKEN))
        .then(response => {
          if (!response.ok) throw new Error(`Network response was not ok for URL ${index + 1}: ${response.statusText}`);
          return response.json();
        })
        .then(data => {
          console.log(`Data from URL ${index + 1} (${url}):`, data);
          if (data.error) throw new Error(`Error from URL ${index + 1}: ${data.error}`);
          return { ...data, sourceIndex: index };
        })
        .catch(err => {
          console.error(`Fetch error for URL ${index + 1} (${url}):`, err);
          return { rows: [], dashboardA7: null, sourceIndex: index };
        })
    );

    const results = await Promise.all(fetchPromises);
    let rowsBySource = { 0: [], 1: [] };

    // Separate rows by source
    results.forEach(data => {
      rowsBySource[data.sourceIndex] = data.rows || [];
      console.log(`Rows from URL ${data.sourceIndex + 1}:`, rowsBySource[data.sourceIndex].length);
      if (data.dashboardA7 !== undefined && data.dashboardA7 !== null) {
        dashboardA7[data.sourceIndex === 0 ? 'merotra' : 'suny'] = Number(data.dashboardA7);
      }
    });

    console.log('Merotra rows:', rowsBySource[0]);
    console.log('Suny rows:', rowsBySource[1]);
    console.log('Unique NMIDs (Merotra):', [...new Set(rowsBySource[0].map(r => r['NMID']))]);
    console.log('Unique IDs (Suny):', [...new Set(rowsBySource[1].map(r => r['ID']?.substring(0, 7)))]);

    // Process Merotra table (first sheet)
    for (let oltObj of olts) {
      const olt = oltObj.id;
      const maxPon = oltObj.pons;
      let total = 0, offTotal = 0, tickTotal = 0;

      for (let i = 1; i <= maxPon; i++) {
        const nmid = olt + 'P' + i;
        const filtered = rowsBySource[0].filter(r => r['NMID'] === nmid && r['Users']);
        const allRowsFiltered = filtered;
        const offRows = filtered.filter(r => r['Downs']);
        const tickRows = filtered.filter(r => r['Ticket']);
        const dropTimes = filtered.map(r => r['Drops']).filter(v => v && v !== '');

        console.log(`Merotra ${nmid}: all=${allRowsFiltered.length}, off=${offRows.length}, tick=${tickRows.length}`);

        oltData.merotra[olt][nmid] = { all: allRowsFiltered, off: offRows, tick: tickRows, drops: dropTimes };

        document.getElementById(`pon${i}-${olt}`).textContent = allRowsFiltered.length;
        document.getElementById(`off${i}-${olt}`).textContent = offRows.length;
        document.getElementById(`tick${i}-${olt}`).textContent = tickRows.length;

        let statusCell = document.getElementById(`stat${i}-${olt}`);
        let dropCount = dropTimes.length;
        if (dashboardA7.merotra !== null && !isNaN(dashboardA7.merotra)) {
          let isOn = dropCount < dashboardA7.merotra;
          statusCell.innerHTML = `<a href="${STATUS_LINK}" target="_self">${isOn ? 'üü¢' : 'üî¥'}</a>`;
          statusCell.className = isOn ? "onStatus clickable" : "offStatus clickable";
        } else {
          statusCell.textContent = "-";
          statusCell.className = "";
        }

        total += allRowsFiltered.length;
        offTotal += offRows.length;
        tickTotal += tickRows.length;
      }

      document.getElementById(`oltTotal-${olt}`).textContent = total;
      document.getElementById(`oltOffTotal-${olt}`).textContent = offTotal;
      document.getElementById(`oltTickTotal-${olt}`).textContent = tickTotal;
    }

    // Process Suny table (second sheet)
    for (let oltObj of sunyOlts) {
      const olt = oltObj.id;
      const maxPon = oltObj.pons;
      let total = 0, offTotal = 0, tickTotal = 0;

      for (let i = 1; i <= maxPon; i++) {
        const nmid = olt + 'P' + i;
        const filtered = rowsBySource[1].filter(r => {
          const fullId = r['ID'] || '';
          const extractedNmid = fullId.substring(0, 7);
          return extractedNmid === nmid && r['Users'];
        });
        const allRowsFiltered = filtered;
        const offRows = filtered.filter(r => r['Downs']);
        const tickRows = filtered.filter(r => r['Ticket']);
        const dropTimes = filtered.map(r => r['Drops']).filter(v => v && v !== '');

        console.log(`Suny ${nmid}: all=${allRowsFiltered.length}, off=${offRows.length}, tick=${tickRows.length}`);

        oltData.suny[olt][nmid] = { all: allRowsFiltered, off: offRows, tick: tickRows, drops: dropTimes };

        document.getElementById(`suny-pon${i}-${olt}`).textContent = allRowsFiltered.length;
        document.getElementById(`suny-off${i}-${olt}`).textContent = offRows.length;
        document.getElementById(`suny-tick${i}-${olt}`).textContent = tickRows.length;

        let statusCell = document.getElementById(`suny-stat${i}-${olt}`);
        let dropCount = dropTimes.length;
        if (dashboardA7.suny !== null && !isNaN(dashboardA7.suny)) {
          let isOn = dropCount < dashboardA7.suny;
          statusCell.innerHTML = `<a href="${STATUS_LINK}" target="_self">${isOn ? 'üü¢' : 'üî¥'}</a>`;
          statusCell.className = isOn ? "onStatus clickable" : "offStatus clickable";
        } else {
          statusCell.textContent = "-";
          statusCell.className = "";
        }

        total += allRowsFiltered.length;
        offTotal += offRows.length;
        tickTotal += tickRows.length;
      }

      document.getElementById(`suny-oltTotal-${olt}`).textContent = total;
      document.getElementById(`suny-oltOffTotal-${olt}`).textContent = offTotal;
      document.getElementById(`suny-oltTickTotal-${olt}`).textContent = tickTotal;
    }

    attachEventListeners();
    document.getElementById('loadingOverlay').style.display = 'none';
  } catch (err) {
    console.error('General fetch error:', err);
    for (let oltObj of olts) {
      const olt = oltObj.id;
      const maxPon = oltObj.pons;
      for (let i = 1; i <= maxPon; i++) {
        document.getElementById(`pon${i}-${olt}`).textContent = 'Error';
        document.getElementById(`off${i}-${olt}`).textContent = 'Error';
        document.getElementById(`tick${i}-${olt}`).textContent = 'Error';
        document.getElementById(`stat${i}-${olt}`).textContent = '-';
      }
      document.getElementById(`oltTotal-${olt}`).textContent = 'Error';
      document.getElementById(`oltOffTotal-${olt}`).textContent = 'Error';
      document.getElementById(`oltTickTotal-${olt}`).textContent = 'Error';
    }
    for (let oltObj of sunyOlts) {
      const olt = oltObj.id;
      const maxPon = oltObj.pons;
      for (let i = 1; i <= maxPon; i++) {
        document.getElementById(`suny-pon${i}-${olt}`).textContent = 'Error';
        document.getElementById(`suny-off${i}-${olt}`).textContent = 'Error';
        document.getElementById(`suny-tick${i}-${olt}`).textContent = 'Error';
        document.getElementById(`suny-stat${i}-${olt}`).textContent = '-';
      }
      document.getElementById(`suny-oltTotal-${olt}`).textContent = 'Error';
      document.getElementById(`suny-oltOffTotal-${olt}`).textContent = 'Error';
      document.getElementById(`suny-oltTickTotal-${olt}`).textContent = 'Error';
    }
    document.getElementById('loadingOverlay').style.display = 'none';
  }
}

function showToast() {
  const toast = document.getElementById('toast');
  toast.className = 'show';
  setTimeout(() => { toast.className = ''; }, 3000);
}

function attachEventListeners() {
  const olts = [
    { id: 'O1I5', pons: 8 },
    { id: 'O2I6', pons: 8 },
    { id: 'O3I7', pons: 4 },
    { id: 'O4I9', pons: 4 },
    { id: 'O5I2', pons: 8 }
  ];
  const sunyOlts = [{ id: 'O5I2', pons: 8 }];

  // Merotra table listeners
  for (let oltObj of olts) {
    const olt = oltObj.id;
    const maxPon = oltObj.pons;
    for (let i = 1; i <= maxPon; i++) {
      const ponElement = document.getElementById(`pon${i}-${olt}`);
      const offElement = document.getElementById(`off${i}-${olt}`);
      const tickElement = document.getElementById(`tick${i}-${olt}`);
      if (ponElement) {
        ponElement.addEventListener('click', () => {
          if (ponElement.textContent === '0') {
            showToast();
          } else {
            showUsers('all', `${olt}P${i}`, olt, `P${i}`, 'merotra');
          }
        });
      }
      if (offElement) {
        offElement.addEventListener('click', () => {
          if (offElement.textContent === '0') {
            showToast();
          } else {
            showUsers('off', `${olt}P${i}`, olt, `P${i}`, 'merotra');
          }
        });
      }
      if (tickElement) {
        tickElement.addEventListener('click', () => {
          if (tickElement.textContent === '0') {
            showToast();
          } else {
            showUsers('tick', `${olt}P${i}`, olt, `P${i}`, 'merotra');
          }
        });
      }
    }
    const totalElement = document.getElementById(`oltTotal-${olt}`);
    const offTotalElement = document.getElementById(`oltOffTotal-${olt}`);
    const tickTotalElement = document.getElementById(`oltTickTotal-${olt}`);
    if (totalElement) {
      totalElement.addEventListener('click', () => {
        if (totalElement.textContent === '0') {
          showToast();
        } else {
          showOltUsers('all', olt, maxPon, 'merotra');
        }
      });
    }
    if (offTotalElement) {
      offTotalElement.addEventListener('click', () => {
        if (offTotalElement.textContent === '0') {
          showToast();
        } else {
          showOltUsers('off', olt, maxPon, 'merotra');
        }
      });
    }
    if (tickTotalElement) {
      tickTotalElement.addEventListener('click', () => {
        if (tickTotalElement.textContent === '0') {
          showToast();
        } else {
          showOltUsers('tick', olt, maxPon, 'merotra');
        }
      });
    }
  }

  // Suny table listeners
  for (let oltObj of sunyOlts) {
    const olt = oltObj.id;
    const maxPon = oltObj.pons;
    for (let i = 1; i <= maxPon; i++) {
      const ponElement = document.getElementById(`suny-pon${i}-${olt}`);
      const offElement = document.getElementById(`suny-off${i}-${olt}`);
      const tickElement = document.getElementById(`suny-tick${i}-${olt}`);
      if (ponElement) {
        ponElement.addEventListener('click', () => {
          if (ponElement.textContent === '0') {
            showToast();
          } else {
            showUsers('all', `${olt}P${i}`, olt, `P${i}`, 'suny');
          }
        });
      }
      if (offElement) {
        offElement.addEventListener('click', () => {
          if (offElement.textContent === '0') {
            showToast();
          } else {
            showUsers('off', `${olt}P${i}`, olt, `P${i}`, 'suny');
          }
        });
      }
      if (tickElement) {
        tickElement.addEventListener('click', () => {
          if (tickElement.textContent === '0') {
            showToast();
          } else {
            showUsers('tick', `${olt}P${i}`, olt, `P${i}`, 'suny');
          }
        });
      }
    }
    const totalElement = document.getElementById(`suny-oltTotal-${olt}`);
    const offTotalElement = document.getElementById(`suny-oltOffTotal-${olt}`);
    const tickTotalElement = document.getElementById(`suny-oltTickTotal-${olt}`);
    if (totalElement) {
      totalElement.addEventListener('click', () => {
        if (totalElement.textContent === '0') {
          showToast();
        } else {
          showOltUsers('all', olt, maxPon, 'suny');
        }
      });
    }
    if (offTotalElement) {
      offTotalElement.addEventListener('click', () => {
        if (offTotalElement.textContent === '0') {
          showToast();
        } else {
          showOltUsers('off', olt, maxPon, 'suny');
        }
      });
    }
    if (tickTotalElement) {
      tickTotalElement.addEventListener('click', () => {
        if (tickTotalElement.textContent === '0') {
          showToast();
        } else {
          showOltUsers('tick', olt, maxPon, 'suny');
        }
      });
    }
  }
}

function showUsers(type, nmid, olt, pon, source) {
  let title = "Users Details";
  if (type === "off") title = "Offline Users Details";
  if (type === "tick") title = "Ticket Users Details";
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalSubTitle').textContent = `OLT: ${olt} PON: ${pon} (${source === 'merotra' ? 'Merotra' : 'Suny'} Window)`;
  const currentUsers = (oltData[source][olt] && oltData[source][olt][nmid] && oltData[source][olt][nmid][type]) || [];
  if (currentUsers.length === 0) {
    showToast();
    return;
  }
  const userDetails = document.getElementById('userDetails');
  userDetails.innerHTML = '<table><thead><tr><th>Sn</th><th>Name</th><th>Number</th><th>Location</th><th>Address</th><th>Power</th><th>Remarks</th></tr></thead><tbody></tbody></table>';
  const tbody = userDetails.querySelector('tbody');
  currentUsers.forEach((r, index) => {
    const tr = document.createElement('tr');
    if (r['Ticket']) {
      tr.classList.add('red', 'blink');
    } else if (r['Downs']) {
      tr.classList.add('pink', 'blink');
    }
    const lastCalledNo = r['Last called no'];
    const number = (typeof lastCalledNo === 'string' && lastCalledNo.trim()) ? lastCalledNo.trim() : (r['Number'] || '');
    tr.innerHTML = `<td>${index + 1}</td><td>${r['Name'] || ''}</td><td>${number}</td><td>${r['Location'] || ''}</td><td>${r['Address'] || ''}</td><td>${r['Power'] || ''}</td><td>${r['Remarks'] || ''}</td>`;
    tbody.appendChild(tr);
  });
  const modalButtons = document.getElementById('modalButtons');
  modalButtons.innerHTML = '';
  const downloadBtn = document.createElement('button');
  downloadBtn.textContent = 'Download CSV';
  downloadBtn.onclick = () => {
    try {
      let csv = 'Sn,Name,Number,Location,Address,Power,Remarks\n';
      currentUsers.forEach((r, index) => {
        const lastCalledNo = r['Last called no'];
        const number = (typeof lastCalledNo === 'string' && lastCalledNo.trim()) ? lastCalledNo.trim() : (r['Number'] || '');
        const row = [
          index + 1,
          r['Name'] || '',
          number,
          r['Location'] || '',
          r['Address'] || '',
          r['Power'] || '',
          r['Remarks'] || ''
        ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
        csv += row + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `users_${source}_${olt}_P${pon}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    } catch (err) {
      console.error('CSV download error:', err);
      alert('Failed to download CSV. Please check the console for details.');
    }
  };
  modalButtons.appendChild(downloadBtn);
  const shareBtn = document.createElement('button');
  shareBtn.textContent = 'Share Screenshot on WhatsApp';
  shareBtn.onclick = () => {
    html2canvas(document.getElementById('screenshotContent'), { scale: 2 }).then(canvas => {
      canvas.toBlob(blob => {
        const file = new File([blob], 'screenshot.png', { type: 'image/png' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({ files: [file] }).catch(err => {
            console.error('Share failed:', err);
            alert('Sharing failed. Downloading screenshot instead.');
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'screenshot.png';
            a.click();
            URL.revokeObjectURL(url);
          });
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'screenshot.png';
          a.click();
          URL.revokeObjectURL(url);
        }
      });
    }).catch(err => {
      console.error('Screenshot error:', err);
      alert('Failed to capture screenshot. Please check the console for details.');
    });
  };
  modalButtons.appendChild(shareBtn);
  document.getElementById('userModal').style.display = 'flex';
}

function showOltUsers(type, olt, maxPon, source) {
  let title = "All Users Details";
  if (type === "off") title = "All Offline Users Details";
  if (type === "tick") title = "All Ticket Users Details";
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalSubTitle').textContent = `OLT: ${olt} (${source === 'merotra' ? 'Merotra' : 'Suny'} Window)`;
  let currentUsers = [];
  for (let i = 1; i <= maxPon; i++) {
    const nmid = olt + 'P' + i;
    if (oltData[source][olt] && oltData[source][olt][nmid] && oltData[source][olt][nmid][type]) {
      currentUsers.push(...oltData[source][olt][nmid][type]);
    }
  }
  if (currentUsers.length === 0) {
    showToast();
    return;
  }
  const userDetails = document.getElementById('userDetails');
  userDetails.innerHTML = '<table><thead><tr><th>Sn</th><th>Name</th><th>Number</th><th>Location</th><th>Address</th><th>Power</th><th>Remarks</th></tr></thead><tbody></tbody></table>';
  const tbody = userDetails.querySelector('tbody');
  currentUsers.forEach((r, index) => {
    const tr = document.createElement('tr');
    if (r['Ticket']) {
      tr.classList.add('red', 'blink');
    } else if (r['Downs']) {
      tr.classList.add('pink', 'blink');
    }
    const lastCalledNo = r['Last called no'];
    const number = (typeof lastCalledNo === 'string' && lastCalledNo.trim()) ? lastCalledNo.trim() : (r['Number'] || '');
    tr.innerHTML = `<td>${index + 1}</td><td>${r['Name'] || ''}</td><td>${number}</td><td>${r['Location'] || ''}</td><td>${r['Address'] || ''}</td><td>${r['Power'] || ''}</td><td>${r['Remarks'] || ''}</td>`;
    tbody.appendChild(tr);
  });
  const modalButtons = document.getElementById('modalButtons');
  modalButtons.innerHTML = '';
  const downloadBtn = document.createElement('button');
  downloadBtn.textContent = 'Download CSV';
  downloadBtn.onclick = () => {
    try {
      let csv = 'Sn,Name,Number,Location,Address,Power,Remarks\n';
      currentUsers.forEach((r, index) => {
        const lastCalledNo = r['Last called no'];
        const number = (typeof lastCalledNo === 'string' && lastCalledNo.trim()) ? lastCalledNo.trim() : (r['Number'] || '');
        const row = [
          index + 1,
          r['Name'] || '',
          number,
          r['Location'] || '',
          r['Address'] || '',
          r['Power'] || '',
          r['Remarks'] || ''
        ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
        csv += row + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `users_${source}_${olt}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    } catch (err) {
      console.error('CSV download error:', err);
      alert('Failed to download CSV. Please check the console for details.');
    }
  };
  modalButtons.appendChild(downloadBtn);
  const shareBtn = document.createElement('button');
  shareBtn.textContent = 'Share Screenshot on WhatsApp';
  shareBtn.onclick = () => {
    html2canvas(document.getElementById('screenshotContent'), { scale: 2 }).then(canvas => {
      canvas.toBlob(blob => {
        const file = new File([blob], 'screenshot.png', { type: 'image/png' });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({ files: [file] }).catch(err => {
            console.error('Share failed:', err);
            alert('Sharing failed. Downloading screenshot instead.');
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'screenshot.png';
            a.click();
            URL.revokeObjectURL(url);
          });
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'screenshot.png';
          a.click();
          URL.revokeObjectURL(url);
        }
      });
    }).catch(err => {
      console.error('Screenshot error:', err);
      alert('Failed to capture screenshot. Please check the console for details.');
    });
  };
  modalButtons.appendChild(shareBtn);
  document.getElementById('userModal').style.display = 'flex';
}

function closeModal() {
  document.getElementById('userModal').style.display = 'none';
}

window.addEventListener('load', () => {
  loadData();
  setInterval(loadData, 30000);
});
</script>
<style>
@media (max-width: 768px) {
  table {
    margin-bottom: 100px;
  }
}
#sunyMatrixTable {
  margin-top: 40px;
}
</style>
</body>
</html>
