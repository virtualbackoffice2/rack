<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Merotra Network Table</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- ====================== CSS (सब अंदर) ====================== -->
<style>
  /* ===== BASIC RESET & MOBILE OPTIMIZATION ===== */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Roboto', sans-serif;
    background: #f4f6f9;
    color: #333;
    padding: 10px;
    overflow-x: hidden;
  }

  h2 {
    text-align: center;
    margin: 15px 0;
    color: #2c3e50;
    font-weight: 700;
  }

  /* ===== TABLE CONTAINER – नीचे स्पेस यहीं से ===== */
  #matrixHolder {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 100px;   /* <<< नीचे से स्पेस */
    padding-bottom: 30px;   /* <<< और थोड़ा पैडिंग */
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    background: #fff;
  }

  /* ===== TABLE STYLING ===== */
  #matrixTable {
    width: 100%;
    min-width: 800px;
    border-collapse: collapse;
    font-size: 14px;
    background: #fff;
  }

  #matrixTable th,
  #matrixTable td {
    border: 1px solid #ddd;
    padding: 10px 8px;
    text-align: center;
    white-space: nowrap;
  }

  #matrixTable th {
    background: #3498db;
    color: white;
    font-weight: 500;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  #matrixTable th.olt-name {
    background: #2c3e50;
    font-weight: 700;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    width: 40px;
  }

  #matrixTable tr:nth-child(even) {
    background-color: #f9f9f9;
  }

  #matrixTable tr:hover {
    background-color: #f0f8ff;
  }

  /* ===== SEPARATOR ROW ===== */
  tr.separator th {
    background: #e74c3c !important;
    color: white;
    font-weight: 700;
    font-size: 16px;
    padding: 12px;
  }

  /* ===== CLICKABLE CELLS ===== */
  .clickable {
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
  }

  .clickable:hover {
    background-color: #a8e6cf !important;
    transform: scale(1.05);
  }

  /* ===== STATUS INDICATORS ===== */
  .onStatus a,
  .offStatus a {
    text-decoration: none;
    font-weight: bold;
  }

  .onStatus a { color: #27ae60; }
  .offStatus a { color: #c0392b; }

  /* ===== MODAL ===== */
  #userModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 15px;
    overflow-y: auto;
  }

  #userModalContent {
    background: white;
    border-radius: 12px;
    width: 95%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .closeBtn {
    position: absolute;
    top: 10px; right: 15px;
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
  }

  .closeBtn:hover { color: #000; }

  #modalTitle {
    margin: 0 0 10px;
    color: #2c3e50;
    font-size: 20px;
  }

  #modalSubTitle {
    margin-bottom: 15px;
    color: #7f8c8d;
    font-size: 15px;
  }

  #userDetails table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 13px;
  }

  #userDetails th, #userDetails td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }

  #userDetails th {
    background: #f1f1f1;
  }

  #userDetails tr.red {
    background: #ffebee !important;
  }

  #userDetails tr.pink {
    background: #fce4ec !important;
  }

  .blink {
    animation: blink 1s infinite;
  }

  @keyframes blink {
    50% { opacity: 0.7; }
  }

  #modalButtons {
    margin-bottom: 15px;
    text-align: center;
  }

  #modalButtons button {
    margin: 0 8px;
    padding: 10px 16px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
  }

  #modalButtons button:hover {
    background: #2980b9;
  }

  /* ===== TOAST ===== */
  #toast {
    visibility: hidden;
    min-width: 250px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 16px;
    position: fixed;
    z-index: 1001;
    left: 50%;
    bottom: 30px;
    transform: translateX(-50%);
    font-size: 16px;
  }

  #toast.show {
    visibility: visible;
    animation: fadein 0.5s, fadeout 0.5s 2.5s;
  }

  @keyframes fadein {
    from { bottom: 0; opacity: 0; }
    to { bottom: 30px; opacity: 1; }
  }

  @keyframes fadeout {
    from { bottom: 30px; opacity: 1; }
    to { bottom: 0; opacity: 0; }
  }

  /* ===== LOADING OVERLAY ===== */
  #loadingOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255,255,255,0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    font-size: 18px;
    color: #2c3e50;
  }

  .spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 600px) {
    #matrixTable {
      font-size: 12px;
    }
    #matrixTable th, #matrixTable td {
      padding: 6px 4px;
    }
    h2 { font-size: 18px; }
  }
</style>
</head>
<body>

<!-- Loading -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <p>Loading rack...</p>
</div>

<h2>Merotra Network Rack</h2>

<!-- Table Container -->
<div id="matrixHolder">
<table id="matrixTable">
<tr>
  <th></th>
  <th></th>
  <th>Pon1</th><th>Pon2</th><th>Pon3</th><th>Pon4</th>
  <th>Pon5</th><th>Pon6</th><th>Pon7</th><th>Pon8</th>
  <th>Total</th>
</tr>
<!-- Separator for Merotra window -->
<tr class="separator">
  <th colspan="11">Merotra window Duda</th>
</tr>
<!-- O1I5 -->
<tr>
  <th rowspan="4" class="olt-name">O1I5</th>
  <th>Users</th>
  <td id="pon1-O1I5" class="clickable">Hourglass</td>
  <td id="pon2-O1I5" class="clickable">Hourglass</td>
  <td id="pon3-O1I5" class="clickable">Hourglass</td>
  <td id="pon4-O1I5" class="clickable">Hourglass</td>
  <td id="pon5-O1I5" class="clickable">Hourglass</td>
  <td id="pon6-O1I5" class="clickable">Hourglass</td>
  <td id="pon7-O1I5" class="clickable">Hourglass</td>
  <td id="pon8-O1I5" class="clickable">Hourglass</td>
  <td id="oltTotal-O1I5" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O1I5" class="clickable">Hourglass</td>
  <td id="off2-O1I5" class="clickable">Hourglass</td>
  <td id="off3-O1I5" class="clickable">Hourglass</td>
  <td id="off4-O1I5" class="clickable">Hourglass</td>
  <td id="off5-O1I5" class="clickable">Hourglass</td>
  <td id="off6-O1I5" class="clickable">Hourglass</td>
  <td id="off7-O1I5" class="clickable">Hourglass</td>
  <td id="off8-O1I5" class="clickable">Hourglass</td>
  <td id="oltOffTotal-O1I5" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Ticket</th>
  <td id="tick1-O1I5" class="clickable">Hourglass</td>
  <td id="tick2-O1I5" class="clickable">Hourglass</td>
  <td id="tick3-O1I5" class="clickable">Hourglass</td>
  <td id="tick4-O1I5" class="clickable">Hourglass</td>
  <td id="tick5-O1I5" class="clickable">Hourglass</td>
  <td id="tick6-O1I5" class="clickable">Hourglass</td>
  <td id="tick7-O1I5" class="clickable">Hourglass</td>
  <td id="tick8-O1I5" class="clickable">Hourglass</td>
  <td id="oltTickTotal-O1I5" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Line</th>
  <td id="stat1-O1I5">Hourglass</td>
  <td id="stat2-O1I5">Hourglass</td>
  <td id="stat3-O1I5">Hourglass</td>
  <td id="stat4-O1I5">Hourglass</td>
  <td id="stat5-O1I5">Hourglass</td>
  <td id="stat6-O1I5">Hourglass</td>
  <td id="stat7-O1I5">Hourglass</td>
  <td id="stat8-O1I5">Hourglass</td>
  <td></td>
</tr>
<!-- O2I6 -->
<tr>
  <th rowspan="4" class="olt-name">O2I6</th>
  <th>Users</th>
  <td id="pon1-O2I6" class="clickable">Hourglass</td>
  <td id="pon2-O2I6" class="clickable">Hourglass</td>
  <td id="pon3-O2I6" class="clickable">Hourglass</td>
  <td id="pon4-O2I6" class="clickable">Hourglass</td>
  <td id="pon5-O2I6" class="clickable">Hourglass</td>
  <td id="pon6-O2I6" class="clickable">Hourglass</td>
  <td id="pon7-O2I6" class="clickable">Hourglass</td>
  <td id="pon8-O2I6" class="clickable">Hourglass</td>
  <td id="oltTotal-O2I6" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O2I6" class="clickable">Hourglass</td>
  <td id="off2-O2I6" class="clickable">Hourglass</td>
  <td id="off3-O2I6" class="clickable">Hourglass</td>
  <td id="off4-O2I6" class="clickable">Hourglass</td>
  <td id="off5-O2I6" class="clickable">Hourglass</td>
  <td id="off6-O2I6" class="clickable">Hourglass</td>
  <td id="off7-O2I6" class="clickable">Hourglass</td>
  <td id="off8-O2I6" class="clickable">Hourglass</td>
  <td id="oltOffTotal-O2I6" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Ticket</th>
  <td id="tick1-O2I6" class="clickable">Hourglass</td>
  <td id="tick2-O2I6" class="clickable">Hourglass</td>
  <td id="tick3-O2I6" class="clickable">Hourglass</td>
  <td id="tick4-O2I6" class="clickable">Hourglass</td>
  <td id="tick5-O2I6" class="clickable">Hourglass</td>
  <td id="tick6-O2I6" class="clickable">Hourglass</td>
  <td id="tick7-O2I6" class="clickable">Hourglass</td>
  <td id="tick8-O2I6" class="clickable">Hourglass</td>
  <td id="oltTickTotal-O2I6" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Line</th>
  <td id="stat1-O2I6">Hourglass</td>
  <td id="stat2-O2I6">Hourglass</td>
  <td id="stat3-O2I6">Hourglass</td>
  <td id="stat4-O2I6">Hourglass</td>
  <td id="stat5-O2I6">Hourglass</td>
  <td id="stat6-O2I6">Hourglass</td>
  <td id="stat7-O2I6">Hourglass</td>
  <td id="stat8-O2I6">Hourglass</td>
  <td></td>
</tr>
<!-- O3I7 -->
<tr>
  <th rowspan="4" class="olt-name">O3I7</th>
  <th>Users</th>
  <td id="pon1-O3I7" class="clickable">Hourglass</td>
  <td id="pon2-O3I7" class="clickable">Hourglass</td>
  <td id="pon3-O3I7" class="clickable">Hourglass</td>
  <td id="pon4-O3I7" class="clickable">Hourglass</td>
  <td colspan="4"></td>
  <td id="oltTotal-O3I7" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O3I7" class="clickable">Hourglass</td>
  <td id="off2-O3I7" class="clickable">Hourglass</td>
  <td id="off3-O3I7" class="clickable">Hourglass</td>
  <td id="off4-O3I7" class="clickable">Hourglass</td>
  <td colspan="4"></td>
  <td id="oltOffTotal-O3I7" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Ticket</th>
  <td id="tick1-O3I7" class="clickable">Hourglass</td>
  <td id="tick2-O3I7" class="clickable">Hourglass</td>
  <td id="tick3-O3I7" class="clickable">Hourglass</td>
  <td id="tick4-O3I7" class="clickable">Hourglass</td>
  <td colspan="4"></td>
  <td id="oltTickTotal-O3I7" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Line</th>
  <td id="stat1-O3I7">Hourglass</td>
  <td id="stat2-O3I7">Hourglass</td>
  <td id="stat3-O3I7">Hourglass</td>
  <td id="stat4-O3I7">Hourglass</td>
  <td colspan="4"></td>
  <td></td>
</tr>
<!-- Separator for Sarosa Distance OLT -->
<tr class="separator">
  <th colspan="11">Sarosa Distance OLT</th>
</tr>
<!-- O4I9 -->
<tr>
  <th rowspan="4" class="olt-name">O4I9</th>
  <th>Users</th>
  <td id="pon1-O4I9" class="clickable">Hourglass</td>
  <td id="pon2-O4I9" class="clickable">Hourglass</td>
  <td id="pon3-O4I9" class="clickable">Hourglass</td>
  <td id="pon4-O4I9" class="clickable">Hourglass</td>
  <td colspan="4"></td>
  <td id="oltTotal-O4I9" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O4I9" class="clickable">Hourglass</td>
  <td id="off2-O4I9" class="clickable">Hourglass</td>
  <td id="off3-O4I9" class="clickable">Hourglass</td>
  <td id="off4-O4I9" class="clickable">Hourglass</td>
  <td colspan="4"></td>
  <td id="oltOffTotal-O4I9" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Ticket</th>
  <td id="tick1-O4I9" class="clickable">Hourglass</td>
  <td id="tick2-O4I9" class="clickable">Hourglass</td>
  <td id="tick3-O4I9" class="clickable">Hourglass</td>
  <td id="tick4-O4I9" class="clickable">Hourglass</td>
  <td colspan="4"></td>
  <td id="oltTickTotal-O4I9" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Line</th>
  <td id="stat1-O4I9">Hourglass</td>
  <td id="stat2-O4I9">Hourglass</td>
  <td id="stat3-O4I9">Hourglass</td>
  <td id="stat4-O4I9">Hourglass</td>
  <td colspan="4"></td>
  <td></td>
</tr>
<!-- Separator for Budheshwar window -->
<tr class="separator">
  <th colspan="11">Budheshwar Window</th>
</tr>
<!-- O5I2 -->
<tr>
  <th rowspan="4" class="olt-name">O5I2</th>
  <th>Users</th>
  <td id="pon1-O5I2" class="clickable">Hourglass</td>
  <td id="pon2-O5I2" class="clickable">Hourglass</td>
  <td id="pon3-O5I2" class="clickable">Hourglass</td>
  <td id="pon4-O5I2" class="clickable">Hourglass</td>
  <td id="pon5-O5I2" class="clickable">Hourglass</td>
  <td id="pon6-O5I2" class="clickable">Hourglass</td>
  <td id="pon7-O5I2" class="clickable">Hourglass</td>
  <td id="pon8-O5I2" class="clickable">Hourglass</td>
  <td id="oltTotal-O5I2" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Offline</th>
  <td id="off1-O5I2" class="clickable">Hourglass</td>
  <td id="off2-O5I2" class="clickable">Hourglass</td>
  <td id="off3-O5I2" class="clickable">Hourglass</td>
  <td id="off4-O5I2" class="clickable">Hourglass</td>
  <td id="off5-O5I2" class="clickable">Hourglass</td>
  <td id="off6-O5I2" class="clickable">Hourglass</td>
  <td id="off7-O5I2" class="clickable">Hourglass</td>
  <td id="off8-O5I2" class="clickable">Hourglass</td>
  <td id="oltOffTotal-O5I2" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Ticket</th>
  <td id="tick1-O5I2" class="clickable">Hourglass</td>
  <td id="tick2-O5I2" class="clickable">Hourglass</td>
  <td id="tick3-O5I2" class="clickable">Hourglass</td>
  <td id="tick4-O5I2" class="clickable">Hourglass</td>
  <td id="tick5-O5I2" class="clickable">Hourglass</td>
  <td id="tick6-O5I2" class="clickable">Hourglass</td>
  <td id="tick7-O5I2" class="clickable">Hourglass</td>
  <td id="tick8-O5I2" class="clickable">Hourglass</td>
  <td id="oltTickTotal-O5I2" class="clickable">Hourglass</td>
</tr>
<tr>
  <th>Line</th>
  <td id="stat1-O5I2">Hourglass</td>
  <td id="stat2-O5I2">Hourglass</td>
  <td id="stat3-O5I2">Hourglass</td>
  <td id="stat4-O5I2">Hourglass</td>
  <td id="stat5-O5I2">Hourglass</td>
  <td id="stat6-O5I2">Hourglass</td>
  <td id="stat7-O5I2">Hourglass</td>
  <td id="stat8-O5I2">Hourglass</td>
  <td></td>
</tr>
</table>
</div>

<!-- Modal -->
<div id="userModal">
  <div id="userModalContent">
    <span class="closeBtn" onclick="closeModal()">&times;</span>
    <div id="modalButtons"></div>
    <div id="screenshotContent">
      <h3 id="modalTitle">Users Details</h3>
      <div id="modalSubTitle"></div>
      <div id="userDetails"></div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast">No user in list!!</div>

<!-- ====================== JAVASCRIPT (सब अंदर) ====================== -->
<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzliBfK4lJmojz4wSUZVcJBg1UDu47WlLvHA5GSAFk84EPd1w4cT62Dw5PqpsuemybXww/exec';
const TOKEN = 'abcd1234';
const STATUS_LINK = 'https://script.google.com/macros/s/AKfycbx4y-2MDbT1aNzC1R2PvS041XL84Cqs0cbrZ0vIj2A/dev';
let oltData = {};
let dashboardA7 = null;

async function loadData() {
  const url = WEB_APP_URL + '?token=' + encodeURIComponent(TOKEN);
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
    const data = await response.json();
    if (data.error) throw new Error(data.error);
    const rows = data.rows || [];
    dashboardA7 = data.dashboardA7 !== undefined && data.dashboardA7 !== null ? Number(data.dashboardA7) : null;
    const olts = [
      { id: 'O1I5', pons: 8 },
      { id: 'O2I6', pons: 8 },
      { id: 'O3I7', pons: 4 },
      { id: 'O4I9', pons: 4 },
      { id: 'O5I2', pons: 8 }
    ];
    for (let oltObj of olts) {
      const olt = oltObj.id;
      const maxPon = oltObj.pons;
      let total = 0, offTotal = 0, tickTotal = 0;
      for (let i = 1; i <= maxPon; i++) {
        const nmid = olt + 'P' + i;
        const filtered = rows.filter(r => r['NMID'] === nmid && r['Users']);
        const allRows = filtered;
        const offRows = filtered.filter(r => r['Downs']);
        const tickRows = filtered.filter(r => r['Ticket']);
        const dropTimes = filtered.map(r => r['Drops']).filter(v => v && v !== '');
        oltData[nmid] = { all: allRows, off: offRows, tick: tickRows, drops: dropTimes };
        document.getElementById(`pon${i}-${olt}`).textContent = allRows.length;
        document.getElementById(`off${i}-${olt}`).textContent = offRows.length;
        document.getElementById(`tick${i}-${olt}`).textContent = tickRows.length;
        let statusCell = document.getElementById(`stat${i}-${olt}`);
        let dropCount = dropTimes.length;
        if (dashboardA7 !== null && !isNaN(dashboardA7)) {
          let isOn = dropCount < dashboardA7;
          if (isOn) {
            statusCell.innerHTML = `<a href="${STATUS_LINK}" target="_self">Green Circle</a>`;
            statusCell.className = "onStatus clickable";
          } else {
            statusCell.innerHTML = `<a href="${STATUS_LINK}" target="_self">Red Circle</a>`;
            statusCell.className = "offStatus clickable";
          }
        } else {
          statusCell.textContent = "-";
          statusCell.className = "";
        }
        total += allRows.length;
        offTotal += offRows.length;
        tickTotal += tickRows.length;
      }
      document.getElementById(`oltTotal-${olt}`).textContent = total;
      document.getElementById(`oltOffTotal-${olt}`).textContent = offTotal;
      document.getElementById(`oltTickTotal-${olt}`).textContent = tickTotal;
    }
    attachEventListeners();
    document.getElementById('loadingOverlay').style.display = 'none';
  } catch (err) {
    console.error('Fetch error:', err);
    const olts = [
      { id: 'O1I5', pons: 8 },
      { id: 'O2I6', pons: 8 },
      { id: 'O3I7', pons: 4 },
      { id: 'O4I9', pons: 4 },
      { id: 'O5I2', pons: 8 }
    ];
    for (let oltObj of olts) {
      const olt = oltObj.id;
      const maxPon = oltObj.pons;
      formando
      for (let i = 1; i <= maxPon; i++) {
        document.getElementById(`pon${i}-${olt}`).textContent = 'Error';
        document.getElementById(`off${i}-${olt}`).textContent = 'Error';
        document.getElementById(`tick${i}-${olt}`).textContent = 'Error';
        document.getElementById(`stat${i}-${olt}`).textContent = '-';
      }
      document.getElementById(`oltTotal-${olt}`).textContent = 'Error';
      document.getElementById(`oltOffTotal-${olt}`).textContent = 'Error';
      document.getElementById(`oltTickTotal-${olt}`).textContent = 'Error';
    }
    document.getElementById('loadingOverlay').style.display = 'none';
  }
}

function showToast() {
  const toast = document.getElementById('toast');
  toast.className = 'show';
  setTimeout(() => { toast.className = ''; }, 3000);
}

function attachEventListeners() {
  const olts = [
    { id: 'O1I5', pons: 8 },
    { id: 'O2I6', pons: 8 },
    { id: 'O3I7', pons: 4 },
    { id: 'O4I9', pons: 4 },
    { id: 'O5I2', pons: 8 }
  ];
  for (let oltObj of olts) {
    const olt = oltObj.id;
    const maxPon = oltObj.pons;
    for (let i = 1; i <= maxPon; i++) {
      const ponElement = document.getElementById(`pon${i}-${olt}`);
      const offElement = document.getElementById(`off${i}-${olt}`);
      const tickElement = document.getElementById(`tick${i}-${olt}`);
      if (ponElement) {
        ponElement.addEventListener('click', () => {
          if (ponElement.textContent === '0') showToast();
          else showUsers('all', `${olt}P${i}`, olt, `P${i}`);
        });
      }
      if (offElement) {
        offElement.addEventListener('click', () => {
          if (offElement.textContent === '0') showToast();
          else showUsers('off', `${olt}P${i}`, olt, `P${i}`);
        });
      }
      if (tickElement) {
        tickElement.addEventListener('click', () => {
          if (tickElement.textContent === '0') showToast();
          else showUsers('tick', `${olt}P${i}`, olt, `P${i}`);
        });
      }
    }
    const totalElement = document.getElementById(`oltTotal-${olt}`);
    const offTotalElement = document.getElementById(`oltOffTotal-${olt}`);
    const tickTotalElement = document.getElementById(`oltTickTotal-${olt}`);
    if (totalElement) {
      totalElement.addEventListener('click', () => {
        if (totalElement.textContent === '0') showToast();
        else showOltUsers('all', olt, maxPon);
      });
    }
    if (offTotalElement) {
      offTotalElement.addEventListener('click', () => {
        if (offTotalElement.textContent === '0') showToast();
        else showOltUsers('off', olt, maxPon);
      });
    }
    if (tickTotalElement) {
      tickTotalElement.addEventListener('click', () => {
        if (tickTotalElement.textContent === '0') showToast();
        else showOltUsers('tick', olt, maxPon);
      });
    }
  }
}

function showUsers(type, nmid, olt, pon) {
  let title = type === "off" ? "Offline Users Details" : type === "tick" ? "Ticket Users Details" : "Users Details";
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalSubTitle').textContent = `OLT: ${olt} PON: ${pon}`;
  const currentUsers = (oltData[nmid] && oltData[nmid][type]) || [];
  if (currentUsers.length === 0) { showToast(); return; }

  const userDetails = document.getElementById('userDetails');
  userDetails.innerHTML = '<table><thead><tr><th>Sn</th><th>Name</th><th>Number</th><th>Location</th><th>Address</th><th>Power</th><th>Remarks</th></tr></thead><tbody></tbody></table>';
  const tbody = userDetails.querySelector('tbody');
  currentUsers.forEach((r, index) => {
    const tr = document.createElement('tr');
    if (r['Ticket']) tr.classList.add('red', 'blink');
    else if (r['Downs']) tr.classList.add('pink', 'blink');
    const number = (r['Last called no'] && r['Last called no'].trim()) ? r['Last called no'].trim() : (r['Number'] || '');
    tr.innerHTML = `<td>${index + 1}</td><td>${r['Name'] || ''}</td><td>${number}</td><td>${r['Location'] || ''}</td><td>${r['Address'] || ''}</td><td>${r['Power'] || ''}</td><td>${r['Remarks'] || ''}</td>`;
    tbody.appendChild(tr);
  });

  const modalButtons = document.getElementById('modalButtons');
  modalButtons.innerHTML = '';
  const downloadBtn = document.createElement('button');
  downloadBtn.textContent = 'Download CSV';
  downloadBtn.onclick = () => {
    let csv = 'Sn,Name,Number,Location,Address,Power,Remarks\n';
    currentUsers.forEach((r, index) => {
      const number = (r['Last called no'] && r['Last called no'].trim()) ? r['Last called no'].trim() : (r['Number'] || '');
      const row = [index + 1, r['Name'] || '', number, r['Location'] || '', r['Address'] || '', r['Power'] || '', r['Remarks'] || '']
        .map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
      csv += row + '\n';
    });
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'users.csv'; a.click();
    URL.revokeObjectURL(url);
  };
  modalButtons.appendChild(downloadBtn);

  const shareBtn = document.createElement('button');
  shareBtn.textContent = 'Share Screenshot on WhatsApp';
  shareBtn.onclick = () => {
    html2canvas(document.getElementById('screenshotContent'), {scale: 2}).then(canvas => {
      canvas.toBlob(blob => {
        const file = new File([blob], 'screenshot.png', {type: 'image/png'});
        if (navigator.canShare && navigator.canShare({files: [file]})) {
          navigator.share({files: [file]}).catch(() => downloadBlob(blob));
        } else downloadBlob(blob);
        function downloadBlob(b) {
          const url = URL.createObjectURL(b);
          const a = document.createElement('a');
          a.href = url; a.download = 'screenshot.png'; a.click();
          URL.revokeObjectURL(url);
        }
      });
    });
  };
  modalButtons.appendChild(shareBtn);

  document.getElementById('userModal').style.display = 'flex';
}

function showOltUsers(type, olt, maxPon) {
  let title = type === "off" ? "All Offline Users Details" : type === "tick" ? "All Ticket Users Details" : "All Users Details";
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalSubTitle').textContent = `OLT: ${olt}`;
  let currentUsers = [];
  for (let i = 1; i <= maxPon; i++) {
    const nmid = olt + 'P' + i;
    if (oltData[nmid] && oltData[nmid][type]) currentUsers.push(...oltData[nmid][type]);
  }
  if (currentUsers.length === 0) { showToast(); return; }
  showUsers(type, null, olt, 'All PONs'); // Reuse showUsers logic
}

function closeModal() {
  document.getElementById('userModal').style.display = 'none';
}

window.addEventListener('load', () => {
  loadData();
  setInterval(loadData, 30000);
});
</script>

</body>
</html>
