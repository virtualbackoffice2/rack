<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Merotra Network Table</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h2>Merotra Network</h2>
  <div id="matrixHolder">
    <table id="matrixTable">
      <tr>
        <th></th>
        <th></th>
        <th>Pon1</th><th>Pon2</th><th>Pon3</th><th>Pon4</th>
        <th>Pon5</th><th>Pon6</th><th>Pon7</th><th>Pon8</th>
        <th>Total</th>
      </tr>
      <!-- Separator for Merotra window -->
      <tr class="separator">
        <th colspan="11">Merotra window</th>
      </tr>
      <!-- O1I5 -->
      <tr>
        <th rowspan="4" class="olt-name">O1I5</th>
        <th>Users</th>
        <td id="pon1-O1I5" class="clickable">‚è≥</td>
        <td id="pon2-O1I5" class="clickable">‚è≥</td>
        <td id="pon3-O1I5" class="clickable">‚è≥</td>
        <td id="pon4-O1I5" class="clickable">‚è≥</td>
        <td id="pon5-O1I5" class="clickable">‚è≥</td>
        <td id="pon6-O1I5" class="clickable">‚è≥</td>
        <td id="pon7-O1I5" class="clickable">‚è≥</td>
        <td id="pon8-O1I5" class="clickable">‚è≥</td>
        <td id="oltTotal-O1I5" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Offline</th>
        <td id="off1-O1I5" class="clickable">‚è≥</td>
        <td id="off2-O1I5" class="clickable">‚è≥</td>
        <td id="off3-O1I5" class="clickable">‚è≥</td>
        <td id="off4-O1I5" class="clickable">‚è≥</td>
        <td id="off5-O1I5" class="clickable">‚è≥</td>
        <td id="off6-O1I5" class="clickable">‚è≥</td>
        <td id="off7-O1I5" class="clickable">‚è≥</td>
        <td id="off8-O1I5" class="clickable">‚è≥</td>
        <td id="oltOffTotal-O1I5" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Ticket</th>
        <td id="tick1-O1I5" class="clickable">‚è≥</td>
        <td id="tick2-O1I5" class="clickable">‚è≥</td>
        <td id="tick3-O1I5" class="clickable">‚è≥</td>
        <td id="tick4-O1I5" class="clickable">‚è≥</td>
        <td id="tick5-O1I5" class="clickable">‚è≥</td>
        <td id="tick6-O1I5" class="clickable">‚è≥</td>
        <td id="tick7-O1I5" class="clickable">‚è≥</td>
        <td id="tick8-O1I5" class="clickable">‚è≥</td>
        <td id="oltTickTotal-O1I5" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Line</th>
        <td id="stat1-O1I5" class="status-link">‚è≥</td>
        <td id="stat2-O1I5" class="status-link">‚è≥</td>
        <td id="stat3-O1I5" class="status-link">‚è≥</td>
        <td id="stat4-O1I5" class="status-link">‚è≥</td>
        <td id="stat5-O1I5" class="status-link">‚è≥</td>
        <td id="stat6-O1I5" class="status-link">‚è≥</td>
        <td id="stat7-O1I5" class="status-link">‚è≥</td>
        <td id="stat8-O1I5" class="status-link">‚è≥</td>
        <td></td>
      </tr>
      <!-- O2I6 -->
      <tr>
        <th rowspan="4" class="olt-name">O2I6</th>
        <th>Users</th>
        <td id="pon1-O2I6" class="clickable">‚è≥</td>
        <td id="pon2-O2I6" class="clickable">‚è≥</td>
        <td id="pon3-O2I6" class="clickable">‚è≥</td>
        <td id="pon4-O2I6" class="clickable">‚è≥</td>
        <td id="pon5-O2I6" class="clickable">‚è≥</td>
        <td id="pon6-O2I6" class="clickable">‚è≥</td>
        <td id="pon7-O2I6" class="clickable">‚è≥</td>
        <td id="pon8-O2I6" class="clickable">‚è≥</td>
        <td id="oltTotal-O2I6" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Offline</th>
        <td id="off1-O2I6" class="clickable">‚è≥</td>
        <td id="off2-O2I6" class="clickable">‚è≥</td>
        <td id="off3-O2I6" class="clickable">‚è≥</td>
        <td id="off4-O2I6" class="clickable">‚è≥</td>
        <td id="off5-O2I6" class="clickable">‚è≥</td>
        <td id="off6-O2I6" class="clickable">‚è≥</td>
        <td id="off7-O2I6" class="clickable">‚è≥</td>
        <td id="off8-O2I6" class="clickable">‚è≥</td>
        <td id="oltOffTotal-O2I6" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Ticket</th>
        <td id="tick1-O2I6" class="clickable">‚è≥</td>
        <td id="tick2-O2I6" class="clickable">‚è≥</td>
        <td id="tick3-O2I6" class="clickable">‚è≥</td>
        <td id="tick4-O2I6" class="clickable">‚è≥</td>
        <td id="tick5-O2I6" class="clickable">‚è≥</td>
        <td id="tick6-O2I6" class="clickable">‚è≥</td>
        <td id="tick7-O2I6" class="clickable">‚è≥</td>
        <td id="tick8-O2I6" class="clickable">‚è≥</td>
        <td id="oltTickTotal-O2I6" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Line</th>
        <td id="stat1-O2I6" class="status-link">‚è≥</td>
        <td id="stat2-O2I6" class="status-link">‚è≥</td>
        <td id="stat3-O2I6" class="status-link">‚è≥</td>
        <td id="stat4-O2I6" class="status-link">‚è≥</td>
        <td id="stat5-O2I6" class="status-link">‚è≥</td>
        <td id="stat6-O2I6" class="status-link">‚è≥</td>
        <td id="stat7-O2I6" class="status-link">‚è≥</td>
        <td id="stat8-O2I6" class="status-link">‚è≥</td>
        <td></td>
      </tr>
      <!-- O3I7 -->
      <tr>
        <th rowspan="4" class="olt-name">O3I7</th>
        <th>Users</th>
        <td id="pon1-O3I7" class="clickable">‚è≥</td>
        <td id="pon2-O3I7" class="clickable">‚è≥</td>
        <td id="pon3-O3I7" class="clickable">‚è≥</td>
        <td id="pon4-O3I7" class="clickable">‚è≥</td>
        <td colspan="4"></td>
        <td id="oltTotal-O3I7" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Offline</th>
        <td id="off1-O3I7" class="clickable">‚è≥</td>
        <td id="off2-O3I7" class="clickable">‚è≥</td>
        <td id="off3-O3I7" class="clickable">‚è≥</td>
        <td id="off4-O3I7" class="clickable">‚è≥</td>
        <td colspan="4"></td>
        <td id="oltOffTotal-O3I7" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Ticket</th>
        <td id="tick1-O3I7" class="clickable">‚è≥</td>
        <td id="tick2-O3I7" class="clickable">‚è≥</td>
        <td id="tick3-O3I7" class="clickable">‚è≥</td>
        <td id="tick4-O3I7" class="clickable">‚è≥</td>
        <td colspan="4"></td>
        <td id="oltTickTotal-O3I7" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Line</th>
        <td id="stat1-O3I7" class="status-link">‚è≥</td>
        <td id="stat2-O3I7" class="status-link">‚è≥</td>
        <td id="stat3-O3I7" class="status-link">‚è≥</td>
        <td id="stat4-O3I7" class="status-link">‚è≥</td>
        <td colspan="4"></td>
        <td></td>
      </tr>
      <!-- Separator for Sarosa Distance OLT -->
      <tr class="separator">
        <th colspan="11">Sarosa Distance OLT</th>
      </tr>
      <!-- O4I9 -->
      <tr>
        <th rowspan="4" class="olt-name">O4I9</th>
        <th>Users</th>
        <td id="pon1-O4I9" class="clickable">‚è≥</td>
        <td id="pon2-O4I9" class="clickable">‚è≥</td>
        <td id="pon3-O4I9" class="clickable">‚è≥</td>
        <td id="pon4-O4I9" class="clickable">‚è≥</td>
        <td colspan="4"></td>
        <td id="oltTotal-O4I9" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Offline</th>
        <td id="off1-O4I9" class="clickable">‚è≥</td>
        <td id="off2-O4I9" class="clickable">‚è≥</td>
        <td id="off3-O4I9" class="clickable">‚è≥</td>
        <td id="off4-O4I9" class="clickable">‚è≥</td>
        <td colspan="4"></td>
        <td id="oltOffTotal-O4I9" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Ticket</th>
        <td id="tick1-O4I9" class="clickable">‚è≥</td>
        <td id="tick2-O4I9" class="clickable">‚è≥</td>
        <td id="tick3-O4I9" class="clickable">‚è≥</td>
        <td id="tick4-O4I9" class="clickable">‚è≥</td>
        <td colspan="4"></td>
        <td id="oltTickTotal-O4I9" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Line</th>
        <td id="stat1-O4I9" class="status-link">‚è≥</td>
        <td id="stat2-O4I9" class="status-link">‚è≥</td>
        <td id="stat3-O4I9" class="status-link">‚è≥</td>
        <td id="stat4-O4I9" class="status-link">‚è≥</td>
        <td colspan="4"></td>
        <td></td>
      </tr>
      <!-- Separator for Budheshwar window -->
      <tr class="separator">
        <th colspan="11">Budheshwar window ki OLT</th>
      </tr>
      <!-- O5I2 -->
      <tr>
        <th rowspan="4" class="olt-name">O5I2</th>
        <th>Users</th>
        <td id="pon1-O5I2" class="clickable">‚è≥</td>
        <td id="pon2-O5I2" class="clickable">‚è≥</td>
        <td id="pon3-O5I2" class="clickable">‚è≥</td>
        <td id="pon4-O5I2" class="clickable">‚è≥</td>
        <td id="pon5-O5I2" class="clickable">‚è≥</td>
        <td id="pon6-O5I2" class="clickable">‚è≥</td>
        <td id="pon7-O5I2" class="clickable">‚è≥</td>
        <td id="pon8-O5I2" class="clickable">‚è≥</td>
        <td id="oltTotal-O5I2" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Offline</th>
        <td id="off1-O5I2" class="clickable">‚è≥</td>
        <td id="off2-O5I2" class="clickable">‚è≥</td>
        <td id="off3-O5I2" class="clickable">‚è≥</td>
        <td id="off4-O5I2" class="clickable">‚è≥</td>
        <td id="off5-O5I2" class="clickable">‚è≥</td>
        <td id="off6-O5I2" class="clickable">‚è≥</td>
        <td id="off7-O5I2" class="clickable">‚è≥</td>
        <td id="off8-O5I2" class="clickable">‚è≥</td>
        <td id="oltOffTotal-O5I2" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Ticket</th>
        <td id="tick1-O5I2" class="clickable">‚è≥</td>
        <td id="tick2-O5I2" class="clickable">‚è≥</td>
        <td id="tick3-O5I2" class="clickable">‚è≥</td>
        <td id="tick4-O5I2" class="clickable">‚è≥</td>
        <td id="tick5-O5I2" class="clickable">‚è≥</td>
        <td id="tick6-O5I2" class="clickable">‚è≥</td>
        <td id="tick7-O5I2" class="clickable">‚è≥</td>
        <td id="tick8-O5I2" class="clickable">‚è≥</td>
        <td id="oltTickTotal-O5I2" class="clickable">‚è≥</td>
      </tr>
      <tr>
        <th>Line</th>
        <td id="stat1-O5I2" class="status-link">‚è≥</td>
        <td id="stat2-O5I2" class="status-link">‚è≥</td>
        <td id="stat3-O5I2" class="status-link">‚è≥</td>
        <td id="stat4-O5I2" class="status-link">‚è≥</td>
        <td id="stat5-O5I2" class="status-link">‚è≥</td>
        <td id="stat6-O5I2" class="status-link">‚è≥</td>
        <td id="stat7-O5I2" class="status-link">‚è≥</td>
        <td id="stat8-O5I2" class="status-link">‚è≥</td>
        <td></td>
      </tr>
    </table>
  </div>
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p>Loading data...</p>
  </div>
  <!-- Modal -->
  <div id="userModal">
    <div id="userModalContent">
      <span class="closeBtn" onclick="closeModal()">&times;</span>
      <div id="screenshotContent">
        <h3 id="modalTitle">Users Details</h3>
        <div id="modalSubTitle"></div>
        <div id="modalButtons"></div>
        <div id="userDetails"></div>
      </div>
    </div>
  </div>
  <!-- Toast -->
  <div id="toast">No user in list!!</div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-FZM6fwvv0ruaSv-PbEG8sHNOmldJn6kXtRY6e7NZ9YlN3TJ5Oe9ECMwmGBTK-LMTnA/exec';
    const TOKEN = 'abcd1234';
    const STATUS_LINK_URL = 'https://script.google.com/macros/s/AKfycbx4y-2MDbT1aNzC1R2PvS041XL84Cqs0cbrZ0vIj2A/dev';

    let oltData = {};
    let dashboardA7 = null;

    async function loadData() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      loadingOverlay.style.display = 'flex';
      const url = WEB_APP_URL + '?token=' + encodeURIComponent(TOKEN);
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Network response was not ok: ' + response.statusText);
        const data = await response.json();
        if (data.error) throw new Error(data.error);

        const rows = data.rows || [];
        dashboardA7 = data.dashboardA7 !== undefined && data.dashboardA7 !== null ? Number(data.dashboardA7) : null;

        const olts = [
          { id: 'O1I5', pons: 8 },
          { id: 'O2I6', pons: 8 },
          { id: 'O3I7', pons: 4 },
          { id: 'O4I9', pons: 4 },
          { id: 'O5I2', pons: 8 }
        ];

        for (let oltObj of olts) {
          const olt = oltObj.id;
          const maxPon = oltObj.pons;
          let total = 0, offTotal = 0, tickTotal = 0;
          for (let i = 1; i <= maxPon; i++) {
            const nmid = olt + 'P' + i;
            const filtered = rows.filter(r => r['NMID'] === nmid && r['Users']);

            const allRows = filtered;
            const offRows = filtered.filter(r => r['Downs']);
            const tickRows = filtered.filter(r => r['Ticket']);
            const dropTimes = filtered.map(r => r['Drops']).filter(v => v && v !== '');

            oltData[nmid] = { all: allRows, off: offRows, tick: tickRows, drops: dropTimes };

            document.getElementById(`pon${i}-${olt}`).textContent = allRows.length;
            document.getElementById(`off${i}-${olt}`).textContent = offRows.length;
            document.getElementById(`tick${i}-${olt}`).textContent = tickRows.length;

            let statusCell = document.getElementById(`stat${i}-${olt}`);
            let dropCount = dropTimes.length;
            if (dashboardA7 !== null && !isNaN(dashboardA7)) {
              let isOn = dropCount < dashboardA7;
              if (isOn) {
                statusCell.textContent = "üü¢";
                statusCell.className = "status-link onStatus";
              } else {
                statusCell.textContent = "üî¥";
                statusCell.className = "status-link offStatus blink-red-dot";
              }
            } else {
              statusCell.textContent = "-";
              statusCell.className = "status-link";
            }

            total += allRows.length;
            offTotal += offRows.length;
            tickTotal += tickRows.length;
          }

          document.getElementById(`oltTotal-${olt}`).textContent = total;
          document.getElementById(`oltOffTotal-${olt}`).textContent = offTotal;
          document.getElementById(`oltTickTotal-${olt}`).textContent = tickTotal;
        }

        attachEventListeners();
      } catch (err) {
        console.error('Fetch error:', err);
        const olts = [
          { id: 'O1I5', pons: 8 },
          { id: 'O2I6', pons: 8 },
          { id: 'O3I7', pons: 4 },
          { id: 'O4I9', pons: 4 },
          { id: 'O5I2', pons: 8 }
        ];
        for (let oltObj of olts) {
          const olt = oltObj.id;
          const maxPon = oltObj.pons;
          for (let i = 1; i <= maxPon; i++) {
            document.getElementById(`pon${i}-${olt}`).textContent = 'Error';
            document.getElementById(`off${i}-${olt}`).textContent = 'Error';
            document.getElementById(`tick${i}-${olt}`).textContent = 'Error';
            document.getElementById(`stat${i}-${olt}`).textContent = '-';
            document.getElementById(`stat${i}-${olt}`).className = "status-link";
          }
          document.getElementById(`oltTotal-${olt}`).textContent = 'Error';
          document.getElementById(`oltOffTotal-${olt}`).textContent = 'Error';
          document.getElementById(`oltTickTotal-${olt}`).textContent = 'Error';
        }
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }

    function showToast() {
      const toast = document.getElementById('toast');
      toast.className = 'show';
      setTimeout(() => { toast.className = ''; }, 3000);
    }

    function attachEventListeners() {
      const olts = [
        { id: 'O1I5', pons: 8 },
        { id: 'O2I6', pons: 8 },
        { id: 'O3I7', pons: 4 },
        { id: 'O4I9', pons: 4 },
        { id: 'O5I2', pons: 8 }
      ];
      for (let oltObj of olts) {
        const olt = oltObj.id;
        const maxPon = oltObj.pons;
        for (let i = 1; i <= maxPon; i++) {
          const ponElement = document.getElementById(`pon${i}-${olt}`);
          const offElement = document.getElementById(`off${i}-${olt}`);
          const tickElement = document.getElementById(`tick${i}-${olt}`);
          const statusElement = document.getElementById(`stat${i}-${olt}`);
          if (ponElement) {
            ponElement.addEventListener('click', () => {
              if (ponElement.textContent === '0') {
                showToast();
              } else {
                showUsers('all', `${olt}P${i}`, olt, `P${i}`);
              }
            });
          }
          if (offElement) {
            offElement.addEventListener('click', () => {
              if (offElement.textContent === '0') {
                showToast();
              } else {
                showUsers('off', `${olt}P${i}`, olt, `P${i}`);
              }
            });
          }
          if (tickElement) {
            tickElement.addEventListener('click', () => {
              if (tickElement.textContent === '0') {
                showToast();
              } else {
                showUsers('tick', `${olt}P${i}`, olt, `P${i}`);
              }
            });
          }
          if (statusElement) {
            statusElement.addEventListener('click', () => {
              if (statusElement.textContent === 'üü¢' || statusElement.textContent === 'üî¥') {
                window.location.href = STATUS_LINK_URL;
              }
            });
          }
        }
        const totalElement = document.getElementById(`oltTotal-${olt}`);
        const offTotalElement = document.getElementById(`oltOffTotal-${olt}`);
        const tickTotalElement = document.getElementById(`oltTickTotal-${olt}`);
        if (totalElement) {
          totalElement.addEventListener('click', () => {
            if (totalElement.textContent === '0') {
              showToast();
            } else {
              showOltUsers('all', olt, maxPon);
            }
          });
        }
        if (offTotalElement) {
          offTotalElement.addEventListener('click', () => {
            if (offTotalElement.textContent === '0') {
              showToast();
            } else {
              showOltUsers('off', olt, maxPon);
            }
          });
        }
        if (tickTotalElement) {
          tickTotalElement.addEventListener('click', () => {
            if (tickTotalElement.textContent === '0') {
              showToast();
            } else {
              showOltUsers('tick', olt, maxPon);
            }
          });
        }
      }
    }

    function showUsers(type, nmid, olt, pon) {
      let title = "Users Details";
      if (type === "off") title = "Offline Users Details";
      if (type === "tick") title = "Ticket Users Details";

      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalSubTitle').textContent = `OLT: ${olt} PON: ${pon}`;

      const currentUsers = (oltData[nmid] && oltData[nmid][type]) || [];

      if (currentUsers.length === 0) {
        showToast();
        return;
      }

      const modalButtons = document.getElementById('modalButtons');
      modalButtons.innerHTML = '';

      const downloadBtn = document.createElement('button');
      downloadBtn.textContent = 'Download CSV';
      downloadBtn.style.marginRight = '10px';
      downloadBtn.onclick = () => {
        try {
          let csv = 'Sn,Name,Number,Location,Address,Power,Remarks\n';
          currentUsers.forEach((r, index) => {
            const lastCalledNo = r['Last called no'];
            const number = (typeof lastCalledNo === 'string' && lastCalledNo.trim()) ? lastCalledNo.trim() : (r['Number'] || '');
            const row = [
              index + 1,
              r['Name'] || '',
              number,
              r['Location'] || '',
              r['Address'] || '',
              r['Power'] || '',
              r['Remarks'] || ''
            ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
            csv += row + '\n';
          });
          const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'users.csv';
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error('CSV download error:', err);
          alert('Failed to download CSV. Please check the console for details.');
        }
      };
      modalButtons.appendChild(downloadBtn);

      const shareBtn = document.createElement('button');
      shareBtn.textContent = 'Share Screenshot on WhatsApp';
      shareBtn.onclick = () => {
        html2canvas(document.getElementById('screenshotContent'), {scale: 2}).then(canvas => {
          canvas.toBlob(blob => {
            const file = new File([blob], 'screenshot.png', {type: 'image/png'});
            if (navigator.canShare && navigator.canShare({files: [file]})) {
              navigator.share({files: [file]}).catch(err => {
                console.error('Share failed:', err);
                alert('Sharing failed. Downloading screenshot instead.');
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'screenshot.png';
                a.click();
                URL.revokeObjectURL(url);
              });
            } else {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'screenshot.png';
              a.click();
              URL.revokeObjectURL(url);
            }
          });
        }).catch(err => {
          console.error('Screenshot error:', err);
          alert('Failed to capture screenshot. Please check the console for details.');
        });
      };
      modalButtons.appendChild(shareBtn);

      const userDetails = document.getElementById('userDetails');
      userDetails.innerHTML = '<table><thead><tr><th>Sn</th><th>Name</th><th>Number</th><th>Location</th><th>Address</th><th>Power</th><th>Remarks</th></tr></thead><tbody></tbody></table>';
      const tbody = userDetails.querySelector('tbody');

      currentUsers.forEach((r, index) => {
        const tr = document.createElement('tr');
        if (r['Ticket']) {
          tr.classList.add('red');
        } else if (r['Downs']) {
          tr.classList.add('pink');
        }
        const lastCalledNo = r['Last called no'];
        const number = (typeof lastCalledNo === 'string' && lastCalledNo.trim()) ? lastCalledNo.trim() : (r['Number'] || '');
        tr.innerHTML = `<td>${index + 1}</td><td>${r['Name'] || ''}</td><td>${number}</td><td>${r['Location'] || ''}</td><td>${r['Address'] || ''}</td><td>${r['Power'] || ''}</td><td>${r['Remarks'] || ''}</td>`;
        tbody.appendChild(tr);
      });

      document.getElementById('userModal').style.display = 'flex';
    }

    function showOltUsers(type, olt, maxPon) {
      let title = "All Users Details";
      if (type === "off") title = "All Offline Users Details";
      if (type === "tick") title = "All Ticket Users Details";

      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalSubTitle').textContent = `OLT: ${olt}`;

      let currentUsers = [];
      for (let i = 1; i <= maxPon; i++) {
        const nmid = olt + 'P' + i;
        if (oltData[nmid] && oltData[nmid][type]) {
          currentUsers.push(...oltData[nmid][type]);
        }
      }

      if (currentUsers.length === 0) {
        showToast();
        return;
      }

      const modalButtons = document.getElementById('modalButtons');
      modalButtons.innerHTML = '';

      const downloadBtn = document.createElement('button');
      downloadBtn.textContent = 'Download CSV';
      downloadBtn.style.marginRight = '10px';
      downloadBtn.onclick = () => {
        try {
          let csv = 'Sn,Name,Number,Location,Address,Power,Remarks\n';
          currentUsers.forEach((r, index) => {
            const lastCalledNo = r['Last called no'];
            const number = (typeof lastCalledNo === 'string' && lastCalledNo.trim()) ? lastCalledNo.trim() : (r['Number'] || '');
            const row = [
              index + 1,
              r['Name'] || '',
              number,
              r['Location'] || '',
              r['Address'] || '',
              r['Power'] || '',
              r['Remarks'] || ''
            ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
            csv += row + '\n';
          });
          const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'users.csv';
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error('CSV download error:', err);
          alert('Failed to download CSV. Please check the console for details.');
        }
      };
      modalButtons.appendChild(downloadBtn);

      const shareBtn = document.createElement('button');
      shareBtn.textContent = 'Share Screenshot on WhatsApp';
      shareBtn.onclick = () => {
        html2canvas(document.getElementById('screenshotContent'), {scale: 2}).then(canvas => {
          canvas.toBlob(blob => {
            const file = new File([blob], 'screenshot.png', {type: 'image/png'});
            if (navigator.canShare && navigator.canShare({files: [file]})) {
              navigator.share({files: [file]}).catch(err => {
                console.error('Share failed:', err);
                alert('Sharing failed. Downloading screenshot instead.');
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'screenshot.png';
                a.click();
                URL.revokeObjectURL(url);
              });
            } else {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'screenshot.png';
              a.click();
              URL.revokeObjectURL(url);
            }
          });
        }).catch(err => {
          console.error('Screenshot error:', err);
          alert('Failed to capture screenshot. Please check the console for details.');
        });
      };
      modalButtons.appendChild(shareBtn);

      const userDetails = document.getElementById('userDetails');
      userDetails.innerHTML = '<table><thead><tr><th>Sn</th><th>Name</th><th>Number</th><th>Location</th><th>Address</th><th>Power</th><th>Remarks</th></tr></thead><tbody></tbody></table>';
      const tbody = userDetails.querySelector('tbody');

      currentUsers.forEach((r, index) => {
        const tr = document.createElement('tr');
        if (r['Ticket']) {
          tr.classList.add('red');
        } else if (r['Downs']) {
          tr.classList.add('pink');
        }
        const lastCalledNo = r['Last called no'];
        const number = (typeof lastCalledNo === 'string' && lastCalledNo.trim()) ? lastCalledNo.trim() : (r['Number'] || '');
        tr.innerHTML = `<td>${index + 1}</td><td>${r['Name'] || ''}</td><td>${number}</td><td>${r['Location'] || ''}</td><td>${r['Address'] || ''}</td><td>${r['Power'] || ''}</td><td>${r['Remarks'] || ''}</td>`;
        tbody.appendChild(tr);
      });

      document.getElementById('userModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('userModal').style.display = 'none';
    }

    window.addEventListener('load', loadData);
  </script>
</body>
</html>
