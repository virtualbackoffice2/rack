<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <!-- ZOOM IN + ZOOM OUT ENABLED -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=5.0, user-scalable=yes">
  <title>Merotra Network Table</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- MOBILE-FRIENDLY TABLE SCROLL & ZOOM -->
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f4f6f8;
      overflow-x: hidden;
    }

    h2 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    #matrixHolder {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background: #fff;
    }

    table {
      min-width: 800px;
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      font-size: 0.9rem;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #f0f2f5;
      font-weight: 600;
      color: #2c3e50;
    }

    .olt-name {
      background-color: #3498db !important;
      color: white;
      font-weight: bold;
    }

    .separator {
      background-color: #e74c3c !important;
      color: white;
      font-weight: bold;
      font-size: 1rem;
    }

    .clickable {
      cursor: pointer;
      transition: background 0.2s;
    }

    .clickable:hover {
      background-color: #eaf4fc !important;
    }

    .onStatus {
      color: #27ae60;
      font-weight: bold;
    }

    .offStatus {
      color: #e74c3c;
      font-weight: bold;
    }

    .red {
      background-color: #ffebee !important;
    }

    .pink {
      background-color: #fce4ec !important;
    }

    .blink {
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Modal Styles */
    #userModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 10px;
      box-sizing: border-box;
    }

    #userModalContent {
      background: white;
      border-radius: 12px;
      width: 95%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .closeBtn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.8rem;
      cursor: pointer;
      color: #e74c3c;
      font-weight: bold;
    }

    #modalButtons {
      padding: 10px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    #modalButtons button {
      margin: 5px;
      padding: 10px 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    #modalButtons button:hover {
      background: #2980b9;
    }

    #screenshotContent {
      padding: 15px;
    }

    #modalTitle {
      margin: 0 0 5px;
      color: #2c3e50;
      font-size: 1.3rem;
    }

    #modalSubTitle {
      color: #7f8c8d;
      font-size: 0.95rem;
      margin-bottom: 10px;
    }

    #userDetails table {
      width: 100%;
      font-size: 0.85rem;
    }

    #userDetails th {
      background: #f0f2f5;
    }

    /* Toast */
    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #e74c3c;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.9rem;
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #toast.show {
      opacity: 1;
    }

    /* Loading Overlay */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 1.1rem;
      color: #2c3e50;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 5px solid #f0f2f5;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile Adjustments */
    @media (max-width: 768px) {
      h2 { font-size: 1.4rem; }
      table { font-size: 0.8rem; }
      th, td { padding: 6px; }
      #userModalContent { width: 98%; }
      #modalButtons button { font-size: 0.8rem; padding: 8px 12px; }
    }
  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p>Loading rack...</p>
  </div>

  <h2>Merotra Network Rack</h2>

  <div id="matrixHolder">
    <table id="matrixTable">
      <tr>
        <th></th>
        <th></th>
        <th>Pon1</th><th>Pon2</th><th>Pon3</th><th>Pon4</th>
        <th>Pon5</th><th>Pon6</th><th>Pon7</th><th>Pon8</th>
        <th>Total</th>
      </tr>

      <!-- Separator for Merotra window -->
      <tr class="separator">
        <th colspan="11">Merotra window Duda</th>
      </tr>

      <!-- O1I5 -->
      <tr>
        <th rowspan="4" class="olt-name">O1I5</th>
        <th>Users</th>
        <td id="pon1-O1I5" class="clickable">Loading...</td>
        <td id="pon2-O1I5" class="clickable">Loading...</td>
        <td id="pon3-O1I5" class="clickable">Loading...</td>
        <td id="pon4-O1I5" class="clickable">Loading...</td>
        <td id="pon5-O1I5" class="clickable">Loading...</td>
        <td id="pon6-O1I5" class="clickable">Loading...</td>
        <td id="pon7-O1I5" class="clickable">Loading...</td>
        <td id="pon8-O1I5" class="clickable">Loading...</td>
        <td id="oltTotal-O1I5" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Offline</th>
        <td id="off1-O1I5" class="clickable">Loading...</td>
        <td id="off2-O1I5" class="clickable">Loading...</td>
        <td id="off3-O1I5" class="clickable">Loading...</td>
        <td id="off4-O1I5" class="clickable">Loading...</td>
        <td id="off5-O1I5" class="clickable">Loading...</td>
        <td id="off6-O1I5" class="clickable">Loading...</td>
        <td id="off7-O1I5" class="clickable">Loading...</td>
        <td id="off8-O1I5" class="clickable">Loading...</td>
        <td id="oltOffTotal-O1I5" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Ticket</th>
        <td id="tick1-O1I5" class="clickable">Loading...</td>
        <td id="tick2-O1I5" class="clickable">Loading...</td>
        <td id="tick3-O1I5" class="clickable">Loading...</td>
        <td id="tick4-O1I5" class="clickable">Loading...</td>
        <td id="tick5-O1I5" class="clickable">Loading...</td>
        <td id="tick6-O1I5" class="clickable">Loading...</td>
        <td id="tick7-O1I5" class="clickable">Loading...</td>
        <td id="tick8-O1I5" class="clickable">Loading...</td>
        <td id="oltTickTotal-O1I5" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Line</th>
        <td id="stat1-O1I5">Loading...</td>
        <td id="stat2-O1I5">Loading...</td>
        <td id="stat3-O1I5">Loading...</td>
        <td id="stat4-O1I5">Loading...</td>
        <td id="stat5-O1I5">Loading...</td>
        <td id="stat6-O1I5">Loading...</td>
        <td id="stat7-O1I5">Loading...</td>
        <td id="stat8-O1I5">Loading...</td>
        <td></td>
      </tr>

      <!-- O2I6 -->
      <tr>
        <th rowspan="4" class="olt-name">O2I6</th>
        <th>Users</th>
        <td id="pon1-O2I6" class="clickable">Loading...</td>
        <td id="pon2-O2I6" class="clickable">Loading...</td>
        <td id="pon3-O2I6" class="clickable">Loading...</td>
        <td id="pon4-O2I6" class="clickable">Loading...</td>
        <td id="pon5-O2I6" class="clickable">Loading...</td>
        <td id="pon6-O2I6" class="clickable">Loading...</td>
        <td id="pon7-O2I6" class="clickable">Loading...</td>
        <td id="pon8-O2I6" class="clickable">Loading...</td>
        <td id="oltTotal-O2I6" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Offline</th>
        <td id="off1-O2I6" class="clickable">Loading...</td>
        <td id="off2-O2I6" class="clickable">Loading...</td>
        <td id="off3-O2I6" class="clickable">Loading...</td>
        <td id="off4-O2I6" class="clickable">Loading...</td>
        <td id="off5-O2I6" class="clickable">Loading...</td>
        <td id="off6-O2I6" class="clickable">Loading...</td>
        <td id="off7-O2I6" class="clickable">Loading...</td>
        <td id="off8-O2I6" class="clickable">Loading...</td>
        <td id="oltOffTotal-O2I6" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Ticket</th>
        <td id="tick1-O2I6" class="clickable">Loading...</td>
        <td id="tick2-O2I6" class="clickable">Loading...</td>
        <td id="tick3-O2I6" class="clickable">Loading...</td>
        <td id="tick4-O2I6" class="clickable">Loading...</td>
        <td id="tick5-O2I6" class="clickable">Loading...</td>
        <td id="tick6-O2I6" class="clickable">Loading...</td>
        <td id="tick7-O2I6" class="clickable">Loading...</td>
        <td id="tick8-O2I6" class="clickable">Loading...</td>
        <td id="oltTickTotal-O2I6" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Line</th>
        <td id="stat1-O2I6">Loading...</td>
        <td id="stat2-O2I6">Loading...</td>
        <td id="stat3-O2I6">Loading...</td>
        <td id="stat4-O2I6">Loading...</td>
        <td id="stat5-O2I6">Loading...</td>
        <td id="stat6-O2I6">Loading...</td>
        <td id="stat7-O2I6">Loading...</td>
        <td id="stat8-O2I6">Loading...</td>
        <td></td>
      </tr>

      <!-- O3I7 -->
      <tr>
        <th rowspan="4" class="olt-name">O3I7</th>
        <th>Users</th>
        <td id="pon1-O3I7" class="clickable">Loading...</td>
        <td id="pon2-O3I7" class="clickable">Loading...</td>
        <td id="pon3-O3I7" class="clickable">Loading...</td>
        <td id="pon4-O3I7" class="clickable">Loading...</td>
        <td colspan="4"></td>
        <td id="oltTotal-O3I7" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Offline</th>
        <td id="off1-O3I7" class="clickable">Loading...</td>
        <td id="off2-O3I7" class="clickable">Loading...</td>
        <td id="off3-O3I7" class="clickable">Loading...</td>
        <td id="off4-O3I7" class="clickable">Loading...</td>
        <td colspan="4"></td>
        <td id="oltOffTotal-O3I7" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Ticket</th>
        <td id="tick1-O3I7" class="clickable">Loading...</td>
        <td id="tick2-O3I7" class="clickable">Loading...</td>
        <td id="tick3-O3I7" class="clickable">Loading...</td>
        <td id="tick4-O3I7" class="clickable">Loading...</td>
        <td colspan="4"></td>
        <td id="oltTickTotal-O3I7" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Line</th>
        <td id="stat1-O3I7">Loading...</td>
        <td id="stat2-O3I7">Loading...</td>
        <td id="stat3-O3I7">Loading...</td>
        <td id="stat4-O3I7">Loading...</td>
        <td colspan="4"></td>
        <td></td>
      </tr>

      <!-- Separator for Sarosa Distance OLT -->
      <tr class="separator">
        <th colspan="11">Sarosa Distance OLT</th>
      </tr>

      <!-- O4I9 -->
      <tr>
        <th rowspan="4" class="olt-name">O4I9</th>
        <th>Users</th>
        <td id="pon1-O4I9" class="clickable">Loading...</td>
        <td id="pon2-O4I9" class="clickable">Loading...</td>
        <td id="pon3-O4I9" class="clickable">Loading...</td>
        <td id="pon4-O4I9" class="clickable">Loading...</td>
        <td colspan="4"></td>
        <td id="oltTotal-O4I9" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Offline</th>
        <td id="off1-O4I9" class="clickable">Loading...</td>
        <td id="off2-O4I9" class="clickable">Loading...</td>
        <td id="off3-O4I9" class="clickable">Loading...</td>
        <td id="off4-O4I9" class="clickable">Loading...</td>
        <td colspan="4"></td>
        <td id="oltOffTotal-O4I9" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Ticket</th>
        <td id="tick1-O4I9" class="clickable">Loading...</td>
        <td id="tick2-O4I9" class="clickable">Loading...</td>
        <td id="tick3-O4I9" class="clickable">Loading...</td>
        <td id="tick4-O4I9" class="clickable">Loading...</td>
        <td colspan="4"></td>
        <td id="oltTickTotal-O4I9" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Line</th>
        <td id="stat1-O4I9">Loading...</td>
        <td id="stat2-O4I9">Loading...</td>
        <td id="stat3-O4I9">Loading...</td>
        <td id="stat4-O4I9">Loading...</td>
        <td colspan="4"></td>
        <td></td>
      </tr>

      <!-- Separator for Budheshwar window -->
      <tr class="separator">
        <th colspan="11">Budheshwar Window (Includes Suny Data)</th>
      </tr>

      <!-- O5I2 -->
      <tr>
        <th rowspan="4" class="olt-name">O5I2</th>
        <th>Users</th>
        <td id="pon1-O5I2" class="clickable">Loading...</td>
        <td id="pon2-O5I2" class="clickable">Loading...</td>
        <td id="pon3-O5I2" class="clickable">Loading...</td>
        <td id="pon4-O5I2" class="clickable">Loading...</td>
        <td id="pon5-O5I2" class="clickable">Loading...</td>
        <td id="pon6-O5I2" class="clickable">Loading...</td>
        <td id="pon7-O5I2" class="clickable">Loading...</td>
        <td id="pon8-O5I2" class="clickable">Loading...</td>
        <td id="oltTotal-O5I2" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Offline</th>
        <td id="off1-O5I2" class="clickable">Loading...</td>
        <td id="off2-O5I2" class="clickable">Loading...</td>
        <td id="off3-O5I2" class="clickable">Loading...</td>
        <td id="off4-O5I2" class="clickable">Loading...</td>
        <td id="off5-O5I2" class="clickable">Loading...</td>
        <td id="off6-O5I2" class="clickable">Loading...</td>
        <td id="off7-O5I2" class="clickable">Loading...</td>
        <td id="off8-O5I2" class="clickable">Loading...</td>
        <td id="oltOffTotal-O5I2" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Ticket</th>
        <td id="tick1-O5I2" class="clickable">Loading...</td>
        <td id="tick2-O5I2" class="clickable">Loading...</td>
        <td id="tick3-O5I2" class="clickable">Loading...</td>
        <td id="tick4-O5I2" class="clickable">Loading...</td>
        <td id="tick5-O5I2" class="clickable">Loading...</td>
        <td id="tick6-O5I2" class="clickable">Loading...</td>
        <td id="tick7-O5I2" class="clickable">Loading...</td>
        <td id="tick8-O5I2" class="clickable">Loading...</td>
        <td id="oltTickTotal-O5I2" class="clickable">Loading...</td>
      </tr>
      <tr>
        <th>Line</th>
        <td id="stat1-O5I2">Loading...</td>
        <td id="stat2-O5I2">Loading...</td>
        <td id="stat3-O5I2">Loading...</td>
        <td id="stat4-O5I2">Loading...</td>
        <td id="stat5-O5I2">Loading...</td>
        <td id="stat6-O5I2">Loading...</td>
        <td id="stat7-O5I2">Loading...</td>
        <td id="stat8-O5I2">Loading...</td>
        <td></td>
      </tr>
    </table>
  </div>

  <!-- Modal -->
  <div id="userModal">
    <div id="userModalContent">
      <span class="closeBtn" onclick="closeModal()">Ã—</span>
      <div id="modalButtons"></div>
      <div id="screenshotContent">
        <h3 id="modalTitle">Users Details</h3>
        <div id="modalSubTitle"></div>
        <div id="userDetails"></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast">No user in list!!</div>

  <!-- JS Code (Same as before) -->
  <script>
    const WEB_APP_URLS = [
      'https://script.google.com/macros/s/AKfycbzliBfK4lJmojz4wSUZVcJBg1UDu47WlLvHA5GSAFk84EPd1w4cT62Dw5PqpsuemybXww/exec',
      'https://script.google.com/macros/s/AKfycbzP06rGtmvCWN4sMqtrluFcLeSM29vjmJ0fRO0r8rEc5mqRRuyUGTuvIK2qN1gZEvLoTg/exec'
    ];
    const TOKEN = 'abcd1234';
    const STATUS_LINK = 'https://vbo.co.in/ISP/Lucknow/Merotra/tag';
    let oltData = {};
    let dashboardA7 = null;

    async function loadData() {
      const olts = [
        { id: 'O1I5', pons: 8 },
        { id: 'O2I6', pons: 8 },
        { id: 'O3I7', pons: 4 },
        { id: 'O4I9', pons: 4 },
        { id: 'O5I2', pons: 8 }
      ];
      for (let oltObj of olts) {
        const olt = oltObj.id;
        const maxPon = oltObj.pons;
        for (let i = 1; i <= maxPon; i++) {
          const nmid = olt + 'P' + i;
          oltData[nmid] = { all: [], off: [], tick: [], drops: [] };
        }
      }
      try {
        const fetchPromises = WEB_APP_URLS.map((url, index) =>
          fetch(url + '?token=' + encodeURIComponent(TOKEN))
            .then(response => {
              if (!response.ok) throw new Error(`Network error ${index + 1}`);
              return response.json();
            })
            .then(data => {
              if (data.error) throw new Error(data.error);
              return { rows: data.rows || [], dashboardA7: data.dashboardA7, sourceIndex: index };
            })
            .catch(err => {
              console.error(`Fetch error ${index + 1}:`, err);
              return { rows: [], dashboardA7: null, sourceIndex: index };
            })
        );
        const results = await Promise.all(fetchPromises);
        let allRows = [];
        let dashboardA7Values = [];
        results.forEach(r => {
          allRows.push(...r.rows);
          if (r.dashboardA7 !== undefined && r.dashboardA7 !== null) {
            dashboardA7Values.push(Number(r.dashboardA7));
          }
        });
        dashboardA7 = dashboardA7Values.length > 0 ? Math.min(...dashboardA7Values) : null;

        for (let oltObj of olts) {
          const olt = oltObj.id;
          const maxPon = oltObj.pons;
          let total = 0, offTotal = 0, tickTotal = 0;
          for (let i = 1; i <= maxPon; i++) {
            const nmid = olt + 'P' + i;
            let filtered = [];
            const source1Filtered = results[0].rows.filter(r => r['NMID'] === nmid && r['Users']);
            filtered.push(...source1Filtered);
            if (olt === 'O5I2') {
              const source2Filtered = results[1].rows.filter(r => {
                const fullId = r['ID'] || '';
                const extractedNmid = fullId.substring(0, 7).toUpperCase();
                return extractedNmid === nmid && r['Users'];
              });
              filtered.push(...source2Filtered);
            }
            const allRowsFiltered = filtered;
            const offRows = filtered.filter(r => r['Downs'] && r['Downs'] !== '');
            const tickRows = filtered.filter(r => r['Ticket'] && r['Ticket'] !== '');
            const dropTimes = filtered.map(r => r['Drops']).filter(v => v && v !== '');

            oltData[nmid] = { all: allRowsFiltered, off: offRows, tick: tickRows, drops: dropTimes };

            document.getElementById(`pon${i}-${olt}`).textContent = allRowsFiltered.length;
            document.getElementById(`off${i}-${olt}`).textContent = offRows.length;
            document.getElementById(`tick${i}-${olt}`).textContent = tickRows.length;

            let statusCell = document.getElementById(`stat${i}-${olt}`);
            let dropCount = dropTimes.length;
            if (dashboardA7 !== null && !isNaN(dashboardA7)) {
              let isOn = dropCount < dashboardA7;
              statusCell.innerHTML = `<a href="${STATUS_LINK}" target="_self">${isOn ? 'Green Circle' : 'Red Circle'}</a>`;
              statusCell.className = isOn ? "onStatus clickable" : "offStatus clickable";
            } else {
              statusCell.textContent = "-";
              statusCell.className = "";
            }

            total += allRowsFiltered.length;
            offTotal += offRows.length;
            tickTotal += tickRows.length;
          }
          document.getElementById(`oltTotal-${olt}`).textContent = total;
          document.getElementById(`oltOffTotal-${olt}`).textContent = offTotal;
          document.getElementById(`oltTickTotal-${olt}`).textContent = tickTotal;
        }
        attachEventListeners();
        document.getElementById('loadingOverlay').style.display = 'none';
      } catch (err) {
        console.error('Fetch error:', err);
        for (let oltObj of olts) {
          const olt = oltObj.id;
          const maxPon = oltObj.pons;
          for (let i = 1; i <= maxPon; i++) {
            document.getElementById(`pon${i}-${olt}`).textContent = 'Error';
            document.getElementById(`off${i}-${olt}`).textContent = 'Error';
            document.getElementById(`tick${i}-${olt}`).textContent = 'Error';
            document.getElementById(`stat${i}-${olt}`).textContent = '-';
          }
          document.getElementById(`oltTotal-${olt}`).textContent = 'Error';
          document.getElementById(`oltOffTotal-${olt}`).textContent = 'Error';
          document.getElementById(`oltTickTotal-${olt}`).textContent = 'Error';
        }
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    }

    function showToast() {
      const toast = document.getElementById('toast');
      toast.className = 'show';
      setTimeout(() => { toast.className = ''; }, 3000);
    }

    function attachEventListeners() {
      const olts = [
        { id: 'O1I5', pons: 8 },
        { id: 'O2I6', pons: 8 },
        { id: 'O3I7', pons: 4 },
        { id: 'O4I9', pons: 4 },
        { id: 'O5I2', pons: 8 }
      ];
      for (let oltObj of olts) {
        const olt = oltObj.id;
        const maxPon = oltObj.pons;
        for (let i = 1; i <= maxPon; i++) {
          ['pon', 'off', 'tick'].forEach(type => {
            const el = document.getElementById(`${type}${i}-${olt}`);
            if (el) {
              el.addEventListener('click', () => {
                if (el.textContent === '0') {
                  showToast();
                } else {
                  showUsers(type === 'pon' ? 'all' : type === 'off' ? 'off' : 'tick', `${olt}P${i}`, olt, `P${i}`);
                }
              });
            }
          });
        }
        ['oltTotal', 'oltOffTotal', 'oltTickTotal'].forEach(type => {
          const el = document.getElementById(`${type}-${olt}`);
          if (el) {
            el.addEventListener('click', () => {
              if (el.textContent === '0') {
                showToast();
              } else {
                showOltUsers(type === 'oltTotal' ? 'all' : type === 'oltOffTotal' ? 'off' : 'tick', olt, maxPon);
              }
            });
          }
        });
      }
    }

    function showUsers(type, nmid, olt, pon) {
      let title = type === 'all' ? "Users Details" : type === 'off' ? "Offline Users Details" : "Ticket Users Details";
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalSubTitle').textContent = `OLT: ${olt} PON: ${pon}`;
      const currentUsers = (oltData[nmid] && oltData[nmid][type === 'all' ? 'all' : type]) || [];
      if (currentUsers.length === 0) { showToast(); return; }

      const userDetails = document.getElementById('userDetails');
      userDetails.innerHTML = '<table><thead><tr><th>Sn</th><th>Name</th><th>Number</th><th>Location</th><th>Address</th><th>Power</th><th>Remarks</th></tr></thead><tbody></tbody></table>';
      const tbody = userDetails.querySelector('tbody');
      currentUsers.forEach((r, index) => {
        const tr = document.createElement('tr');
        if (r['Ticket']) tr.classList.add('red', 'blink');
        else if (r['Downs']) tr.classList.add('pink', 'blink');
        const number = (r['Last called no'] || '').trim() || r['Number'] || '';
        tr.innerHTML = `<td>${index + 1}</td><td>${r['Name'] || ''}</td><td>${number}</td><td>${r['Location'] || ''}</td><td>${r['Address'] || ''}</td><td>${r['Power'] || ''}</td><td>${r['Remarks'] || ''}</td>`;
        tbody.appendChild(tr);
      });

      const modalButtons = document.getElementById('modalButtons');
      modalButtons without HTML = '';
      const downloadBtn = document.createElement('button');
      downloadBtn.textContent = 'Download CSV';
      downloadBtn.onclick = () => {
        let csv = 'Sn,Name,Number,Location,Address,Power,Remarks\n';
        currentUsers.forEach((r, i) => {
          const number = (r['Last called no'] || '').trim() || r['Number'] || '';
          csv += [i+1, r['Name']||'', number, r['Location']||'', r['Address']||'', r['Power']||'', r['Remarks']||'']
            .map(v => `"${v.replace(/"/g, '""')}"`).join(',') + '\n';
        });
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'users.csv'; a.click();
        URL.revokeObjectURL(url);
      };
      modalButtons.appendChild(downloadBtn);

      const shareBtn = document.createElement('button');
      shareBtn.textContent = 'Share Screenshot on WhatsApp';
      shareBtn.onclick = () => {
        html2canvas(document.getElementById('screenshotContent'), {scale: 2}).then(canvas => {
          canvas.toBlob(blob => {
            const file = new File([blob], 'screenshot.png', {type: 'image/png'});
            if (navigator.canShare?.({files: [file]})) {
              navigator.share({files: [file]}).catch(() => fallbackDownload(blob));
            } else fallbackDownload(blob);
            function fallbackDownload(blob) {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url; a.download = 'screenshot.png'; a.click();
              URL.revokeObjectURL(url);
            }
          });
        });
      };
      modalButtons.appendChild(shareBtn);

      document.getElementById('userModal').style.display = 'flex';
    }

    function showOltUsers(type, olt, maxPon) {
      let title = type === 'all' ? "All Users Details" : type === 'off' ? "All Offline Users Details" : "All Ticket Users Details";
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalSubTitle').textContent = `OLT: ${olt}`;
      let currentUsers = [];
      for (let i = 1; i <= maxPon; i++) {
        const nmid = olt + 'P' + i;
        if (oltData[nmid]?.[type === 'all' ? 'all' : type]) {
          currentUsers.push(...oltData[nmid][type === 'all' ? 'all' : type]);
        }
      }
      if (currentUsers.length === 0) { showToast(); return; }
      showUsers(type === 'all' ? 'all' : type, null, olt, 'ALL'); // Reuse showUsers logic
    }

    function closeModal() {
      document.getElementById('userModal').style.display = 'none';
    }

    window.addEventListener('load', () => {
      loadData();
      setInterval(loadData, 30000);
    });
  </script>
</body>
</html>
